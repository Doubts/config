angular.module("Editor",[]).service("DiigoEditor",[function(){var d=null,f={};this.style={};this.bg_info={};this.instance=null;this.setImage=function(c,b){null!==d&&(f.image=c,d.page.doodle_array.length=0,d.setBgImage(c,b),d.style_callback("scale",b?"fit":1))};this.createEditor=function(c,b){f.out_container=c.out_container[0];f.container=c.container[0];f.doodle_canvas=c.doodle_canvas[0];f.layer_canvas=c.layer_canvas[0];f.textarea=c.textarea[0];f.textarea_out=c.textarea_out[0];f.$list_dialog=c.list_dialog;
f.image=new Image;d=new Diigo.Doodle._Drawer(f,b);this.style=d.style;this.bg_info=d.bg_info;this.instance=window.diigo_editor=d};this.switchMode=function(c){d.switchMode(c)};this.getImageDataURL=function(){return d.getImageDataURL()};this.getImageDataBlob=function(){return d.getImageDataBlob()};this.cutImage=function(){d.cutImage()};this.setCropSize=function(c,b){d.setCropSize(c,b)};this.finishCutImage=function(c){d.finishCutImage(c)};this.setPenWidth=function(c){d.setPenWidth(c)};this.setPenOpacity=
function(c){d.setPenOpacity(c)};this.setPenColor=function(c){d.setPenColor(c)};this.setPenType=function(c,b){d.setPenType(c,b)};this.setArrowType=function(c){d.setArrowType(c)};this.setScale=function(c){d.setScale(c)};this.setFitScale=function(){d.setFitScale()};this.setFontName=function(c){d.setFontName(c)};this.setFontSize=function(c){d.setFontSize(c)};this.setSvgImage=function(c){d.setSvgImage(c)};this.insertSvgImage=function(c){d.insertSvgImage(c)};this.setImageSize=function(c,b){d.setImageSize(c,
b)};this.undo=function(){d.undo()};this.redo=function(){d.redo()};this.clear=function(){d.clear()};this.resetList=function(){d.resetList()};this.reset_list=function(){d.reset_list()};this.deleteSelected=function(){d.deleteSelected()};this.getScale=function(){return d.zoom_scale};this.isTextActived=function(){return null!==d.cur_textbox||null!==d.$list_input.data("doodle")};this.isChanged=function(){return d.isChanged()};this.adjustTop=function(){window.setTimeout(function(){d._on_resize()},0)}}]);Diigo={Text:{},Doodle:{},UndoRedo:{},Data:{},FPT:{},$:function(d){return document.getElementById(d)}};
(function(d){var f={parsePathData:function(a){if(!a)return[];var b,c="mMlLvVhHzZcCqQtTsSaA".split("");b=a.replace(RegExp(" ","g"),",");for(a=0;a<c.length;a++)b=b.replace(RegExp(c[a],"g"),"|"+c[a]);c=b.split("|");b=[];var g=0,d=0;for(a=1;a<c.length;a++){var k=c[a],f=k.charAt(0),k=k.slice(1),k=k.replace(RegExp(",-","g"),"-"),k=k.replace(RegExp("-","g"),",-"),k=k.replace(RegExp("e,-","g"),"e-"),k=k.split(",");0<k.length&&""===k[0]&&k.shift();for(var l=0;l<k.length;l++)k[l]=parseFloat(k[l]);for(;0<k.length&&
!isNaN(k[0]);){var l=null,p=[],m,q,t,y,u,w;switch(f){case "l":g+=k.shift();d+=k.shift();l="L";p.push(g,d);break;case "L":g=k.shift();d=k.shift();p.push(g,d);break;case "m":f=k.shift();m=k.shift();g+=f;d+=m;l="M";if(2<b.length&&"z"===b[b.length-1].command)for(q=b.length-2;0<=q;q--)if("M"===b[q].command){g=b[q].points[0]+f;d=b[q].points[1]+m;break}p.push(g,d);f="l";break;case "M":g=k.shift();d=k.shift();l="M";p.push(g,d);f="L";break;case "h":g+=k.shift();l="L";p.push(g,d);break;case "H":g=k.shift();
l="L";p.push(g,d);break;case "v":d+=k.shift();l="L";p.push(g,d);break;case "V":d=k.shift();l="L";p.push(g,d);break;case "C":p.push(k.shift(),k.shift(),k.shift(),k.shift());g=k.shift();d=k.shift();p.push(g,d);break;case "c":p.push(g+k.shift(),d+k.shift(),g+k.shift(),d+k.shift());g+=k.shift();d+=k.shift();l="C";p.push(g,d);break;case "S":m=g;q=d;l=b[b.length-1];"C"===l.command&&(m=g+(g-l.points[2]),q=d+(d-l.points[3]));p.push(m,q,k.shift(),k.shift());g=k.shift();d=k.shift();l="C";p.push(g,d);break;
case "s":m=g;q=d;l=b[b.length-1];"C"===l.command&&(m=g+(g-l.points[2]),q=d+(d-l.points[3]));p.push(m,q,g+k.shift(),d+k.shift());g+=k.shift();d+=k.shift();l="C";p.push(g,d);break;case "Q":p.push(k.shift(),k.shift());g=k.shift();d=k.shift();p.push(g,d);break;case "q":p.push(g+k.shift(),d+k.shift());g+=k.shift();d+=k.shift();l="Q";p.push(g,d);break;case "T":m=g;q=d;l=b[b.length-1];"Q"===l.command&&(m=g+(g-l.points[0]),q=d+(d-l.points[1]));g=k.shift();d=k.shift();l="Q";p.push(m,q,g,d);break;case "t":m=
g;q=d;l=b[b.length-1];"Q"===l.command&&(m=g+(g-l.points[0]),q=d+(d-l.points[1]));g+=k.shift();d+=k.shift();l="Q";p.push(m,q,g,d);break;case "A":p=k.shift();m=k.shift();q=k.shift();t=k.shift();y=k.shift();u=g;w=d;g=k.shift();d=k.shift();l="A";p=this.convertEndpointToCenterParameterization(u,w,g,d,t,y,p,m,q);break;case "a":p=k.shift(),m=k.shift(),q=k.shift(),t=k.shift(),y=k.shift(),u=g,w=d,g+=k.shift(),d+=k.shift(),l="A",p=this.convertEndpointToCenterParameterization(u,w,g,d,t,y,p,m,q)}b.push({command:l||
f,points:p})}"z"!==f&&"Z"!==f||b.push({command:"z",points:[]})}return b},convertEndpointToCenterParameterization:function(a,b,c,d,n,k,f,l,p){p*=Math.PI/180;var m=Math.cos(p)*(a-c)/2+Math.sin(p)*(b-d)/2,q=-1*Math.sin(p)*(a-c)/2+Math.cos(p)*(b-d)/2,t=m*m/(f*f)+q*q/(l*l);1<t&&(f*=Math.sqrt(t),l*=Math.sqrt(t));t=Math.sqrt((f*f*l*l-f*f*q*q-l*l*m*m)/(f*f*q*q+l*l*m*m));n===k&&(t*=-1);isNaN(t)&&(t=0);n=t*f*q/l;t=t*-l*m/f;a=(a+c)/2+Math.cos(p)*n-Math.sin(p)*t;b=(b+d)/2+Math.sin(p)*n+Math.cos(p)*t;var y=function(a,
s){return(a[0]*s[0]+a[1]*s[1])/(Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.sqrt(s[0]*s[0]+s[1]*s[1]))},u=function(a,s){return(a[0]*s[1]<a[1]*s[0]?-1:1)*Math.acos(y(a,s))};d=u([1,0],[(m-n)/f,(q-t)/l]);c=[(m-n)/f,(q-t)/l];m=[(-1*m-n)/f,(-1*q-t)/l];q=u(c,m);-1>=y(c,m)&&(q=Math.PI);1<=y(c,m)&&(q=0);0===k&&0<q&&(q-=2*Math.PI);1===k&&0>q&&(q+=2*Math.PI);return[a,b,f,l,d,q,p,k]}},c=navigator.userAgent.toLowerCase(),b;(b=c.match(/msie ([\d.]+)/))?d.ie=b[1]:(b=c.match(/firefox\/([\d.]+)/))?d.firefox=b[1]:(b=c.match(/chrome\/([\d.]+)/))?
d.chrome=b[1]:(b=c.match(/opera.([\d.]+)/))?d.opera=b[1]:(b=c.match(/version\/([\d.]+).*safari/))?d.safari=b[1]:0;(b=c.match(/trident\/.*rv:([\d.]+)/))?d.ie=b[1]:0;(b=c.match(/mac os x (\d+)[\._](\d+)/))?d.macOS=b[1]+"."+b[2]:d.winOS=!0;(b=c.match(/ipad;.+version\/(\d+\.\d+)/))?d.iPad=b[1]:0;(b=c.match(/android/))?d.android=!0:0;d.touchable=!1;c=window.navigator.msPointerEnabled;d.touchEventType={start:c?"10.0"===d.ie?"MSPointerDown":"pointerdown":"mousedown",move:c?"10.0"===d.ie?"MSPointerMove":
"pointermove":"mousemove",end:c?"10.0"===d.ie?"MSPointerUp":"pointerup":"mouseup"};d.extend=function(a,b){for(var c in b)if(null==a[c])a[c]=b[c];else throw console.trace(),d.log(c),"extend error!";};var a=new Image;a.src="images/cross.png";d.extend(d,{parseSVGPath:function(a){return f.parsePathData(a)},__debug__:!0,log:function(a,b,c){this.__debug__&&jQuery.log.apply(this,arguments)},__IMAGE_CANVAS__:null,__IMAGE_CTX__:null,_getHelperImageCanvas:function(){null===this.__IMAGE_CANVAS__&&(this.__IMAGE_CANVAS__=
document.createElement("canvas"),this.__IMAGE_CTX__=this.__IMAGE_CANVAS__.getContext("2d"));return this.__IMAGE_CANVAS__},getListCursor:function(s){d._getHelperImageCanvas();var b=this.__IMAGE_CANVAS__,c=this.__IMAGE_CTX__;b.width=b.height=32;c.drawImage(a,0,18);c.font="bold 14px Arial";c.fillStyle="#39abed";c.strokeStyle="white";c.textAlign="center";c.textBaseline="middle";c.save();c.lineWidth=2;c.shadowBlur=4;c.shadowColor="rgba(0,0,0,0.3)";c.shadowOffsetX=1;c.shadowOffsetY=2;c.strokeText(s,20,
10);c.restore();c.fillText(s,20,10);return'url("'+b.toDataURL()+'") 6 25, auto'},image2url:function(a){d._getHelperImageCanvas();var b=this.__IMAGE_CANVAS__,c=this.__IMAGE_CTX__;b.width=a.naturalWidth;b.height=a.naturalHeight;c.drawImage(a,0,0);a=b.toDataURL();b.width=b.height=0;return a},canvas2image:function(a,b,c,g,f,k){d._getHelperImageCanvas();var r=a;"number"===typeof b?(this.__IMAGE_CANVAS__.width=g,this.__IMAGE_CANVAS__.height=f,this.__IMAGE_CTX__.drawImage(a,b,c,g,f,0,0,g,f),r=this.__IMAGE_CANVAS__):
"function"===typeof b&&(k=b);a=new Image;"function"===typeof k&&(a.onload=function(){k()});a.src=r.toDataURL();return a},image2scale:function(a,b,c){var g=d._getHelperImageCanvas(),f=this.__IMAGE_CTX__,k=Math.floor(a.width*b);b=Math.floor(a.height*b);g.width=k;g.height=b;f.drawImage(a,0,0,k,b);a=new Image;"function"===typeof c&&(a.onload=c);a.src=g.toDataURL();return a},genPoints:function(a){for(var b=[],c=0;c<a;c++)b.push({x:0,y:0});return b},_getEventPoint:function(a){var b=0,c=0;if("undefined"!==
typeof a.pageX)b=a.pageX,c=a.pageY;else if("undefined"!==typeof a.clientX)b=a.clientX,c=a.clientY;else throw"no x,y in event(_getEventPoint)";return{x:b,y:c}},getDomPosition:function(a){for(var b=0,c=0;null!=a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{left:b,top:c}},addEvent:function(a,b,c){"string"===typeof a&&(a=d(a));window.addEventListener?a.addEventListener(b,c):a.attachEvent("on"+b,c)},delEvent:function(a,b,c){"string"===typeof a&&(a=d(a));window.removeEventListener?a.removeEventListener(b,
c):a.detachEvent("on"+b,c)},addGesture:function(a,b,c,g,f,k){"string"===typeof a&&(a=document.getElementById(a));"function"!==typeof k&&(k=function(){});var r=!1,l=!1,p=0,m=0,q=0,t=1,y,u=function(a,b,s){var v=0;if(!l&&!r)if(y=a/p,0.97>y|1.03<y)r=!0;else if(8<Math.abs(b)||8<Math.abs(s))l=!0;r?(y=a/p,0.88>y|1.12<y&&(g(a),v=1)):l&&(10<Math.abs(b)||10<Math.abs(s))&&(f(b,s),v=2);return v},w=function(a){l=r=!1;q=m=0;d.stopEvent(a)},z=null,A=null,K=function(){z=null;b(A)};if(d.ie){var J=new MSGesture,C=
[];J.target=a;d.addEvent(a,"MSGestureStart",function(a){p=t=a.scale;m=a.translationX;q=a.translationY;c();d.stopEvent(a)});d.addEvent(a,"MSGestureChange",function(a){m+=a.translationX;q+=a.translationY;t*=a.scale;var b=u(t,m,q);1===b?p=t:2===b&&(q=m=0);d.stopEvent(a)});d.addEvent(a,"MSGestureEnd",w);d.addEvent(a,d.touchEventType.start,function(a){var b=C.indexOf(a.pointerId);if(!(0<=b))if(0===C.length)C.push(a.pointerId),A=a,z=window.setTimeout(K,80);else if(1===C.length)for(null!==z&&(window.clearTimeout(z),
z=null),C.push(a.pointerId),b=0;b<C.length;b++)J.addPointer(C[b])});d.addEvent(a,d.touchEventType.end,function(a){1===C.length&&(null!==z&&(window.clearTimeout(z),z=null,b(A)),k(a));C.length=0})}else{var E=!1;d.addEvent(a,d.touchEventType.start,function(a){1===a.touches.length&&(E=!1,b(a))});d.addEvent(a,"gesturestart",function(a){E=!0;p=a.scale;m=a.pageX;q=a.pageY;c();d.stopEvent(a)});d.addEvent(a,"gesturechange",function(a){var b=u(a.scale,a.pageX-m,a.pageY-q);1===b?p=a.scale:2===b&&(m=a.pageX,
q=a.pageY);d.stopEvent(a)});d.addEvent(a,"gestureend",w);d.addEvent(a,d.touchEventType.end,function(a){!1===E&&k(a)})}},addMouseEvent:function(a,b,c){var g={};if(d.touchable&&0<=["mousedown","mousemove","mouseup"].indexOf(b)){b="mousedown"===b?d.touchEventType.start:"mousemove"===b?d.touchEventType.move:d.touchEventType.end;var f=function(a){a.touches&&1<a.touches.length||a.changedTouches&&1<a.changedTouches.length||c.apply(this,arguments)};d.addEvent(a,b,f);g[b]=f}else d.addEvent(a,b,c),g[b]=c;return g},
delMouseEvent:function(a,b){for(var c in b)d.delEvent(a,c,b[c])},createDelegate:function(a,b){return function(){b.apply(a,arguments)}},stopEvent:function(a){null!=a&&(a.preventDefault?a.preventDefault():a.returnValue=!1,a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,a.preventManipulation&&a.preventManipulation())},addWheelEvent:function(a,b){"string"===typeof a&&(a=d(a));window.addEventListener?d.firefox?a.addEventListener("DOMMouseScroll",b):a.addEventListener("mousewheel",b):a.attachEvent("onmousewheel",
b)},inherit:function(a,b){if("undefined"===typeof a||"undefined"===typeof b)throw console.trace(),"inherit error!";for(var c in b.prototype)"undefined"===typeof a.prototype[c]&&(a.prototype[c]=b.prototype[c]);a.__base_objects__=[];a.__base_objects__.push(b);if("undefined"!==typeof b.__base_objects__)for(c=0;c<b.__base_objects__.length;c++)a.__base_objects__.push(b.__base_objects__[c]);a.prototype.base=function(b){var c=null,c=void 0;"undefined"===typeof this.__inherit_base_deep__?this.__inherit_base_deep__=
0:this.__inherit_base_deep__++;c=a.__base_objects__[this.__inherit_base_deep__];c="undefined"===typeof b||null==b?c.call(this):!0===b instanceof Array?c.apply(this,b):c.apply(this,[].slice.call(arguments));this.__inherit_base_deep__--;return c};a.prototype.callBase=function(b,c){var v=null,v=void 0;"undefined"===typeof this.__inherit_deep__?this.__inherit_deep__=0:this.__inherit_deep__++;v=a.__base_objects__[this.__inherit_deep__];v=v.prototype[b];if("function"===typeof v)v="undefined"===typeof c||
null===c?v.call(this):!0===c instanceof Array?v.apply(this,c):v.apply(this,[].slice.call(arguments,1));else throw"There is no method:"+b+" in baseClass";this.__inherit_deep__--;return v}},__FONT_INFO_TABLE__:{},getFontInfo:function(a){var b=this.__FONT_INFO_TABLE__[a];null==b&&(b=this.__FONT_INFO_TABLE__[a]=this._calcFontInfo(a));return b},_calcFontInfo:function(a){var b=document.createElement("div"),c=document.createElement("span"),d=document.createElement("span");b.style.margin="0px";b.style.padding=
"0px";b.style.position="relative";b.style.left="0px";b.style.top="0px";b.style.overflow="hidden";b.style.whiteSpace="nowrap";b.style.visibility="hidden";c.style.font=a;c.style.margin="0px";c.style.padding="0px";c.style.verticalAlign="baseline";c.style.whiteSpace="nowrap";d.style.font=a.replace(/\d+px/,"0px");d.style.margin="0px";d.style.padding="0px";d.style.verticalAlign="baseline";c.style.whiteSpace="nowrap";c.innerHTML="@\u767d\u7f8a\u5ea7\u5c0f\u845b 04-02.I Love Diigo.\u5357\u4eac\u5927\u5b66";
d.innerHTML="@\u767d\u7f8a\u5ea7\u5c0f\u845b 04-02.I Love Diigo.\u5357\u4eac\u5927\u5b66";b.appendChild(d);b.appendChild(c);document.body.appendChild(b);a=b.offsetHeight;c=c.offsetHeight+c.offsetTop-d.offsetTop;document.body.removeChild(b);return{height:a,baseline:d.offsetTop,baseline_offset:c}},getMiddlePoint:function(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2}},drawBesier:function(a,b){var c=b.length;if(0!==c&&1!==c){a.beginPath();var g=null,f=b[0];a.moveTo(f.x,f.y);for(var k=0;k<c-1;k++)g=d.getMiddlePoint(b[k],
b[k+1]),a.quadraticCurveTo(f.x,f.y,g.x,g.y),f=b[k+1];g=b[c-1];a.quadraticCurveTo(f.x,f.y,g.x,g.y);a.stroke();a.closePath()}},drawLine:function(a,b,c,d,f){a.beginPath();a.moveTo(b,c);a.lineTo(d,f);a.stroke();a.closePath()},drawLine_w:function(a,b,c,g,f){d.drawLine(a,b,c,b+g,c+f)},drawEllipse:function(a,b,c,d,f,k){a.beginPath();a.ellipse(b,c,d,f,0,0,2*Math.PI,0);a.closePath();null!==k&&(a.fillStyle=k,a.fill());a.stroke()},calcArrow:function(a,b,c,g,f){function k(a,b,s,c,v){var h=[0,0],d=a*Math.cos(s)-
b*Math.sin(s);a=a*Math.sin(s)+b*Math.cos(s);c&&(c=Math.sqrt(d*d+a*a),h[0]=d/c*v,h[1]=a/c*v);return h}var r=d.getPTPRange_xy(a,b,c,g),l=0.42*f,p=Math.atan(l/f),m=Math.sqrt(l*l+f*f),l=k(c-a,g-b,p,!0,m),q=k(c-a,g-b,-p,!0,m),p=Math.floor(c-l[0]),l=Math.floor(g-l[1]),m=Math.floor(c-q[0]),q=Math.floor(g-q[1]);f/=r;a=Math.floor(c-(c-a)*f);y5=Math.floor(g-(g-b)*f);return{ax:p,ay:l,bx:m,by:q,cx:a,cy:y5,dx:c,dy:g}},drawArrow:function(a,b,c,g,f){b=d.calcArrow(b,c,g,f);d.drawLine(a,g,f,b.ax,b.ay);d.drawLine(a,
g,f,b.bx,b.by)},clearContext:function(a){a.clearRect(a.canvas.width,a.canvas.height)},copyArray:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},setArray:function(a,b){for(var c=0;c<a.length;c++)a[c]=b[c]},copyPoints:function(a){var b=[];if(0===a.length)return b;for(var c="undefined"!==typeof a[0].p,d=0;d<a.length;d++){var f={x:a[d].x,y:a[d].y};c&&(f.p=a[d].p);b.push(f)}return b},setPoints:function(a,b){if(0!==a.length&&a.length===b.length)for(var c=0;c<a.length;c++)a[c].x=b[c].x,
a[c].y=b[c].y},getPTPRange:function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))},getPTPRange_xy:function(a,b,c,d){return Math.sqrt(Math.pow(a-c,2)+Math.pow(b-d,2))},color2int:function(a){return a[0]<<16|a[1]<<8|a[2]},int2color:function(a){var b=(a&16711680).toString(16),c=(a&65280).toString(16);a=(a&255).toString(16);return"#"+(1===b.length?"0":"")+b+(1===c.length?"0":"")+c+(1===a.length?"0":"")+a},rgba2str:function(a,b,c,d){return"undefined"!==typeof d?"rgba("+a+","+b+","+c+","+
d+")":"#"+(10>a?"0":"")+a.toString(16).toUpperCase()+(10>b?"0":"")+b.toString(16).toUpperCase()+(10>c?"0":"")+c.toString(16).toUpperCase()},str2rgba:function(a){var b=0,c=0,d=0,f=1,k;/^#[0-9a-f]{3}$/i.test(a)?(b=parseInt(a.substr(1,1)+a.substr(1,1),16),c=parseInt(a.substr(2,1)+a.substr(2,1),16),d=parseInt(a.substr(3,1)+a.substr(3,1),16),f=1):/^#[0-9a-f]{6}$/i.test(a)?(b=parseInt(a.substr(1,2),16),c=parseInt(a.substr(3,2),16),d=parseInt(a.substr(5,2),16),f=1):null!=(k=a.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i))&&
(b=parseInt(k[1]),c=parseInt(k[2]),d=parseInt(k[3]),f=1);null!=(k=a.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d(\.\d+)?)\s*\)$/i))&&(b=parseInt(k[1]),c=parseInt(k[2]),d=parseInt(k[3]),f=parseFloat(k[4]));return{r:b,g:c,b:d,a:f}},is_color_blank:function(a){return"#000000"===a||"#000"===a||"blank"===a||/^rgba\(\s*0\s*,\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(a)||/^rgb\(\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(a)},setLineDash:function(a,b){"undefined"!==typeof a.setLineDash?a.setLineDash(b):"undefined"!==
typeof a.mozDash&&(a.mozDash=b)},getCanvasBlob:function(a){a=a.toDataURL("image/png");a=atob(a.substring(22));for(var b=new Uint8Array(a.length),c=0,d=a.length;c<d;++c)b[c]=a.charCodeAt(c);return new Blob([b.buffer],{type:"image/png"})},dataUrl2Blob:function(a){a=atob(a.substring(22));for(var b=new Uint8Array(a.length),c=0,d=a.length;c<d;++c)b[c]=a.charCodeAt(c);return new Blob([b.buffer],{type:"image/png"})}})})(Diigo.$);
(function(d){d.fn.extend({addMouseEvent:function(d,c,b){var a="function"===typeof c?c:"function"===typeof b?b:function(){},s=function(b){e=b.originalEvent;e.touches&&1<e.touches.length||e.changedTouches&&1<e.changedTouches.length||a.apply(this,arguments)},v=function(b){a.apply(this,arguments)},h="mousedown"===d?Diigo.$.touchEventType.start:"mousemove"===d?Diigo.$.touchEventType.move:Diigo.$.touchEventType.end;if(Diigo.$.touchable&&0<=["mousedown","mousemove","mouseup"].indexOf(d))if("function"===
typeof c)this.on(h,s);else this.on(h,c,s),this.on(d,c,v);else if("function"===typeof c)this.on(d,c);else this.on(d,c,b);return this},addMouseDownEvent:function(d,c){return this.addMouseEvent("mousedown",d,c)},addMouseMoveEvent:function(d,c){return this.addMouseEvent("mousemove",d,c)},addMouseUpEvent:function(d,c){return this.addMouseEvent("mouseup",d,c)},addMouseTagEvent:function(d,c){var b=!0,a=Diigo.$.touchEventType.start,s=Diigo.$.touchEventType.end;"function"===typeof d&&(c=d,b=!1);var v=0,h=
0,g=function(a){a=a.originalEvent||a;a.touches&&0<a.touches.length?(v=a.touches[0].pageX,h=a.touches[0].pageY):(v=a.pageX,h=a.pageY)},n=function(a){a=a.originalEvent||a;var b,s;a.changedTouches&&0<a.changedTouches.length?(b=a.changedTouches[0].pageX,s=a.changedTouches[0].pageY):(b=a.pageX,s=a.pageY);Math.sqrt(20>Math.pow(v-b,2)+Math.pow(h-s,2))&&c.apply(this,arguments)};if(Diigo.$.touchable)b?(this.on(a,d,g),this.on(s,d,n)):(this.on(a,g),this.on(s,n));else if(b)this.on("mousedown",d,c);else this.on("mousedown",
c);return this}});d.stopEvent=function(d){"undefined"!==typeof d&&(d.preventDefault(),d.stopPropagation())}})(jQuery);(function(d,f,c,b){f._Drawer=function(a,b){this.parent=a;this.container=a.container;this.out_container=a.out_container;this.edit_canvas=a.layer_canvas;this.doodle_canvas=a.doodle_canvas;this.textarea=a.textarea;this.textarea_out=a.textarea_out;this.$list_dialog=a.$list_dialog;this.$list_input=this.$list_dialog.find("input");this.choose_canvas=document.createElement("canvas");this.temp_canvas=document.createElement("canvas");this.image_canvas=document.createElement("canvas");this.blur_canvas=document.createElement("canvas");
this.i_ctx=this.image_canvas.getContext("2d");this.d_ctx=this.doodle_canvas.getContext("2d");this.e_ctx=this.edit_canvas.getContext("2d");this.c_ctx=this.choose_canvas.getContext("2d");this.t_ctx=this.temp_canvas.getContext("2d");this.b_ctx=this.blur_canvas.getContext("2d");this.out_pos=null;this.style={brush_type:f.Type.CURVE,pen_width:4,pen_opacity:1,pen_color:"#000",dot_type:f.LineType.NORMAL,arrow_type:f.LineType.NORMAL,color:"rgba(0,0,0,1.0)",text_color:"#000000",font_size:20,font_name:"Times New Roman",
svg_image:new Image};this.cur_textbox=null;this.history=new c._UndoRedoManager(this);this.zoom_scale=1;this.page={doodle_array:[]};this.edit_doodle=new f._EditDoodle(this);this.temp_doodle=null;this.has_selected_doodle=!1;this.default_cursor="url(images/pencil.png),auto";this.image_canvas.width=a.image.naturalWidth;this.image_canvas.height=a.image.naturalHeight;this.i_ctx.drawImage(a.image,0,0);this.bg_info={saved_origin:null,origin_image:null,image:this.image_canvas,x:0,y:0,width:a.image.naturalWidth,
height:a.image.naturalHeight};this.__pre_mouse_enter_region__=null;this.__region_visible__=!0;this.cut_mode=!1;this.__tmp_undo_command__=this.__cut_undo_command__=this.cut_doodle=null;this.style_callback=b;this.initEvent();this.textbox_editor=new Diigo.Text._Editor(this);this.pre_cursor_name="";this.cursor_type=1;this.d_changed=!1};f._Drawer.prototype={onChange:function(){},setCursor:function(a){jQuery(this.edit_canvas).removeClass(this.pre_cursor_name);this.edit_canvas.style.cursor=a;this.pre_cursor_name=
""},setCursor_name:function(a){this.edit_canvas.style.cursor="";jQuery(this.edit_canvas).removeClass(this.pre_cursor_name).addClass(a);this.pre_cursor_name=a},blur:function(){this.focused&&(b.log("d blur"),this.focused=!1)},focus:function(){this.focused||(b.log("d focus"),b.touchable||this.caret.focus(),this.focused=!0);null!==this.cur_textbox&&this.cur_textbox.actived&&this.cur_textbox.editor.focus()},isEdited:function(){var a=this.bg_info;return 0<this.page.doodle_array.length||a.width!==a.origin_image.naturalWidth||
a.height!==a.origin_image.naturalHeight||0!==a.x||0!==a.y||a.width!==a.image.width||a.height!==a.image.height},isChanged:function(){return this.isEdited()||this.d_changed},setBgImage:function(a,b){this.bg_info.origin_image=a;this.bg_info.saved_origin=null;this.image_canvas.width=a.naturalWidth;this.image_canvas.height=a.naturalHeight;this.i_ctx.drawImage(a,0,0);this.bg_info.iamge=this.image_canvas;this.bg_info.width=a.naturalWidth;this.bg_info.height=a.naturalHeight;this.bg_info.x=0;this.bg_info.y=
0;this.zoom_scale=1;this._clear();this._do_resize();this.d_changed=!1;var c=this;this.out_container.style.visibility="hidden";b?window.setTimeout(function(){c._on_resize();c.setFitScale();c.out_container.style.visibility="visible";c.paint()},0):window.setTimeout(function(){c._on_resize();c.out_container.style.visibility="visible";c.paint()},0)},resize:function(){this.zoom_scale=1;this._resize();this.paint()},_do_resize:function(){var a=Math.floor(this.bg_info.width*this.zoom_scale),b=Math.floor(this.bg_info.height*
this.zoom_scale);this.edit_canvas.width=a;this.edit_canvas.height=b;this.doodle_canvas.width=a;this.doodle_canvas.height=b;this.choose_canvas.height=b;this.choose_canvas.width=a;this.temp_canvas.width=a;this.temp_canvas.height=b;this.blur_canvas.width=a;this.blur_canvas.height=b;this.container.style.width=a+"px";this.container.style.height=b+"px";this.out_container.scrollLeft=0;this.out_container.scrollTop=0},_resize:function(){this._do_resize();this._on_resize()},_resetDoodleScale:function(){for(var a=
this.page.doodle_array,b=0;b<a.length;b++)a[b].resetScale()},setScale:function(a){this.zoom_scale=a;this._resetDoodleScale();this._resize();this.paint()},setFitScale:function(){var a=this.out_container,b=this.bg_info,c=a.offsetWidth/b.width,a=a.offsetHeight/b.height;1>c||1>a?this.setScale(Math.min(c,a)):this.setScale(1)},setImageSize:function(a,b){null!==this.cur_textbox&&this.unactiveTextbox();this.hideListDialog();this.__tmp_undo_command__=new c._SizeCommand(this);this._set_image_size_redo(a,b);
this.__tmp_undo_command__.finish();this.history.add(this.__tmp_undo_command__);this.__tmp_undo_command__=null},_set_image_size_undo:function(a,b,c){var d=this.bg_info;this.zoom_scale=1;this.image_canvas.width=a.width;this.image_canvas.height=a.height;this.i_ctx.drawImage(a,0,0);d.x=b.x;d.y=b.y;d.width=b.width;d.height=b.height;this._resize();[].push.apply(this.page.doodle_array,c);this.paint();this._clear_back()},_set_image_size_redo:function(a,b){this._select_nothing();var c=this.d_ctx,d=this.zoom_scale,
g=this.bg_info;this.zoom_scale=1;this.d_ctx=this.b_ctx;this.blur_canvas.width=g.width;this.blur_canvas.height=g.height;this._paintDoodleLayer();this.d_ctx=c;this.image_canvas.width=a;this.image_canvas.height=b;this.i_ctx.drawImage(this.blur_canvas,0,0,g.width,g.height,0,0,a,b);g.width=a;g.height=b;g.x=0;g.y=0;this.zoom_scale=d;this._resize();this.page.doodle_array.length=0;this._clear_back();this.paint()},_get_image:function(a){null!==this.cur_textbox&&this.unactiveTextbox();this._select_nothing();
var s=this.bg_info,c=this.d_ctx,d=this.zoom_scale,g=this.blur_canvas.width,f=this.blur_canvas.height;this.zoom_scale=1;this._resetDoodleScale();this.d_ctx=this.b_ctx;this.blur_canvas.width=s.width;this.blur_canvas.height=s.height;this._paintDoodleLayer();a="url"===a?this.blur_canvas.toDataURL():b.getCanvasBlob(this.blur_canvas);this.d_ctx=c;this.zoom_scale=d;this._resetDoodleScale();this.blur_canvas.width=g;this.blur_canvas.height=f;return a},getImageDataURL:function(){return this._get_image("url")},
getImageDataBlob:function(){return this._get_image("blob")},_removeDoodle:function(a){null!==this.cur_textbox&&(this.unactiveTextbox(),this.textbox_editor.hide());var b=this.page.doodle_array;a=b.indexOf(a);b.splice(a,1);this._select_nothing();this._clear_back()},_insertDoodle:function(a){this.page.doodle_array.unshift(a);this._clear_back()},_ur_insert:function(a){this.page.doodle_array.unshift(a);this._select_doodle(a);this._clear_back()},insertDoodle:function(a){var b=new c._DoodleNewCommand(a);
this._insertDoodle(a);this.history.add(b)},unactiveTextbox:function(){null!==this.cur_textbox&&this.cur_textbox.actived&&(this.cur_textbox.unactive(),this.cur_textbox=null,this._select_nothing())},activeTextbox:function(){this._select_nothing();this.has_selected_doodle=this.cur_textbox.selected=!0;this.attachCurTextbox();this.cur_textbox.active();this.style_callback("btn","text")},attachCurTextbox:function(){this.edit_doodle.attachDoodle(this.cur_textbox);this._paintEditLayer()},activeInnerTextbox:function(){this.cur_textbox.active();
this.style_callback("btn","text")},delTextbox:function(a){a=this.page.doodle_array.indexOf(a);0<=a&&this.page.doodle_array.splice(a,1);this.cur_textbox=null},paint:function(){this._paintDoodleLayer();this._paintEditLayer();this._paintChooseLayer()},_prepare_for_blur:function(){},_finish_for_blur:function(){},_paintDoodleLayer:function(){var a=this.bg_info,b=this.d_ctx,c=this.t_ctx,d=this.zoom_scale;b.save();c.save();b.lineCap="round";b.lineJoin="round";c.lineCap="round";c.lineJoin="round";b.scale(d,
d);b.translate(-a.x,-a.y);c.scale(d,d);c.translate(-a.x,-a.y);b.clearRect(a.x,a.y,a.width,a.height);b.drawImage(a.image,a.x,a.y,a.width,a.height,a.x,a.y,a.width,a.height);a=this.page.doodle_array;for(d=a.length-1;0<=d;d--)a[d].selected||a[d].draw(b);b.restore();c.restore()},_clear_ctx:function(a){var b=this.bg_info;a.clearRect(b.x,b.y,b.width,b.height)},_select_nothing:function(){var a=this.page.doodle_array;this.has_selected_doodle=!1;for(var b=0;b<a.length;b++)a[b].selected=!1;this.edit_doodle.attachNothing();
this._select_back()},_select_doodle:function(a){for(var b=this.page.doodle_array,c=0;c<b.length;c++)b[c].selected=!1;this.has_selected_doodle=!0;a.selected=!0;this.edit_doodle.attachDoodle(a);this._select_back()},_paintEditLayer:function(){function a(a,b,c){b=b.edit_regions;for(var s=0;s<b.length;s++)b[s].draw(a,c)}var b=this.page.doodle_array,c=this.e_ctx,d=this.bg_info,g=this.t_ctx,n=this.zoom_scale,k=d.width,r=d.height;c.save();g.save();c.lineCap="round";c.lineJoin="round";g.lineCap="round";g.lineJoin=
"round";c.scale(n,n);c.translate(-d.x,-d.y);g.scale(n,n);g.translate(-d.x,-d.y);c.clearRect(d.x,d.y,k,r);this.cut_mode&&(c.fillStyle="rgba(0, 0, 0, 0.3)",c.fillRect(d.x,d.y,k,r));for(d=b.length-1;0<=d;d--)b[d].selected&&b[d].draw_select(c);d=this.temp_doodle;null!==d&&(d.type===f.Type.RECT_BLUR?d.draw_blur(c,this.blur_canvas):d.draw(c));if(null!==this.cut_doodle)this.cut_doodle.draw(c),a(c,this.cut_doodle,this.zoom_scale);else if(this.__region_visible__){for(d=b.length-1;0<=d;d--)if(b[d].selected){a(c,
b[d],this.zoom_scale);break}a(c,this.edit_doodle,this.zoom_scale)}c.restore();g.restore()},_paintChooseLayer:function(){var a=this.page.doodle_array,b=this.c_ctx,c=this.bg_info,d=this.t_ctx,g=this.zoom_scale;b.save();d.save();b.lineCap="round";b.lineJoin="round";d.lineCap="round";d.lineJoin="round";b.scale(g,g);b.translate(-c.x,-c.y);d.scale(g,g);d.translate(-c.x,-c.y);b.clearRect(c.x,c.y,c.width,c.height);if(!this.cut_mode)for(c=a.length-1;0<=c;c--)a[c].draw_choose(b,c);null!==this.cut_doodle&&this.cut_doodle.draw_choose(b,
a.length);b.restore();d.restore()},cutImage:function(){null!==this.cur_textbox&&this.unactiveTextbox();this.cut_saved={brush:this.style.brush_type,cursor:this.default_cursor,cursor_type:this.cursor_type};this.hideListDialog();this.cursor_type=1;this.style.brush_type=f.Type.CUT;this.default_cursor="cursor_crosshair";this.setCursor_name(this.default_cursor);this.cut_mode=!0;this._select_nothing();this.edit_doodle.attachNothing();this.paint();this.__cut_undo_command__=new c._CropCommand(this)},setCropSize:function(a,
b){this.cut_mode&&(this.cut_doodle.setSize(a,b),this._paintEditLayer(),this._paintChooseLayer())},set_bg_info:function(a){var b=this.bg_info;b.x=a.x;b.y=a.y;b.width=a.w;b.height=a.h;this._resize();this.paint()},finishCutImage:function(a){if(a&&null!==this.cut_doodle){var b=this.cut_doodle.points;a=Math.min(b[0].x,b[1].x);var c=Math.min(b[0].y,b[1].y),d=Math.max(b[0].x,b[1].x),b=Math.max(b[0].y,b[1].y),g=this.bg_info;a=Math.max(a,g.x);c=Math.max(c,g.y);d=Math.min(d,g.x+g.width);b=Math.min(b,g.y+g.height);
g.x=a;g.y=c;g.width=d-a;g.height=b-c;this._resize();this._clear_back();this.__cut_undo_command__.finish();this.history.add(this.__cut_undo_command__);this.__cut_undo_command__=null;a=this.page.doodle_array;c=f.Type;for(d=0;d<a.length;d++)a[d].type===c.TEXT?a[d]._calc():a[d].type===c.CALLOUT&&a[d].child_textbox._calc()}this.cursor_type=this.cut_saved.cursor_type;this.default_cursor=this.cut_saved.cursor;this.style.brush_type=this.cut_saved.brush;2===this.cursor_type?this.setCursor(this.default_cursor):
this.setCursor_name(this.default_cursor);this.cut_mode=!1;this.cut_doodle=null;this.has_selected_doodle=!1;this.paint()},setPenWidth:function(a){this.style.pen_width=a;var b=this.page.doodle_array;if(this.has_selected_doodle){for(var d=0;d<b.length;d++)if(b[d].selected){var h=b[d].pen_width;b[d].setPenWidth(a);this.history.add(new c._DoodleWidthCommand(b[d],h,a));break}this.paint()}},setPenOpacity:function(a){this.style.pen_opacity=a;this._get_color()},setPenColor:function(a){this.style.pen_color=
a;this._get_color()},setArrowType:function(a){this.style.arrow_type=a},setPenType:function(a){var b=f.Type[a.toUpperCase()];this.style.brush_type=b;b===f.Type.LIST?(a=f._ListDoodle.__LAST_INFO__,a.color=this.style.color,this.default_cursor=a.getCursor(),this.setCursor(this.default_cursor),this.cursor_type=2):(this.default_cursor="cursor_"+a,this.setCursor_name(this.default_cursor),this.cursor_type=1)},setSvgImage:function(a){this.style.svg_image=a},insertSvgImage:function(a){this.style.svg_image=
a;var b=this.zoom_scale,c=this.container,d=this.out_container,g=Math.min(d.offsetWidth,c.offsetWidth),n=Math.min(d.offsetHeight,c.offsetHeight),c=a.width,k=a.height,r=this.bg_info,g=Math.floor(((g-c*b)/2+d.scrollLeft)/b),b=Math.floor(((n-k*b)/2+d.scrollTop)/b);a=f.create(f.Type.IMAGE,{drawer:this,image:this.style.svg_image.image,width:c,height:k,choose_type:a.choose_type,points:[{x:g+r.x,y:b+r.y},{x:g+r.x+c,y:b+r.y+k}]});a.initialize();this.insertDoodle(a);this._select_doodle(a);this.paint()},_get_color:function(){var a=
b.str2rgba(this.style.pen_color);this.style.color=b.rgba2str(a.r,a.g,a.b,this.style.pen_opacity);f._ListDoodle.__LAST_INFO__.color=this.style.color;a=this.page.doodle_array;if(this.has_selected_doodle){for(var s=0;s<a.length;s++)if(a[s].selected){var d=a[s].color;a[s].setColor(this.style.color);this.history.add(new c._DoodleColorCommand(a[s],d,this.style.color));break}this.paint()}},_get_selected_shape:function(){if(this.has_selected_doodle)for(var a=this.page.doodle_array,b=0;b<a.length;b++)if(a[b].selected)return a[b];
return null},setFontName:function(a){this.style.font_name=a;var b=f.Type,c=this.cur_textbox||this._get_selected_shape();null===c||c.type!==b.TEXT&&c.type!==b.INNERTEXT&&c.type!==b.CALLOUT||c.setFontName(a)},setFontSize:function(a){this.style.font_size=a;var b=f.Type,c=this.cur_textbox||this._get_selected_shape();null===c||c.type!==b.TEXT&&c.type!==b.INNERTEXT&&c.type!==b.CALLOUT||c.setFontSize(a)},undo:function(){this.history.undo();this._ur_back()},redo:function(){this.history.redo();this._ur_back()},
_clear:function(){this.page.doodle_array.length=0;this.history.clear();this._select_nothing();this._clear_back()},clear:function(){this._clear();this.d_changed=!0;var a=this.bg_info;a.x=0;a.y=0;a.width=a.origin_image.naturalWidth;a.height=a.origin_image.naturalHeight;a.image.width=a.width;a.image.height=a.height;this.i_ctx.drawImage(a.origin_image,0,0);this.reset_list();this._resize();this.paint();this._clear_back()},saveOrigin:function(a){if(null!==this.bg_info.saved_origin)a();else{var c=new Image;
c.src=b.image2url(this.bg_info.origin_image);c.onload=a;this.bg_info.saved_origin=c}},restoreOrigin:function(){this.bg_info.origin_image=this.bg_info.saved_origin},_ur_back:function(){this.style_callback("undo",this.history.canUndo());this.style_callback("redo",this.history.canRedo())},_select_back:function(){this.style_callback("del",this.has_selected_doodle);var a=this.edit_doodle.selected_doodle,b=f.Type,a=null!==a?a.type:this.style.brush_type;a===b.LIST&&this.style.brush_type!==b.LIST&&(a=this.style.brush_type);
this.style_callback("btn",a===b.CALLOUT||a===b.TEXT?"text":a===b.LIST?"list":"other")},_clear_back:function(){this.style_callback("clear",!1===this.isEdited())},deleteSelected:function(){var a=null,b=this.page.doodle_array;if(this.has_selected_doodle)for(var d=0;d<b.length;d++)if(b[d].selected){a=b[d];break}null!==a&&(this._removeDoodle(a),this.history.add(new c._DoodleDelCommand(a)),this.paint())},reset_list:function(){f._ListDoodle.__LAST_INFO__.reset()},resetList:function(){var a=f._ListDoodle.__LAST_INFO__;
this.reset_list();this.default_cursor=a.getCursor();this.setCursor(this.default_cursor);this.hideListDialog()}}})(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f){d._Doodle=function(c,b){this.type=c;this.drawer=b.drawer;this.points=b.points;this.color="undefined"===typeof b.color?"rgba(0,0,0,1.0)":b.color;this.highlight_color=this._calc_highlight_color(this.color);this.pen_width="undefined"===typeof b.pen_width?3:b.pen_width;this.line_type="undefined"===typeof b.line_type?0:b.line_type;this.fill_color="undefined"===typeof b.fill_color?null:b.fill_color;this.child_textbox=null;this.selected=!1;this.is_eraser=b.is_eraser?!0:!1;this.has_shadow=
!1;this.region_points=b.region_points?b.region_points:this.points;this.initialized=!1;this.edit_regions=[];this.boundary={left:0,top:0,height:0,width:0}};d.Type={CURVE:1,LINE:2,RECT:3,ELLIPSE:4,RECT_BLUR:5,CURVE_BLUR:6,CALLOUT:7,LIST:8,LINE_ARROW:20,CURVE_ARROW:21,BEZIER_ARROW:22,IMAGE:30,ERASER:60,TEXT:80,INNERTEXT:81,CUT:8888,EDITHELPER:999};d.LineType={NORMAL:0,DASH_ONE:1,DASH_TWO:2,DASH_THREE:4,LEFT_ARROW:8,RIGHT_ARROW:16,DOUBLE_ARROW:32,SEED:128,FILL:256,MATRIX:512};d.create=function(c,b){var a=
d.Type;switch(c){case a.ERASER:return new d._SimpleEraserDoodle(b);case a.LINE:return new d._LineDoodle(b);case a.RECT:return new d._RectDoodle(b);case a.ELLIPSE:return new d._EllipseDoodle(b);case a.CURVE:return new d._CurveDoodle(b);case a.RECT_BLUR:return new d._RectBlurDoodle(b);case a.CURVE_BLUR:return new d._CurveBlurDoodle(b);case a.TEXT:return new d._TextboxDoodle(b);case a.INNERTEXT:return new d._InnerTextboxDoodle(b);case a.CUT:return new d._CutDoodle(b);case a.CALLOUT:return new d._CalloutDoodle(b);
case a.LIST:return new d._ListDoodle(b);case a.IMAGE:return new d._ImageDoodle(b);case a.LINE_ARROW:return new d._LineArrowDoodle(b);case a.CURVE_ARROW:return new d._CurveArrowDoodle(b);case a.BEZIER_ARROW:return new d._BezierArrowDoodle(b);default:return f.log("unkown type of doodle: "+c),new d._CurveDoodle(b)}};d._Doodle.prototype={setRegionDisabled:function(c){for(var b=0;b<this.edit_regions.length;b++)this.edit_regions[b].disabled=c},initialize:function(){this.initialized=!0},onRegionEdit:function(c,
b){},onRegionEditStart:function(c,b){},onRegionEditFinish:function(c,b){},getRotateUndoCommand:function(){return null},getMoveUndoCommand:function(){return null},getRegionUndoCommand:function(){return null},afterUndoRedo:function(){this._calc();this.drawer._select_doodle(this)},_create_edit_region:function(){for(var c=0;c<this.region_points.length;c++)this.edit_regions.push(new d.CircleRegion(this,c,this.region_points[c],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},setPenWidth:function(c){this.pen_width=
c;for(c=0;c<this.edit_regions.length;c++)this.edit_regions[c].radius=Math.round((Math.max(this.pen_width,8)+6)/2)},setColor:function(c){this.color=c;this.highlight_color=this._calc_highlight_color(c)},_calc_highlight_color:function(){var c=f.str2rgba(this.color);return 200<=c.r&&200<=c.b&&200<=c.g?"rgba(0,0,0,0.3)":"rgba(255, 255, 255, "+c.a+")"},getSelectedColor:function(){},getRotatePoint:function(){return null},_calc_1:function(c){for(var b=c[0],a=b.x,s=b.y,d=b.x,h=b.y,g=this.boundary,f=0;f<c.length;f++)b=
c[f],b.x<a&&(a=b.x),b.x>d&&(d=b.x),b.y<s&&(s=b.y),b.y>h&&(h=b.y);g.width=d-a;g.height=h-s;g.left=a;g.top=s;g.right=d;g.bottom=h},_calc_2:function(c,b,a,s){var d=this.boundary;d.width=Math.abs(c-a);d.height=Math.abs(b-s);d.left=Math.min(c,a);d.top=Math.min(b,s);d.right=d.left+d.width;d.bottom=d.top+d.height},set_child_textbox:function(){},_doDraw:function(c,b,a,s,d){throw"abstract method _doDraw";},draw_choose:function(c,b){var a=f.int2color(b);c.strokeStyle=a;c.fillStyle=a;c.lineWidth=Math.round(1.5*
this.pen_width);this._doChooseDraw(c,a)},draw_select:function(c){c.save();c.strokeStyle=this.highlight_color;c.shadowColor="rgba(0, 0, 0, 0.4)";c.shadowOffsetX=0;c.shadowOffsetY=2;c.shadowBlur=4;c.lineWidth=Math.floor(this.pen_width+6);this._doSelectDraw(c);c.restore();this.draw(c)},draw_region:function(c,b,a){this.draw_select(c,a);for(a=0;a<this.edit_regions.length;a++)this.edit_regions[a].draw(c,b)},_doChooseDraw:function(c,b){this._doDraw(c,b)},_doSelectDraw:function(c){this._doDraw(c)},draw:function(c,
b,a,s){throw"abstruct methon draw";},drawFPT:function(c,b,a,s){this.draw(c,b,a,s)},_typed_draw:function(c){c.save();c.strokeStyle=this.color;c.lineWidth=this.pen_width;var b=d.LineType,a=null,s=this.line_type;0<(s&b.DASH_ONE)?f.setLineDash(c,[1,5]):0<(s&b.DASH_TWO)?f.setLineDash(c,[6,5]):0<(s&b.DASH_THREE)&&f.setLineDash(c,[6,5,1,5]);0<(s&b.LEFT_ARROW)?a=this._drawLeftArrow:0<(s&b.RIGHT_ARROW)?a=this._drawRightArrow:0<(s&b.DOUBLE_ARROW)&&(a=this._drawDoubleArrow);this._doDraw(c,this.fill_color,this.has_shadow);
null!==a&&a.call(this,c);c.restore();null!==this.child_textbox&&this.child_textbox.draw(c)},_normal_draw:function(c,b,a,s){c.strokeStyle=this.color;c.lineWidth=this.pen_width;this._doDraw(c,this.fill_color,b,a,s)},editMove:function(c,b){throw"absolute method editMove";},editRotateScale:function(c,b,a,s){throw"absolute method editRotateScale";},rotateScale:function(c,b,a){throw"absolute method rotateScale";},move:function(c,b){throw"absolute method move";},editStart:function(c){throw"absolute methon editStart";
},editFinish:function(c){this._calc()},editPushPoint:function(c){throw"absolute method editPushPoint";},_drawLeftArrow:function(c){},_drawRightArrow:function(c){},_drawDoubleArrow:function(c){this._drawLeftArrow(c);this._drawRightArrow(c)},setFillColor:function(c){return!1},resetScale:function(){}}})(Diigo.Doodle,Diigo.$);(function(d,f,c){d._CommonDoodle=function(b,a){this.base(b,a);this.pre_points=c.copyPoints(this.points);this.rotate_point={x:0,y:0};this._calc()};d._CommonDoodle.prototype={getRotatePoint:function(){return null},getMoveUndoCommand:function(b){return new f._DoodlePointsCommand(this)},_calc:function(){this._calc_1(this.points);var b=this.boundary;this.rotate_point.x=Math.floor(b.left+b.width/2);this.rotate_point.y=b.top-20},draw:function(b,a,c,d){this._typed_draw(b,a,c,d)},editMove:function(b,a){for(var c=
0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+b,this.points[c].y=this.pre_points[c].y+a;this._calc()},move:function(b,a){for(var c=0;c<this.points.length;c++)this.points[c].x+=b,this.points[c].y+=a;this._calc()},editStart:function(){c.setPoints(this.pre_points,this.points)},editPushPoint:function(b){this.points.push(b);this.pre_points.push({x:0,y:0});this._calc()}};c.inherit(d._CommonDoodle,d._Doodle);d._CurveDoodle=function(b){if(1===b.points.length){var a=b.points[0];b.points.push({x:a.x+
b.pen_width/4,y:a.y})}this.base(d.Type.CURVE,b)};d._CurveDoodle.prototype={_doDraw:function(b){c.drawBesier(b,this.points)},_drawLeftArrow:function(b){var a=this.points,s=a[0],a=1<a.length?a[1]:s;c.drawArrow(b,a.x,a.y,s.x,s.y)},_drawRightArrow:function(b){var a=this.points,s=a[a.length-1],a=1<a.length?a[a.length-2]:s;c.drawArrow(b,a.x,a.y,s.x,s.y)}};c.inherit(d._CurveDoodle,d._CommonDoodle);d._LineDoodle=function(b){1===b.points.length&&b.points.push({x:b.points[0].x,y:b.points[0].y});this.base(d.Type.LINE,
b);this.region_points=this.points;this._create_edit_region()};d._LineDoodle.prototype={_calc:function(){var b=this.points;this._calc_2(b[0].x,b[0].y,b[1].x,b[1].y)},_doDraw:function(b){var a=this.points;c.drawLine(b,a[0].x,a[0].y,a[1].x,a[1].y)},_drawLeftArrow:function(b){var a=this.points,s=a[0],a=a[1];c.drawArrow(b,a.x,a.y,s.x,s.y)},_drawRightArrow:function(b){var a=this.points,s=a[1],a=a[0];c.drawArrow(b,a.x,a.y,s.x,s.y)},editPushPoint:function(b){this.points[1].x=b.x;this.points[1].y=b.y;this._calc()},
getRegionUndoCommand:function(){return new f._DoodlePointsCommand(this)},onRegionEdit:function(b,a){this.points[b].x=a.x;this.points[b].y=a.y;this._calc();this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(b,a){this.drawer.edit_doodle.attachDoodle(this)}};c.inherit(d._LineDoodle,d._CommonDoodle);d._LineArrowDoodle=function(b){this.arrow_info={idx:0,pos:{}};this.base(b)};d._LineArrowDoodle.prototype={setPenWidth:function(b){this.callBase("setPenWidth",b);this._calc_arrow()},draw:function(b){var a=
this.drawer.t_ctx,c=this.drawer.bg_info;a.save();a.fillStyle=this.color;a.strokeStyle=this.color;a.lineWidth=this.pen_width;a.clearRect(c.x,c.y,c.width,c.height);this._doDraw(a);a.restore();b.save();b.setTransform(1,0,0,1,0,0);b.drawImage(a.canvas,0,0);b.restore()},_calc_arrow:function(){var b=this.points,a=5*this.pen_width;this.arrow_info.idx=c.getPTPRange(b[0],b[1])>a?1:0;this.arrow_info.pos=c.calcArrow(b[0].x,b[0].y,b[1].x,b[1].y,a)},_doDraw:function(b,a){var c=this.points,d=this.arrow_info,h=
d.pos,d=0===d.idx;b.beginPath();d?(b.beginPath(),b.moveTo(h.ax,h.ay),b.lineTo(h.dx,h.dy),b.lineTo(h.bx,h.by),b.closePath(),b.fill()):(b.moveTo(c[0].x,c[0].y),b.lineTo(h.cx,h.cy),a?(b.lineTo(h.ax,h.ay),b.lineTo(h.dx,h.dy),b.lineTo(h.bx,h.by),b.lineTo(h.cx,h.cy),b.stroke()):(b.stroke(),b.closePath(),b.beginPath(),b.moveTo(h.ax,h.ay),b.lineTo(h.dx,h.dy),b.lineTo(h.bx,h.by),b.closePath(),b.save(),b.globalCompositeOperation="destination-out",b.fillStyle="black",b.fill(),b.restore(),b.fill()))},_calc:function(){this.callBase("_calc");
this._calc_arrow()},_doSelectDraw:function(b){this._doDraw(b,!0)},_doChooseDraw:function(b,a){this._doDraw(b,!1)}};c.inherit(d._LineArrowDoodle,d._LineDoodle);d._CurveArrowDoodle=function(b){this.arrow_info={idx:0,pos:{}};this.base(b)};d._CurveArrowDoodle.prototype={setPenWidth:function(b){this.callBase("setPenWidth",b);this._calc_arrow()},draw:function(b){var a=this.drawer,c=a.t_ctx,a=a.bg_info;c.save();c.fillStyle=this.color;c.strokeStyle=this.color;c.lineWidth=this.pen_width;c.clearRect(a.x,a.y,
a.width,a.height);this._doDraw(c);c.restore();b.save();b.setTransform(1,0,0,1,0,0);b.drawImage(c.canvas,0,0);b.restore()},_doDraw:function(b,a){var s=this.points,d=this.arrow_info,h=d.pos,g=0===d.idx;b.beginPath();if(g)b.beginPath(),b.moveTo(h.cx,h.cy),b.lineTo(h.ax,h.ay),b.lineTo(h.dx,h.dy),b.lineTo(h.bx,h.by),b.closePath(),b.fill();else{var g=null,f=s[0];b.moveTo(f.x,f.y);for(var k=0;k<d.idx;k++)g=c.getMiddlePoint(s[k],s[k+1]),b.quadraticCurveTo(f.x,f.y,g.x,g.y),f=s[k+1];k={x:h.cx,y:h.cy};g=c.getMiddlePoint(s[d.idx],
k);b.quadraticCurveTo(f.x,f.y,g.x,g.y);g=f=k;b.quadraticCurveTo(f.x,f.y,g.x,g.y);a||(b.stroke(),b.closePath(),b.beginPath(),b.moveTo(h.cx,h.cy));b.lineTo(h.ax,h.ay);b.lineTo(h.dx,h.dy);b.lineTo(h.bx,h.by);a?(b.lineTo(h.cx,h.cy),b.stroke()):(b.closePath(),b.save(),b.globalCompositeOperation="destination-out",b.fillStyle="black",b.fill(),b.restore(),b.fill())}},_calc:function(){this.callBase("_calc");this._calc_arrow()},_calc_arrow:function(){var b=this.points,a=5*this.pen_width,s=b.length-1;if(!(0>=
s)){for(var d=0;0<s;){d=c.getPTPRange(b[b.length-1],b[s-1]);if(d>=a||1===s)break;s--}this.arrow_info.idx=s-1;this.arrow_info.pos=c.calcArrow(b[s-1].x,b[s-1].y,b[b.length-1].x,b[b.length-1].y,a)}},_doSelectDraw:function(b){this._doDraw(b,!0)},_doChooseDraw:function(b,a){this._doDraw(b,!1)}};c.inherit(d._CurveArrowDoodle,d._CurveDoodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){d._MatrixDoodle=function(b,a){1===a.points.length&&a.points.push({x:a.points[0].x,y:a.points[0].y});this.base(b,a);this.matrix=null==a.matrix?[1,0,0,0,1,0,0,0,0]:a.matrix;this.line_type|=512;this.pre_matrix=c.copyArray(this.matrix);this.region_points=[];this.rotate_point={x:0,y:0};this.region_points=c.genPoints(a.region_number?a.region_number:4);this._calc();this._create_edit_region()};d._MatrixDoodle.prototype={getRotatePoint:function(){return this.rotate_point},_create_edit_region:function(){for(var b=
0;b<this.region_points.length;b++)this.edit_regions.push(new d.CircleRegion(this,b,this.region_points[b],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},getMoveUndoCommand:function(){return new f._DoodleMatrixCommand(this)},getRegionUndoCommand:function(){return new f._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new f._DoodleMatrixCommand(this)},_calcBeforeMatrixPoint:function(b,a,c){var d=b[3]*b[1]-b[0]*b[4];if(0===d)return alert("0"),console.error("\u51fa\u73b0\u96640\uff01"),
null;d=((c-b[5])*b[1]-(a-b[2])*b[4])/d;if(0!==b[1])b=(a-b[2]-b[0]*d)/b[1];else if(0!==b[4])b=(c-b[5]-b[3]*d)/b[4];else return alert("0"),console.error("\u51fa\u73b0\u96640~\uff01"),null;return{x:Math.floor(d),y:Math.floor(b)}},_calcBeforeMatrixWidth:function(b,a,c,d,h){var g=b[3]*b[1]-b[0]*b[4];return 0===g?(alert("0"),console.error("\u51fa\u73b0\u96640\uff01"),-1):Math.abs(Math.floor(((c-b[5])*b[1]-(a-b[2])*b[4])/g-((h-b[5])*b[1]-(d-b[2])*b[4])/g))},_onRegionEdit:function(b,a,c){var d=this._calcBeforeMatrixPoint(this.matrix,
a.x,a.y);a=d.x;var d=d.y,h=c[0];c=c[1];if(8===this.region_points.length)switch(b){case 0:h.x=a;h.y=d;break;case 1:h.y=d;break;case 2:c.x=a;h.y=d;break;case 3:c.x=a;break;case 4:c.x=a;c.y=d;break;case 5:c.y=d;break;case 6:h.x=a;c.y=d;break;case 7:h.x=a}else switch(b){case 0:h.x=a;h.y=d;break;case 1:c.x=a;h.y=d;break;case 2:c.x=a;c.y=d;break;case 3:h.x=a,c.y=d}},onRegionEdit:function(b,a){this._onRegionEdit(b,a,this.points);this._calc();this.drawer.edit_doodle.attachDoodle(this)},set_child_textbox:function(b){this.child_textbox=
b;this._calc_boundary()},_calc_boundary:function(){var b=this.boundary,a=this.child_textbox.boundary;b.left=Math.min(b.left,a.left);b.right=Math.max(b.right,a.right);b.top=Math.min(b.top,a.top);b.bottom=Math.max(b.bottom,a.bottom)},_calc:function(){function b(a,b){return Math.floor(c[0]*a+c[1]*b+c[2])}function a(a,b){return Math.floor(c[3]*a+c[4]*b+c[5])}var c=this.matrix,d=this.points,h,g,f,k,r,l,p,m,q=(d[0].x+d[1].x)/2,t=(d[0].y+d[1].y)/2,y=Math.min(d[0].y,d[1].y)-this.pen_width/2-25;h=b(d[0].x,
d[0].y);r=a(d[0].x,d[0].y);g=b(d[1].x,d[0].y);l=a(d[1].x,d[0].y);f=b(d[1].x,d[1].y);p=a(d[1].x,d[1].y);k=b(d[0].x,d[1].y);m=a(d[0].x,d[1].y);var u=this.region_points;8===u.length?(u[0].x=h,u[0].y=r,u[1].x=b(q,d[0].y),u[1].y=a(q,d[0].y),u[2].x=g,u[2].y=l,u[3].x=b(d[1].x,t),u[3].y=a(d[1].x,t),u[4].x=f,u[4].y=p,u[5].x=b(q,d[1].y),u[5].y=a(q,d[1].y),u[6].x=k,u[6].y=m,u[7].x=b(d[0].x,t),u[7].y=a(d[0].x,t)):(u[0].x=h,u[0].y=r,u[1].x=g,u[1].y=l,u[2].x=f,u[2].y=p,u[3].x=k,u[3].y=m);this.rotate_point.x=b(q,
y);this.rotate_point.y=a(q,y);this._calc_2(Math.min(h,g,f,k),Math.min(r,l,p,m),Math.max(h,g,f,k),Math.max(r,l,p,m))},draw:function(b,a,c,d){this._typed_draw(b,a,c,d)},editStart:function(){c.setArray(this.pre_matrix,this.matrix);null!==this.child_textbox&&this.child_textbox.editStart()},editFinish:function(){this._calc();null!==this.child_textbox&&(this.child_textbox.editFinish(),this._calc_boundary())},editMove:function(b,a){this.matrix[2]=this.pre_matrix[2]+b;this.matrix[5]=this.pre_matrix[5]+a;
this._calc();null!==this.child_textbox&&this.child_textbox.editMove()},move:function(b,a){this.matrix[2]+=b;this.matrix[5]+=a;this._calc()},rotateScale:function(b,a,d){c.setArray(this.pre_matrix,this.matrix);this.editRotateScale(b,a,d)},editRotateScale:function(b,a,c,d){c=1;var h=this.matrix,g=this.pre_matrix,f=Math.sin(a)*c;a=Math.cos(a)*c;c=b.x;b=b.y;h[0]=a*g[0]-f*g[3];h[1]=a*g[1]-f*g[4];h[2]=a*g[2]-f*g[5]-a*c+f*b+c;h[3]=f*g[0]+a*g[3];h[4]=f*g[1]+a*g[4];h[5]=f*g[2]+a*g[5]-f*c-a*b+b;!0!==d&&this._calc();
null!==this.child_textbox&&this.child_textbox.editRotateScale()},editPushPoint:function(b){this.points[1].x=b.x;this.points[1].y=b.y;this._calc()},setFillColor:function(b){this.fill_color="string"!==typeof b?null:b;return!0},resetZoomScale:function(){null!==this.child_textbox&&this.child_textbox.resetZoomScale()}};c.inherit(d._MatrixDoodle,d._Doodle);d._RectDoodle=function(b){this.base(d.Type.RECT,b)};d._RectDoodle.prototype={_doDraw:function(b,a){var c=this.points;b.save();b.transform(this.matrix[0],
this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);b.beginPath();b.moveTo(c[0].x,c[0].y);b.lineTo(c[1].x,c[0].y);b.lineTo(c[1].x,c[1].y);b.lineTo(c[0].x,c[1].y);b.closePath();null!==a&&(b.fillStyle=a,b.fill());b.stroke();b.restore()},_doChooseDraw:function(b,a){this._doDraw(b,null!==this.fill_color?a:null)},_doSelectDraw:function(b){this._doDraw(b,null)}};c.inherit(d._RectDoodle,d._MatrixDoodle);d._EllipseDoodle=function(b){this.center={x:0,y:0};this.radius={a:0,b:0};this.base(d.Type.ELLIPSE,
b)};d._EllipseDoodle.prototype={_calc:function(){var b=this.points;this.center.x=Math.round((b[0].x+b[1].x)/2);this.center.y=Math.round((b[0].y+b[1].y)/2);this.radius.a=Math.round(Math.abs(b[0].x-b[1].x)/2);this.radius.b=Math.round(Math.abs(b[0].y-b[1].y)/2);this.callBase("_calc")},_doDraw:function(b,a){b.save();b.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);c.drawEllipse(b,this.center.x,this.center.y,this.radius.a,this.radius.b,a);b.restore()},
_doChooseDraw:function(b,a){this._doDraw(b,null!==this.fill_color?a:null)},_doSelectDraw:function(b){this._doDraw(b,null)}};c.inherit(d._EllipseDoodle,d._MatrixDoodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c,b){f._TextboxDoodle=function(a){1===a.points.length&&a.points.push({x:a.points[0].x,y:a.points[0].y});this.base(f.Type.TEXT,a);this.editor=this.drawer.textbox_editor;this.matrix=[1,0,0,0,1,0,0,0,0];this.pre_matrix=b.copyArray(this.matrix);this.editor_matrix=b.copyArray(this.matrix);this.style=a.style?a.style:new d._Style(this.drawer.style);this.page_idx=this.editor.createPage(this.style);this.actived=!1;this.auto_width=!1!==a.auto_width;this.size={width:0,height:0};this.center={x:0,
y:0};this.rotate_point={x:0,y:0};this._ur_timeout=null;this._ur_value=this.editor.getPageByIdx(this.page_idx).text;this._ur_handler=b.createDelegate(this,this._deal_ur);this._calc()};f._TextboxDoodle.prototype={afterUndoRedo:function(){this._calc();this.actived?this.resetOutline():null!==this.drawer.cur_textbox&&this.drawer.cur_textbox!==this&&this.drawer.unactiveTextbox();this.drawer._select_doodle(this)},getRotatePoint:function(){return this.rotate_point},getMoveUndoCommand:function(){return new c._DoodleMatrixCommand(this)},
getRegionUndoCommand:function(){return new c._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new c._DoodleMatrixCommand(this)},setURText:function(a){var b=this.editor.getPageByIdx(this.page_idx);b.text=a;b.initParagraph();this.actived&&(this.auto_width&&this._calc_text_outline(a),this.editor.textarea.value=a,this.editor.textarea.focus())},setColor:function(a){this.style.color=a;this.editor.textarea.style.color=this.style.color},setFontName:function(a){this.style.setFontName(a);
this._resetFont()},setFontSize:function(a){this.style.setFontSize(a);this._resetFont()},_resetFont:function(){var a=this.style.getScaleFont(this.drawer.zoom_scale);if(this.actived)this.editor.cur_page.resetFont(),this.editor.textarea.style.font=a,this.editor.textarea.style.lineHeight=b.getFontInfo(a).height+"px",this.onTextInput(this.editor.textarea.value);else{a=this.editor.getPageByIdx(this.page_idx);a.resetFont();if(this.auto_width)this._calc_text_outline(a.text);else{var c=this.editor;c.save_state();
c._setCurPage(this.page_idx);a.initParagraph();c.restore_state()}this.drawer.edit_doodle._re_attach_doodle();this.drawer._paintEditLayer()}},initialize:function(){var a=this.points;if(a[1].y<a[0].y){var b=a[0];a[0]=a[1];a[1]=b}a[1].x<a[0].x&&(b=a[0].x,a[0].x=a[1].x,a[1].x=b);b=this.editor.getPageHeight(this.page_idx);this.auto_width?(this.size.width=20,this.size.height=b):(this.size.width=Math.max(20,a[1].x-a[0].x),this.size.height=Math.max(50,a[1].y-a[0].y));this.matrix[2]=a[0].x;this.matrix[5]=
a[0].y;a[0].x=0;a[0].y=0;a[1].x=this.size.width;a[1].y=this.size.height;this.initialized=!0;this._setAutoWidth(this.auto_width);this._calc();this.resetOutline()},_setAutoWidth:function(a){this.editor.setBoxAutoWidth(a)},editStart:function(){b.setArray(this.pre_matrix,this.matrix)},editMove:function(a,b){this.matrix[2]=this.pre_matrix[2]+a;this.matrix[5]=this.pre_matrix[5]+b;this._calc()},move:function(a,b){this.matrix[2]+=a;this.matrix[5]+=b;this._calc()},rotateScale:function(a,c,d){b.setArray(this.pre_matrix,
this.matrix);this.editRotateScale(a,c,d)},editRotateScale:function(a,b,c){this.is_rotating||(this.is_rotating=!0);c=this.matrix;var d=this.pre_matrix,g=Math.sin(b);b=Math.cos(b);var f=a.x;a=a.y;c[0]=b*d[0]-g*d[3];c[1]=b*d[1]-g*d[4];c[2]=b*d[2]-g*d[5]-b*f+g*a+f;c[3]=g*d[0]+b*d[3];c[4]=g*d[1]+b*d[4];c[5]=g*d[2]+b*d[5]-g*f-b*a+a;this._calc();this.actived&&(this.resetMatrix(),this._resetSize())},editPushPoint:function(a){},_calc_editor_matrix:function(){var a=this.matrix,c=this.editor_matrix,d=this.drawer.zoom_scale,
h=(this.center.x-this.drawer.bg_info.x)*d,g=(this.center.y-this.drawer.bg_info.y)*d,d=Math.sqrt(a[0]*a[4]-a[1]*a[3])*d;b.setArray(c,[1,0,0,0,1,0,0,0,0]);c[2]=h-this.size.width*d/2;c[5]=g-this.size.height*d/2;var d=Math.atan2(a[4],a[1])-Math.PI/2,a=Math.cos(d),d=Math.sin(d),f=a*c[1]-d*c[4],k=a*c[2]-d*c[5]-a*h+d*g+h,r=d*c[0]+a*c[3],l=d*c[1]+a*c[4],h=d*c[2]+a*c[5]-d*h-a*g+g;c[0]=a*c[0]-d*c[3];c[1]=f;c[2]=k;c[3]=r;c[4]=l;c[5]=h},resetScale:function(){this._calc_editor_matrix();this.resetOutline();this.resetFont()},
resetFont:function(){var a=this.matrix,a=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale;this.editor.textarea.style.font=this.editor.cur_page.style.getScaleFont(a)},resetOutline:function(){this.actived&&(this._resetSize(),this.editor.setBoxMatrix(this.editor_matrix))},_resetSize:function(){var a=this.matrix,a=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale;this.editor.setBoxSize_scale(this.size.width,this.size.height,a)},_setDrawSize:function(){var a=this.matrix,a=Math.sqrt(a[0]*a[4]-
a[1]*a[3])*this.drawer.zoom_scale;this.editor.set_drawtext_size(this.size.width,this.size.height,a)},_calc_text_outline:function(a){var b=this.editor,c=a.split("\n");a=20;var d=b.render.ctx,g=this.points;d.save();d.font=b.cur_page.style.font;for(var f=0;f<c.length;f++){var k=d.measureText(c[f]).width;a<k&&(a=k)}d.restore();b=b.cur_page.line_height*c.length;this.size.width=Math.ceil(a)+5;this.size.height=Math.ceil(b);g[1].x=this.size.width;g[1].y=this.size.height;this._resetSize();this._calc()},onTextInput:function(a){this.auto_width&&
(this._calc_text_outline(a),this.drawer.edit_doodle._re_attach_doodle(),this.drawer._paintEditLayer())},resetMatrix:function(){this.setBoxMatrix(this.editor_matrix)},setBoxMatrix:function(a){this.editor.setBoxMatrix(a)},_calc:function(a){var b=this.matrix,c=this.points,d,g,f,k,r,l,p,m,q=(c[0].x+c[1].x)/2,t=Math.min(c[0].y,c[1].y)-20;d=b[0]*c[0].x+b[1]*c[0].y+b[2];r=b[3]*c[0].x+b[4]*c[0].y+b[5];g=b[0]*c[1].x+b[1]*c[0].y+b[2];l=b[3]*c[1].x+b[4]*c[0].y+b[5];f=b[0]*c[1].x+b[1]*c[1].y+b[2];p=b[3]*c[1].x+
b[4]*c[1].y+b[5];k=b[0]*c[0].x+b[1]*c[1].y+b[2];m=b[3]*c[0].x+b[4]*c[1].y+b[5];var y=(c[0].x+c[1].x)/2,c=(c[0].y+c[1].y)/2;this.center.x=Math.floor(b[0]*y+b[1]*c+b[2]);this.center.y=Math.floor(b[3]*y+b[4]*c+b[5]);this.rotate_point.x=Math.floor(b[0]*q+b[1]*t+b[2]);this.rotate_point.y=Math.floor(b[3]*q+b[4]*t+b[5]);this._calc_2(Math.min(d,g,f,k),Math.min(r,l,p,m),Math.max(d,g,f,k),Math.max(r,l,p,m));a||this._calc_editor_matrix()},_deal_ur:function(){var a=this.editor.textarea.value;this._ur_value!==
a&&(this.drawer.history.add(new c._DoodleTextCommand(this,this._ur_value,a)),this._ur_value=a)},onTextPress:function(){null!==this._ur_timeout&&window.clearTimeout(this._ur_timeout);this._ur_timeout=window.setTimeout(this._ur_handler,300)},active:function(){this._doActive();this.editor.textarea.style.color=this.style.color},_doActive:function(){this.actived=!0;this.drawer.paint();this.editor.floated_textbox=this;this.editor.setCurPage(this.page_idx);this._setAutoWidth(this.auto_width);this.resetOutline();
var a=this.editor;a.show();a.focus()},unactive:function(){this.actived=!1;var a=this.editor;a.blur();a.hide();""===a.textarea.value.trim()?this.drawer.delTextbox(this):(a.cur_page.text=a.textarea.value,a.cur_page.initParagraph())},_doDraw:function(a,c,d){var h=this.points;a.save();a.lineWidth=2;b.setLineDash(a,[6,5]);a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);a.beginPath();a.moveTo(h[0].x,h[0].y);a.lineTo(h[1].x,h[0].y);a.lineTo(h[1].x,h[1].y);
a.lineTo(h[0].x,h[1].y);a.closePath();c?(a.fillStyle=c,a.fill()):d&&(a.strokeStyle=d,a.stroke());a.restore()},draw_select:function(a,b){this.actived||this._draw_text(a);this._doDraw(a,null,this.style.color)},_doChooseDraw:function(a,b){this._doDraw(a,b,null)},_draw_text:function(a){var b=this.editor_matrix,c=this.editor;c.save_state();a.save();a.setTransform(1,0,0,1,0,0);a.transform(b[0],b[3],b[1],b[4],b[2],b[5]);c._setCurPage(this.page_idx);this._setDrawSize();this.editor.render.paintToContext(a,
this.style);a.restore();c.restore_state()},draw:function(a){this.initialized?this.actived?this.actived&&this._doDraw(a,null,this.style.color):this._draw_text(a):this._doDraw(a,null,this.style.color)}};b.inherit(f._TextboxDoodle,f._Doodle)})(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c,b){f._InnerTextboxDoodle=function(a){this.base(a);this.type=f.Type.INNERTEXT;this.parent_doodle="undefined"!==typeof a.parent_doodle?a.parent_doodle:null;this.center={x:0,y:0};this.auto_width=!1;a=b.str2rgba(this.style.color);this.style.color=170<0.299*a.r+0.587*a.g+0.114*a.b?"#000":"#fff";this.edit_height=0};f._InnerTextboxDoodle.prototype={setColor:function(a){this.style.color=a;a=b.str2rgba(this.style.color);this.style.color=170<0.299*a.r+0.587*a.g+0.114*a.b?"#000":"#fff";this.editor.textarea.style.color=
this.style.color},initialize:function(){b.setArray(this.matrix,this.parent_doodle.matrix);this._calc_size();this.edit_height=this.size.height;this.initialized=!0;this._setAutoWidth(this.auto_width);this._calc()},afterUndoRedo:function(){b.setArray(this.matrix,this.parent_doodle.matrix);this._calc_size();this._calc();this.actived&&this.resetOutline()},_calc_size:function(){var a=this.parent_doodle,b=this.points,c=Math.asin(1)/2,d=a.radius.a*Math.cos(c),c=a.radius.b*Math.sin(c);b[0].x=Math.floor(a.center.x-
d+8);b[0].y=Math.floor(a.center.y-c+8);b[1].x=Math.floor(a.center.x+d-8);b[1].y=Math.floor(a.center.y+c-8);this.center.x=a.center.x;this.center.y=a.center.y;this.size.width=Math.max(20,b[1].x-b[0].x);this.size.height=Math.max(20,b[1].y-b[0].y)},_resetSize:function(){var a=this.matrix,a=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale;this.editor.setBoxSize_scale(this.size.width,this.edit_height,a);this.editor.render.height=this.size.height},active:function(){this._doActive();this.editor.textarea.style.color=
this.style.color},unactive:function(){this.callBase("unactive");this.edit_height=Math.max(this.size.height,this.editor.cur_page.page_height)},editStart:function(){b.setArray(this.pre_matrix,this.matrix)},editFinish:function(){},editMove:function(){b.setArray(this.matrix,this.parent_doodle.matrix);this._calc();this.actived&&this.resetOutline()},editRotateScale:function(){b.setArray(this.matrix,this.parent_doodle.matrix);this._calc();this.actived&&this.resetOutline()},onTextInput:function(a){a=this.editor.textarea;
var b=a.scrollHeight;a.offsetHeight!==b&&(a.style.height=b+"px")},draw_select:function(a,b){this.actived||this._draw_text(a)},draw:function(a){this.initialized?this.actived||this._draw_text(a):this._doDraw(a,null,this.style.color)},on_resize_region:function(){var a=this.editor.textarea;this._calc_size();this._calc();this._resetSize();if(this.actived){this.editor.setBoxMatrix(this.editor_matrix);var b=a.scrollHeight;a.offsetHeight!==b&&(a.style.height=b+"px")}}};b.inherit(f._InnerTextboxDoodle,f._TextboxDoodle)})(Diigo.Text,
Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f){d._RectBlurDoodle=function(c){1===c.points.length&&c.points.push({x:c.points[0].x,y:c.points[0].y});c.pen_width=2;c.region_points=f.genPoints(4);this.base(d.Type.RECT_BLUR,c);this._create_edit_region()};d._RectBlurDoodle.prototype={onRegionEdit:function(c,b){var a=b.x,d=b.y,f=this.points[0],h=this.points[1];switch(c){case 0:f.x=a;f.y=d;break;case 1:h.x=a;f.y=d;break;case 2:h.x=a;h.y=d;break;case 3:f.x=a,h.y=d}this._calc()},_calc:function(){var c=this.points,b=this.region_points;b[0].x=
c[0].x;b[0].y=c[0].y;b[1].x=c[1].x;b[1].y=c[0].y;b[2].x=c[1].x;b[2].y=c[1].y;b[3].x=c[0].x;b[3].y=c[1].y;this._calc_1(this.points)},draw:function(c){var b=this.boundary,a=this.drawer.zoom_scale,d=Math.floor((b.left-this.drawer.bg_info.x)*a),v=Math.floor((b.top-this.drawer.bg_info.y)*a),h=Math.floor(b.width*a),b=Math.floor(b.height*a);0<h&&0<b&&f.stackBlurCanvasRGBA(c,d,v,h,b,Math.floor(7*this.drawer.zoom_scale))},draw_blur:function(c,b){var a=this.drawer.b_ctx;c.save();c.setTransform(1,0,0,1,0,0);
a.save();a.setTransform(1,0,0,1,0,0);var d=this.boundary,v=this.drawer.zoom_scale,h=Math.floor((d.left-this.drawer.bg_info.x)*v),g=Math.floor((d.top-this.drawer.bg_info.y)*v),n=Math.floor(d.width*v),d=Math.floor(d.height*v);0<n&&0<d&&(a.drawImage(this.drawer.doodle_canvas,h,g,n,d,h,g,n,d),f.stackBlurCanvasRGBA(a,h,g,n,d,Math.floor(7*this.drawer.zoom_scale)),c.drawImage(this.drawer.blur_canvas,h,g,n,d,h,g,n,d));c.restore();a.restore();c.strokeStyle="rgba(0, 0, 0, 0.6)";c.lineWidth=Math.floor(2*v);
f.setLineDash(c,[4*v,4*v]);this._doDraw(c)},_doDraw:function(c,b){var a=this.points;c.save();c.beginPath();c.moveTo(a[0].x,a[0].y);c.lineTo(a[1].x,a[0].y);c.lineTo(a[1].x,a[1].y);c.lineTo(a[0].x,a[1].y);c.closePath();b&&(c.fillStyle=b,c.fill());c.stroke();c.restore()},_doChooseDraw:function(c,b){this._doDraw(c,b)},draw_select:function(c){this.draw_blur(c,this.drawer.blur_canvas)},editPushPoint:function(c){this.points[1].x=c.x;this.points[1].y=c.y;this._calc()}};f.inherit(d._RectBlurDoodle,d._CommonDoodle)})(Diigo.Doodle,
Diigo.$);(function(d,f,c){d._CutDoodle=function(b){1===b.points.length&&b.points.push({x:b.points[0].x,y:b.points[0].y});this.base(d.Type.CUT,b);this.pre_points=c.copyPoints(this.points);this.region_points=c.genPoints(8);this.dash_value=[3,3];this.resetScale();this._create_edit_region();this.__point_in__=!1};d._CutDoodle.prototype={setSize:function(b,a){var c=this.points[0],d=this.points[1];c.x<d.x?d.x=c.x+b:c.x=d.x+b;c.y<d.y?d.y=c.y+a:c.y=d.y+a;this._calc()},_size_callback:function(){var b=this.points,a=
Math.abs(b[1].x-b[0].x),c=Math.abs(b[1].y-b[0].y),d=Math.min(b[0].x,b[1].x),b=Math.min(b[0].y,b[1].y),h=this.drawer.bg_info;this.drawer.style_callback("crop",{left:d,top:b,width:a,height:c,max_width:h.x+h.width-d,max_height:h.y+h.height-b})},checkPointIn:function(b,a){var c=this.boundary;(c=b>=c.left+10&&b<=c.right-10&&a>=c.top+10&&a<=c.bottom+10)&&!this.__point_in__?(this.__point_in__=!0,this.drawer.setCursor_name("cursor_move")):!c&&this.__point_in__&&(this.__point_in__=!1,this.drawer.setCursor_name("cursor_default"))},
onRegionEdit:function(b,a){var c=a.x,d=a.y,h=this.points[0],g=this.points[1];switch(b){case 0:h.x=c;h.y=d;break;case 1:h.y=d;break;case 2:g.x=c;h.y=d;break;case 3:g.x=c;break;case 4:g.x=c;g.y=d;break;case 5:g.y=d;break;case 6:h.x=c;g.y=d;break;case 7:h.x=c}this._calc();this._size_callback()},resetScale:function(){var b=Math.round(3*this.drawer.zoom_scale);this.dash_value[0]=b;this.dash_value[1]=b},_calc:function(){var b=this.points,a=this.region_points;a[0].x=b[0].x;a[0].y=b[0].y;a[1].x=Math.floor((b[0].x+
b[1].x)/2);a[1].y=b[0].y;a[2].x=b[1].x;a[2].y=b[0].y;a[3].x=b[1].x;a[3].y=Math.floor((b[0].y+b[1].y)/2);a[4].x=b[1].x;a[4].y=b[1].y;a[5].x=Math.floor((b[0].x+b[1].x)/2);a[5].y=b[1].y;a[6].x=b[0].x;a[6].y=b[1].y;a[7].x=b[0].x;a[7].y=Math.floor((b[0].y+b[1].y)/2);this._calc_1(this.points)},editPushPoint:function(b){this.points[1].x=b.x;this.points[1].y=b.y;this._calc();this._size_callback()},_create_edit_region:function(){for(var b=0;b<this.region_points.length;b++)this.edit_regions.push(new d.CircleRegion(this,
b,this.region_points[b],7,"pointer"))},editMove:function(b,a){for(var c=0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+b,this.points[c].y=this.pre_points[c].y+a;this._calc()},move:function(b,a){for(var c=0;c<this.points.length;c++)this.points[c].x+=b,this.points[c].y+=a;this._calc()},editStart:function(){c.setPoints(this.pre_points,this.points)},editFinish:function(){this._calc();this._size_callback()},draw:function(b){var a=this.points;b.save();c.setLineDash(b,this.dash_value);
b.beginPath();b.moveTo(a[0].x,a[0].y);b.lineTo(a[1].x,a[0].y);b.lineTo(a[1].x,a[1].y);b.lineTo(a[0].x,a[1].y);b.closePath();b.save();b.fillStyle="black";b.globalCompositeOperation="destination-out";b.fill();b.restore();b.strokeStyle="rgba(0, 128, 255, 0.9)";b.lineWidth=Math.floor(2/this.drawer.zoom_scale);b.stroke();b.restore()},_doDraw:function(b){var a=this.points;b.beginPath();b.moveTo(a[0].x,a[0].y);b.lineTo(a[1].x,a[0].y);b.lineTo(a[1].x,a[1].y);b.lineTo(a[0].x,a[1].y);b.closePath();b.fill()}};
c.inherit(d._CutDoodle,d._Doodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){var b=Math.PI*(10/180);d._CalloutDoodle=function(a){this.center={x:0,y:0};this.radius={a:0,b:0};var b=2*Math.PI*(60/180);this.a_info={angle:0,start:b,end:b,point:{x:0,y:0},border_point:{x:0,y:0}};this.r_point={x:0,y:0};a.region_number=4;a.pen_width=4;this.base(d.Type.CALLOUT,a);this._pre_info={rx:0,ry:0,ax:0,ay:0};this.fill_color=this.color;this.has_shadow=!0;this.child_textbox=d.create(d.Type.INNERTEXT,{points:c.copyPoints(this.points),drawer:this.drawer,editor:this.drawer.textbox_editor,
parent_doodle:this,auto_width:!1})};d._CalloutDoodle.prototype={resetScale:function(){this.child_textbox.resetScale()},setFontName:function(a){this.child_textbox.setFontName(a)},setFontSize:function(a){this.child_textbox.setFontSize(a)},setPenWidth:function(){},setColor:function(a){this.color=a;this.highlight_color=this._calc_highlight_color(a);this.child_textbox.setColor(a)},getRegionUndoCommand:function(){return new f._DoodleCalloutCommand(this)},afterUndoRedo:function(){this._calc();this._calc_a_info();
this._calc_r_point();this.child_textbox.afterUndoRedo();this.drawer._select_doodle(this)},initialize:function(){this.child_textbox.initialize();this.initialized=!0},onRegionEdit:function(a,b){var c=this.points,d=this._calcBeforeMatrixPoint(this.matrix,b.x,b.y),g=d.x,d=d.y;if(0===a)c[0].x=g,c[0].y=d;else if(2===a)c[1].x=g,c[1].y=d;else if(1===a)c[0].y=d,c[1].x=g;else if(3===a)c[0].x=g,c[1].y=d;else if(4===a){var f=Math.min(c[0].x,c[1].x),k=Math.max(c[0].x,c[1].x),r=Math.min(c[0].y,c[1].y),c=Math.max(c[0].y,
c[1].y);if(10<f-g||0<g-k||10<r-d||10<d-c){this.a_info.point.x=g;this.a_info.point.y=d;this._calc_a_info();this._calc_r_point();return}}this._calc();c=this._pre_info;g=Math.floor((g-this.center.x)/c.rx*c.ax);d=Math.floor((d-this.center.y)/c.ry*c.ay);this.a_info.point.x=g+this.center.x;this.a_info.point.y=d+this.center.y;this._calc_a_angle(g,d);this._calc_r_point();this._calc_border_info();this.child_textbox.on_resize_region();this.drawer.edit_doodle.attachDoodle(this)},_calc_a_info:function(){var a=
this.a_info.point.x,b=this.a_info.point.y,c=a-this.center.x,d=b-this.center.y,g=Math.sqrt(c*c+d*d),f=4*c/g,g=4*d/g;this.a_info.angle=Math.atan(this.radius.b/this.radius.a*Math.abs(c/d));this.a_info.border_point.x=0===c?a:a+f;this.a_info.border_point.y=0===d?b:b+g;this._calc_a_angle(c,d)},_calc_border_info:function(){var a=this.a_info.point.x,b=this.a_info.point.y,c=a-this.center.x,d=b-this.center.y,g=Math.sqrt(c*c+d*d);this.a_info.border_point.x=0===c?a:a+4*c/g;this.a_info.border_point.y=0===d?b:
b+4*d/g},_calc_a_angle:function(a,c){var d=this.a_info.angle;0<=a&&0<=c?d=Math.PI/2-d:0<=a&&0>=c?d=1.5*Math.PI+d:0>=a&&0<=c?d=Math.PI/2+d:0>=a&&0>=c&&(d=1.5*Math.PI-d);this.a_info.start=d+b;this.a_info.end=d-b},onRegionEditStart:function(a,b){var c=this._calcBeforeMatrixPoint(this.matrix,b.x,b.y),d=this._pre_info;d.rx=c.x-this.center.x;d.ry=c.y-this.center.y;d.ax=this.a_info.point.x-this.center.x;d.ay=this.a_info.point.y-this.center.y},onRegionEditFinish:function(){},_create_edit_region:function(){this.callBase("_create_edit_region");
this.region_points.push(this.r_point);var a=this.region_points.length-1;this.edit_regions.push(new d.CircleRegion(this,a,this.region_points[a]))},_calc:function(){var a=this.points,b=Math.min(a[0].x,a[1].x),c=Math.max(a[0].x,a[1].x),d=Math.min(a[0].y,a[1].y),a=Math.max(a[0].y,a[1].y);this.center.x=Math.floor((b+c)/2);this.center.y=Math.floor((d+a)/2);this.radius.a=Math.floor((c-b)/2);this.radius.b=Math.floor((a-d)/2);this.callBase("_calc");this.initialized||(this.a_info.point.x=Math.floor(b+0.5*((c-
b)/2)),this.a_info.point.y=Math.floor(a+0.3*((a-d)/2)),this._calc_a_info());this._calc_r_point()},_calc_r_point:function(){var a=this.matrix,b=this.a_info.point.x,c=this.a_info.point.y;this.r_point.x=Math.floor(a[0]*b+a[1]*c+a[2]);this.r_point.y=Math.floor(a[3]*b+a[4]*c+a[5])},draw:function(a){a.save();a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);a.fillStyle=this.highlight_color;a.save();a.shadowOffsetX=1;a.shadowOffsetY=2;a.shadowBlur=3;a.shadowColor=
"rgba(0, 0, 0, 0.5)";a.beginPath();a.ellipse(this.center.x,this.center.y,this.radius.a+4,this.radius.b+4,0,this.a_info.start+0.02,this.a_info.end-0.02,0);a.lineTo(this.a_info.border_point.x,this.a_info.border_point.y);a.closePath();a.fill();a.restore();a.fillStyle=this.color;a.beginPath();a.ellipse(this.center.x,this.center.y,this.radius.a,this.radius.b,0,this.a_info.start,this.a_info.end,0);a.lineTo(this.a_info.point.x,this.a_info.point.y);a.closePath();a.fill();a.restore();this.initialized&&this.child_textbox.draw(a)},
_doDraw:function(a,b){a.save();a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);b&&(a.fillStyle=b);a.beginPath();a.ellipse(this.center.x,this.center.y,this.radius.a,this.radius.b,0,this.a_info.start,this.a_info.end,0);a.lineTo(this.a_info.point.x,this.a_info.point.y);a.closePath();b?a.fill():a.stroke();a.restore()},_doChooseDraw:function(a,b){this._doDraw(a,b)},_doSelectDraw:function(a){},editPushPoint:function(a){this.points[1].x=a.x;this.points[1].y=
a.y;this._calc()}};c.inherit(d._CalloutDoodle,d._MatrixDoodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){d._ListDoodle=function(b){this.center=b.points[0];var a=d._ListDoodle.__LAST_INFO__;b.color=a.color;b.points=[{x:0,y:0},{x:0,y:0}];this.radius={a:a.radius.a,b:a.radius.b};this._calc_points(b.points);this.i_value=a.getValue();this.i_type=a.i_type;this.i_str="";this._get_i_str();a=c.str2rgba(b.color);this.font_color=200<0.299*a.r+0.587*a.g+0.114*a.b?c.rgba2str(0,0,0,a.a):c.rgba2str(255,255,255,a.a);this.border_color=c.rgba2str(255,255,255,a.a);this.font="";this.base(d.Type.LIST,b);
this._pre_rp={x:0,y:0}};d._ListDoodle.__LAST_INFO__={radius:{a:20,b:20},i_type:"number",i_value:1,color:"#000",cursor_cache:{},getValue:function(){return this.i_value++},getCursor:function(){var b=this.cursor_cache[this.i_value];"undefined"===typeof b&&(b=c.getListCursor(this.i_value),this.cursor_cache[this.i_value]=b);return b},reset:function(){this.i_type="number";this.i_value=1;this.radius.a=20;this.radius.b=20}};d._ListDoodle.__WIDTH_CACHE__={w_table:{},h_table:{},get_w:function(b,a,c){var d=
this.w_table[b];"undefined"===typeof d&&(d={},this.w_table[b]=d);var f=d[a];"undefined"===typeof f&&(c.save(),c.font=a+"px Arial",f=c.measureText(b).width,c.restore(),d[a]=f);return f},get_h:function(b){var a=this.h_table[b];"undefined"===typeof a&&(a=Math.floor(c.getFontInfo(b+"px Arial").height),this.h_table[b]=a);return a}};d._ListDoodle.prototype={setPenWidth:function(){},setColor:function(b){this.color=b;b=c.str2rgba(this.color);this.font_color=200<0.299*b.r+0.587*b.g+0.114*b.b?c.rgba2str(0,
0,0,b.a):c.rgba2str(255,255,255,b.a);this.border_color=c.rgba2str(255,255,255,b.a)},set_i_value:function(b){this.i_value=b;this._get_i_str();this._calc_font();this.drawer._paintEditLayer()},_get_i_str:function(){switch(this.i_type){case "number":this.i_str=this.i_value.toString()}},_calc_font:function(){function b(a,b,c){for(var d=Math.floor((b+a)/2),s="w"===c?h:g;;){if(1>=b-d)return d;var t="w"===c?f.get_w(n,d,k):f.get_h(d);if(t>s)b=d;else if(t<s)a=d;else return d;d=Math.floor((b+a)/2)}}for(var a=
Math.asin(1)/2,c=this.radius.a*Math.cos(a),a=this.radius.b*Math.sin(a),f=d._ListDoodle.__WIDTH_CACHE__,h=Math.floor(2*c),g=Math.floor(2*a),c=100,n=this.i_str,k=this.drawer.t_ctx;f.get_w(n,c,k)<h&&f.get_h(c)<g;)c*=2;f.get_w(n,c,k)>h&&(c=b(1,c,"w"));f.get_h(c)>g&&(c=b(1,c,"h"));this.font=c+"px Arial"},_calc_points:function(b){var a=this.center,c=this.radius;b[0].x=a.x-c.a;b[0].y=a.y-c.b;b[1].x=a.x+c.a;b[1].y=a.y+c.b},onRegionEdit:function(b,a){var c=this.points;this._onRegionEdit(b,a,c);var d=Math.round(Math.abs(c[0].x-
c[1].x)/2),c=Math.round(Math.abs(c[0].y-c[1].y)/2);this.radius.a=this.radius.b=Math.min(d,c);this._calc_points(this.points);this._calc();this.drawer.edit_doodle.attachDoodle(this)},onRegionEditStart:function(b,a){this._pre_rp.x=a.x;this._pre_rp.y=a.y},onRegionEditFinish:function(b,a){var c=d._ListDoodle.__LAST_INFO__;c.radius.a=this.radius.a;c.radius.b=this.radius.b},_calc:function(){var b=this.points;this.center.x=Math.round((b[0].x+b[1].x)/2);this.center.y=Math.round((b[0].y+b[1].y)/2);this.radius.a=
Math.round(Math.abs(b[0].x-b[1].x)/2);this.radius.b=Math.round(Math.abs(b[0].y-b[1].y)/2);this.callBase("_calc");this._calc_font()},_doDraw:function(b,a){b.save();b.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);c.drawEllipse(b,this.center.x,this.center.y,this.radius.a,this.radius.b,a);b.restore()},draw:function(b){var a=this.center.x,c=this.center.y,d=this.radius.a,f=this.radius.b;b.save();b.transform(this.matrix[0],this.matrix[3],this.matrix[1],
this.matrix[4],this.matrix[2],this.matrix[5]);b.save();b.fillStyle=this.border_color;b.lineWidth=4;b.shadowColor="rgba(0, 0, 0, 0.4)";b.shadowOffsetX=0;b.shadowOffsetY=2;b.shadowBlur=4;b.beginPath();b.ellipse(a,c,d+4,f+4,0,0,2*Math.PI,0);b.closePath();b.fill();b.restore();b.fillStyle=this.color;b.beginPath();b.ellipse(a,c,d,f,0,0,2*Math.PI,0);b.closePath();b.fill();b.font=this.font;b.fillStyle=this.font_color;b.textAlign="center";b.textBaseline="middle";b.fillText(this.i_str,this.center.x,this.center.y);
b.restore()},_doChooseDraw:function(b,a){this._doDraw(b,a)},_doSelectDraw:function(b){},editPushPoint:function(b){}};c.inherit(d._ListDoodle,d._MatrixDoodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){d._BezierArrowDoodle=function(b){1===b.points.length?b.points.push({x:0,y:0},{x:0,y:0},{x:b.points[0].x,y:b.points[0].y}):2===b.points.length&&b.points.splice(1,0,{x:0,y:0},{x:0,y:0});this.rotate_point={x:0,y:0};this.arrow_info={idx:0,pos:{}};this.base(d.Type.BEZIER_ARROW,b);this.region_points=this.points;this._create_edit_region()};d._BezierArrowDoodle.prototype={setPenWidth:function(b){this.callBase("setPenWidth",b);this._calc_arrow()},_calc:function(){this._calc_1(this.points);
this._calc_arrow()},draw:function(b){var a=this.drawer.t_ctx,c=this.drawer.bg_info;a.save();a.fillStyle=this.color;a.strokeStyle=this.color;a.lineWidth=this.pen_width;a.clearRect(c.x,c.y,c.width,c.height);this._doDraw(a);a.restore();b.save();b.setTransform(1,0,0,1,0,0);b.drawImage(a.canvas,0,0);b.restore()},_calc_arrow:function(){var b=this.points,a=5*this.pen_width;this.arrow_info.idx=c.getPTPRange(b[0],b[3])>a?1:0;this.arrow_info.pos=c.calcArrow(b[2].x,b[2].y,b[3].x,b[3].y,a)},_doDraw:function(b,
a){var c=this.points,d=this.arrow_info,f=d.pos,g=0===d.idx;b.beginPath();g?(b.beginPath(),b.moveTo(f.ax,f.ay),b.lineTo(f.dx,f.dy),b.lineTo(f.bx,f.by),b.closePath(),b.fill()):(b.moveTo(c[0].x,c[0].y),b.bezierCurveTo(c[1].x,c[1].y,c[2].x,c[2].y,d.pos.cx,d.pos.cy),a?(b.lineTo(f.ax,f.ay),b.lineTo(f.dx,f.dy),b.lineTo(f.bx,f.by),b.lineTo(f.cx,f.cy),b.stroke()):(b.stroke(),b.closePath(),b.beginPath(),b.moveTo(f.ax,f.ay),b.lineTo(f.dx,f.dy),b.lineTo(f.bx,f.by),b.closePath(),b.save(),b.globalCompositeOperation=
"destination-out",b.fillStyle="black",b.fill(),b.restore(),b.fill()))},_doSelectDraw:function(b){var a=this.points;b.save();b.lineWidth=2;c.setLineDash(b,[8,5]);b.strokeStyle=this.highlight_color;b.shadowBlur=3;b.shadowColor="rgba(0,0,0,0.4)";b.shadowOffsetX=0;b.shadowOffsetY=1;b.beginPath();b.moveTo(a[0].x,a[0].y);b.lineTo(a[1].x,a[1].y);b.lineTo(a[2].x,a[2].y);b.lineTo(a[3].x,a[3].y);b.stroke();b.closePath();b.restore();this._doDraw(b,!0)},_doChooseDraw:function(b,a){this._doDraw(b,!1)},editPushPoint:function(b){var a=
this.points;a[3].x=b.x;a[3].y=b.y;b=Math.floor((a[3].x-a[0].x)/3);var c=Math.floor((a[3].y-a[0].y)/3);a[1].x=a[0].x+b;a[1].y=a[0].y+c;a[2].x=a[1].x+b;a[2].y=a[1].y+c;this._calc()},getRegionUndoCommand:function(){return new f._DoodlePointsCommand(this)},onRegionEdit:function(b,a){this.points[b].x=a.x;this.points[b].y=a.y;this._calc();this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(b,a){this.drawer.edit_doodle.attachDoodle(this)}};c.inherit(d._BezierArrowDoodle,d._CommonDoodle)})(Diigo.Doodle,
Diigo.UndoRedo,Diigo.$);(function(d,f,c){d._ImageDoodle=function(b){this.img=b.image;this.img_width=b.width;this.img_height=b.height;this.img_info={w:0,h:0};b.region_number=8;this.base(d.Type.IMAGE,b);this.choose_type="full"===b.choose_type?1:0};d._ImageDoodle.prototype={_onRegionEdit:function(b,a,c){c=this._calcBeforeMatrixPoint(this.matrix,a.x,a.y);a=c.x;c=c.y;var d=this.points[0],f=this.points[1];switch(b){case 0:d.x=a;d.y=c;break;case 1:d.y=c;break;case 2:f.x=a;d.y=c;break;case 3:f.x=a;break;case 4:f.x=a;f.y=c;break;
case 5:f.y=c;break;case 6:d.x=a;f.y=c;break;case 7:d.x=a}},_calc_info:function(){var b=this.points,a=Math.abs(b[0].x-b[1].x),b=Math.abs(b[0].y-b[1].y);this.img_info.w=a;this.img_info.h=b},_calc:function(){this.callBase("_calc");this._calc_info()},_doDraw:function(b,a){var c=this.points;b.save();b.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);b.beginPath();b.moveTo(c[0].x,c[0].y);b.lineTo(c[1].x,c[0].y);b.lineTo(c[1].x,c[1].y);b.lineTo(c[0].x,
c[1].y);b.closePath();null!==a&&(b.fillStyle=a,b.fill());b.stroke();b.restore()},draw_select:function(b){b.save();c.setLineDash(b,[4,4]);b.strokeStyle="rgba(0, 0, 0, 0.6)";b.lineWidth=2;this._doDraw(b,null);b.restore();this.draw(b)},draw_choose:function(b,a){var d=c.int2color(a);if(0!==this.choose_type||this.selected)b.strokeStyle=d,b.fillStyle=d,b.lineWidth=Math.round(1.5*this.pen_width),this._doChooseDraw(b,d);else{var f=this.drawer.t_ctx,h=this.drawer.bg_info;f.save();f.fillStyle=d;f.fillRect(h.x,
h.y,h.width,h.height);f.globalCompositeOperation="destination-in";this.draw(f);f.restore();b.save();b.setTransform(1,0,0,1,0,0);b.drawImage(f.canvas,0,0);b.restore()}},draw:function(b){var a=this.points;b.save();b.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]);b.drawImage(this.img,0,0,this.img_width,this.img_height,a[0].x,a[0].y,this.img_info.w,this.img_info.h);b.restore()},editPushPoint:function(b){var a=this.points[0],c=this.points[1],d=b.x-
a.x,f=Math.abs(d);b=b.y-a.y;var g=Math.abs(b),n=this.img_width/this.img_height;f/this.img_width>g/this.img_height?(f=g,g*=n):(g=f,f/=n);c.x=a.x+Math.floor(0<d?g:-g);c.y=a.y+Math.floor(0<b?f:-f);this._calc()}};c.inherit(d._ImageDoodle,d._MatrixDoodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f){d._Command=function(){};d._Command.prototype={undo:function(){throw"abstract method";},redo:function(){throw"abstract method";},toString:function(){return"undo-redo-command"},finish:function(){}};d._CombineCommand=function(){this.cmd_array=[]};d._CombineCommand.prototype={add:function(c){this.cmd_array.push(c)},undo:function(){for(var c=this.cmd_array.length-1;0<=c;c--)this.cmd_array[c].undo()},redo:function(){for(var c=0;c<this.cmd_array.length;c++)this.cmd_array[c].redo()},toString:function(){return this.cmd_array.join(",")},
finish:function(){for(var c=this.cmd_array.length-1;0<=c;c--)this.cmd_array[c].finish()}};f.inherit(d._CombineCommand,d._Command);d._UndoRedoManager=function(c){this.drawer=c;this.cmd_array=[];this.cmd_index=-1;this.cmd_size=0;this.MAX_NUM=99999999};d._UndoRedoManager.prototype={add:function(c){this.cmd_index+1<this.MAX_NUM?(this.cmd_index++,this.cmd_array[this.cmd_index]=c,this.cmd_size=this.cmd_index+1):(this.cmd_array.shift(),this.cmd_array.push(c));this.drawer._ur_back()},undo:function(){0<=this.cmd_index&&
(this.cmd_array[this.cmd_index--].undo(),this.drawer.paint(),this.drawer._ur_back())},canUndo:function(){return 0<=this.cmd_index},canRedo:function(){return this.cmd_index+1<this.cmd_size},redo:function(){this.cmd_index+1<this.cmd_size&&(this.cmd_array[++this.cmd_index].redo(),this.drawer.paint(),this.drawer._ur_back())},reset:function(){this.cmd_index=-1;this.cmd_size=0;this.cmd_array.length=0;this.drawer._ur_back()},clear:function(){this.reset()}};d._DoodleCalloutCommand=function(c){this.doodle=
c;this.ps=f.copyPoints(c.points);this.cs=f.copyPoints(this.ps);this.pa={x:c.a_info.point.x,y:c.a_info.point.y};this.ca={x:0,y:0}};d._DoodleCalloutCommand.prototype={_v:function(c,b){f.setPoints(this.doodle.points,c);this.doodle.a_info.point.x=b.x;this.doodle.a_info.point.y=b.y;this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps,this.pa)},redo:function(){this._v(this.cs,this.ca)},finish:function(){f.setPoints(this.cs,this.doodle.points);this.ca.x=this.doodle.a_info.point.x;this.ca.y=this.doodle.a_info.point.y}};
f.inherit(d._DoodleCalloutCommand,d._Command);d._DoodleTextCommand=function(c,b,a){this.doodle=c;this.ps=b;this.cs=a};d._DoodleTextCommand.prototype={_v:function(c){this.doodle.setURText(c);this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)}};f.inherit(d._DoodleTextCommand,d._Command);d._CropCommand=function(c){this.drawer=c;c=this.drawer.bg_info;this.ps={x:c.x,y:c.y,w:c.width,h:c.height};this.cs=null};d._CropCommand.prototype={_v:function(c){this.drawer.set_bg_info(c)},
undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)},finish:function(){var c=this.drawer.bg_info;this.cs={x:c.x,y:c.y,w:c.width,h:c.height}}};f.inherit(d._CropCommand,d._Command);d._SizeCommand=function(c){this.drawer=c;c=this.drawer.bg_info;this.img=document.createElement("canvas");this.ps={x:c.x,y:c.y,width:c.width,height:c.height};this.ds=[];this.cs=null;this._init()};d._SizeCommand.prototype={_init:function(){var c=this.img.getContext("2d");this.img.width=this.drawer.image_canvas.width;
this.img.height=this.drawer.image_canvas.height;c.drawImage(this.drawer.image_canvas,0,0);[].push.apply(this.ds,this.drawer.page.doodle_array)},undo:function(){this.drawer._set_image_size_undo(this.img,this.ps,this.ds)},redo:function(){this.drawer._set_image_size_redo(this.cs.width,this.cs.height)},finish:function(){var c=this.drawer.bg_info;this.cs={x:c.x,y:c.y,width:c.width,height:c.height}}};f.inherit(d._SizeCommand,d._Command)})(Diigo.UndoRedo,Diigo.$);(function(d,f){d._DoodleColorCommand=function(c,b,a){this.doodle=c;this.ps=b;this.cs=a};d._DoodleColorCommand.prototype={undo:function(){this.doodle.setColor(this.ps)},redo:function(){this.doodle.setColor(this.cs)}};f.inherit(d._DoodleColorCommand,d._Command);d._DoodleWidthCommand=function(c,b,a){this.doodle=c;this.ps=b;this.cs=a};d._DoodleWidthCommand.prototype={undo:function(){this.doodle.setPenWidth(this.ps)},redo:function(){this.doodle.setPenWidth(this.cs)}};f.inherit(d._DoodleWidthCommand,d._Command);
d._DoodleNewCommand=function(c){this.doodle=c};d._DoodleNewCommand.prototype={undo:function(){this.doodle.drawer._removeDoodle(this.doodle)},redo:function(){this.doodle.drawer._ur_insert(this.doodle)}};f.inherit(d._DoodleNewCommand,d._Command);d._DoodleDelCommand=function(c){this.doodle=c};d._DoodleDelCommand.prototype={undo:function(){this.doodle.drawer._ur_insert(this.doodle)},redo:function(){this.doodle.drawer._removeDoodle(this.doodle)},toString:function(){return"doodle-command"}};f.inherit(d._DoodleDelCommand,
d._Command);d._DoodlePointsCommand=function(c,b,a){this.doodle=c;this.ps=b?b:f.copyPoints(c.points);this.cs=a?a:f.copyPoints(this.ps)};d._DoodlePointsCommand.prototype={undo:function(){f.setPoints(this.doodle.points,this.ps);this.doodle.afterUndoRedo()},redo:function(){f.setPoints(this.doodle.points,this.cs);this.doodle.afterUndoRedo()},finish:function(){f.setPoints(this.cs,this.doodle.points)}};f.inherit(d._DoodlePointsCommand,d._Command);d._DoodleMatrixCommand=function(c,b,a){this.doodle=c;this.ps=
b?b:f.copyArray(c.matrix);this.cs=a?a:f.copyArray(this.ps)};d._DoodleMatrixCommand.prototype={undo:function(){f.setArray(this.doodle.matrix,this.ps);this.doodle.afterUndoRedo()},redo:function(){f.setArray(this.doodle.matrix,this.cs);this.doodle.afterUndoRedo()},finish:function(){f.setArray(this.cs,this.doodle.matrix)}};f.inherit(d._DoodleMatrixCommand,d._Command)})(Diigo.UndoRedo,Diigo.$);(function(d,f,c){function b(a,b){var d=c.str2rgba(a);d.a=b;return"rgba("+d.r+","+d.g+","+d.b+","+d.a+")"}c.extend(d._Drawer.prototype,{_check_region_mouse_down:function(a){var b=this.__pre_mouse_enter_region__;return null!==b?(b.onMouseDown(a),this.__tmp_undo_command__=b.doodle.getRegionUndoCommand(b),!0):!1},_pointChooseDoodle:function(a){var b=this.page.doodle_array;a=this.c_ctx.getImageData(a.ox,a.oy,1,1).data;if(10>a[3])return null;a=c.color2int(a);return a===b.length?this.cut_doodle?this.cut_doodle:
null:0<=a?b[a]?b[a]:null:null},_getEventPoint:function(a){null===this.out_pos&&(this.out_pos=c.getDomPosition(this.out_container));a={x:a.pageX,y:a.pageY};var b=this.zoom_scale,d=this.bg_info;a.sx=a.x;a.sy=a.y;a.cx=a.x-this.out_pos.left;a.cy=a.y-this.out_pos.top;a.ox=a.cx-this.container.offsetLeft+this.out_container.scrollLeft;a.oy=a.cy-this.container.offsetTop+this.out_container.scrollTop;a.x=Math.floor(a.ox/b+d.x);a.y=Math.floor(a.oy/b+d.y);return a},_mouse_up_handler:function(a){if(this.__left_mouse_db_down__)this._mouse_double_down(),
this.__left_mouse_down__=this.__left_mouse_db_down__=!1;else if(this.__left_mouse_down__){this.__left_mouse_down__=!1;var b=this._getEventPoint(a);this._mouse_up(b);this._select_back();c.delMouseEvent(window,this.__saved_handler.mouse_move);c.delMouseEvent(window,this.__saved_handler.mouse_up);c.stopEvent(a)}},_check_region_mouse_in_out:function(a){function b(a,c,d){for(var f=0;f<a.edit_regions.length;f++)if(a.edit_regions[f].isPointIn(c,d))return a.edit_regions[f];return null}var c=this.__pre_mouse_enter_region__,
d=null,f=this.page.doodle_array;if(this.has_selected_doodle){if(null!==this.cut_doodle)d=b(this.cut_doodle,a,this.zoom_scale);else if(d=b(this.edit_doodle,a,this.zoom_scale),null===d)for(var n=0;n<f.length;n++){var k=b(f[n],a,this.zoom_scale);if(null!==k){d=k;break}}d!==c&&(null!==c&&(c.onMouseOut(),this._paintEditLayer()),null!==d?(d.onMouseIn(),this.setCursor_name(d.cursor),this._paintEditLayer()):2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor),
this.__pre_mouse_enter_region__=d)}},_mouse_move_handler:function(a){if(this.__left_mouse_down__){var b=this._getEventPoint(a),d=this.__pre_mouse_enter_region__;null!==d?(d.onMouseMove(b),this._adjust_scroll(b.x,b.y),this._paintEditLayer()):10<c.getPTPRange(this.__mouse_down_point__,b)&&this._mouse_move(b);c.stopEvent(a)}},_region_handler:function(a){a=this._getEventPoint(a);this.__left_mouse_down__||(this._check_region_mouse_in_out(a),null===this.__pre_mouse_enter_region__&&(a=this._pointChooseDoodle(a),
null!==a&&(this.style.brush_type!==d.Type.RECT_BLUR&&a.type===d.Type.RECT_BLUR)&&(a=null),null!==a&&this.__hover_doodle__!==a?(this.__hover_doodle__=a,this.setCursor_name("cursor_move")):null===a&&null!==this.__hover_doodle__&&(this.__hover_doodle__=null,2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor))))},_mouse_down_handler:function(a){if(!this.__left_mouse_down__&&0===a.button){this.__left_mouse_down__=!0;this.__left_mouse_db_down__=!1;var b=this._getEventPoint(a);
this.__mouse_down_point__=b;1===this.__mouse_down_time__&&10>c.getPTPRange(this.__pre_point__,b)?(this.__mouse_down_time__=0,null!==this.__mdt_timeout__&&(window.clearTimeout(this.__mdt_timeout__),this.__mdt_timeout__=null),this.__left_mouse_db_down__=!0):(this.__pre_point__=b,this.__mouse_down_time__++,this.__mdt_timeout__=window.setTimeout(this.__mdt_delegate__,450),this._mouse_down(b));this.__saved_handler.mouse_move=c.addMouseEvent(window,"mousemove",this.__cmv_handler);this.__saved_handler.mouse_up=
c.addMouseEvent(window,"mouseup",this.__cmu_handler);c.stopEvent(a)}},initEvent:function(){this.__draw_point__=this.__left_mouse_db_down__=this.__left_mouse_down__=!1;this.__hover_doodle__=null;this.__cmv_handler=c.createDelegate(this,this._mouse_move_handler);this.__cmu_handler=c.createDelegate(this,this._mouse_up_handler);this.__saved_handler={mouse_move:null,mouse_up:null};this.__mouse_down_time__=0;this.__mdt_timeout__=null;this.__mdt_delegate__=c.createDelegate(this,function(){this.__mouse_down_time__=
0;this.__mdt_timeout__=null;this.__left_mouse_db_down__=!1});c.addMouseEvent(this.edit_canvas,"mousedown",c.createDelegate(this,this._mouse_down_handler));c.addEvent(this.edit_canvas,"mousemove",c.createDelegate(this,this._region_handler));this.__pre_point__={x:0,y:0};this.$list_input.attr({min:1,max:999999}).on("mousedown",function(a){a.stopPropagation()}).on("keypress",function(a){(47>a.keyCode||58<a.keyCode)&&a.preventDefault()}).on("input",c.createDelegate(this,this._list_input_handler)).data("doodle",
null);c.addEvent(window,"resize",c.createDelegate(this,this._on_resize))},_on_resize:function(){this.container.style.top=this.out_container.offsetHeight>this.container.offsetHeight+40?"40px":"0px"},_list_input_handler:function(){var a=this.$list_input.data("doodle"),b=Number(this.$list_input.val());if(1>b||999999<b)b=this.$list_input.data("pre_value");a.set_i_value(b)},_show_list_dialog:function(a){var b=this.$list_input,c=this.$list_dialog,d=b.data("doodle");b.data("doodle",a);b.data("pre_value",
a.i_value);b.val(a.i_value);a=a.boundary;var f=this.bg_info.x,n=this.bg_info.y,k=this.zoom_scale,f=Math.round((a.left+(a.width-c.innerWidth()/k)/2-f)*k);a=Math.round((a.bottom-n)*k)+15;null===d?c.css({left:f,top:a}).fadeIn(200,function(){b.focus()}):c.animate({left:f,top:a},200)},_hide_list_dialog:function(){null!==this.$list_input.data("doodle")&&(this.$list_dialog.hide(),this.$list_input.data("doodle",null));this.style_callback("mousedown")},hideListDialog:function(){null!==this.$list_input.data("doodle")&&
(this.$list_dialog.hide(),this.$list_input.data("doodle",null))},_mouse_double_down:function(){var a=this.__hover_doodle__;if(null!==a){var b=d.Type;a.type===b.LIST?this._show_list_dialog(a):a.type===b.TEXT?(this.cur_textbox=a,this.activeTextbox()):a.type===b.CALLOUT&&(this.cur_textbox=a.child_textbox,this.activeInnerTextbox())}},_mouse_down:function(a){this._hide_list_dialog();var b=d.Type,c=this.style.brush_type;if(!this._check_region_mouse_down(a)){var f=null,g=this.page.doodle_array;if(null!==
this.cur_textbox&&(this.unactiveTextbox(),this.paint(),c===b.CALLOUT||c===b.TEXT))return;this.temp_doodle=null;var n;if(this.has_selected_doodle)a:{for(n=0;n<g.length;n++)if(g[n].selected){n=g[n];break a}n=null}else n=null;var k=n;n=this.__hover_doodle__;null===n&&c===b.LIST&&null===k?(c=d.create(b.LIST,{points:[this.__pre_point__],drawer:this}),this.insertDoodle(c),this.default_cursor=d._ListDoodle.__LAST_INFO__.getCursor(),this.setCursor_name("cursor_move"),n=this.__hover_doodle__=c):null===n&&
(c===b.TEXT&&null===k)&&(this.temp_doodle=d.create(b.TEXT,{points:[this.__pre_point__],drawer:this}));if(null!==n){for(c=0;c<g.length;c++)!0===g[c].selected&&(f=g[c]),g[c].selected=!1,g[c].setRegionDisabled(!0);this.has_selected_doodle=n.selected=!0;this.edit_doodle.attachDoodle(n);this.edit_doodle.editStart(a);null!==this.cut_doodle?this.cut_doodle.editStart():(this.__tmp_undo_command__=n.getMoveUndoCommand(),n.editStart());this._paintDoodleLayer();this._paintEditLayer();n.type!==b.RECT_BLUR||null!==
f&&f.type===b.RECT_BLUR||this._prepare_for_blur()}else null===this.temp_doodle&&(this.__draw_point__=this.style.brush_type===b.CURVE&&!1===this.has_selected_doodle?!0:!1,this._select_nothing(),this.edit_doodle.attachNothing(),this._paintDoodleLayer())}},_move_doodle_to_top:function(a){var b=this.page.doodle_array,c=b.indexOf(a);0<=c&&(b.splice(c,1),b.unshift(a))},_mouse_up:function(a){var f=this.__pre_mouse_enter_region__,v=d.Type,h=d._ListDoodle.__LAST_INFO__;null!==f?(f.onMouseUp(a),f.is_changed&&
(null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null),this.paint()),this.__pre_mouse_enter_region__=null):(f=this.__hover_doodle__,null!==f?(this.edit_doodle.editFinish(a),f.editFinish(),this._move_doodle_to_top(f),null!==this.__tmp_undo_command__&&10<c.getPTPRange(this.__pre_point__,a)&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__)),this.__tmp_undo_command__=null,null!==
this.cut_doodle&&this.cut_doodle.editFinish(),f.type===v.RECT_BLUR?this._finish_for_blur():f.type===v.LIST&&(h.radius.a=f.radius.a,h.radius.b=f.radius.b),this.paint()):this.cut_mode?(this.cut_doodle=this.temp_doodle,this.temp_doodle=null,this.has_selected_doodle=this.cut_doodle.selected=!0,this.edit_doodle.attachDoodle(this.cut_doodle),this.paint()):(a=this.temp_doodle,null===a?(a=this.style,this.__draw_point__&&(a=d.create(v.CURVE,{drawer:this,pen_width:a.pen_width,line_type:a.dot_type|a.arrow_type,
color:b(a.color,a.pen_opacity),points:[this.__pre_point__]}),a.initialize(),this.insertDoodle(a)),this.paint()):(a.editFinish(),h=a.type,a=this.temp_doodle,h===v.TEXT?(a.auto_width=30>Math.abs(a.points[1].x-a.points[0].x),a.initialize(),this.insertDoodle(a),this.cur_textbox=a,this._select_doodle(a)):h===v.CALLOUT?(a.initialize(),this.insertDoodle(a),this.cur_textbox=a.child_textbox,this._select_doodle(a)):h===v.BEZIER_ARROW?(a.initialize(),this.insertDoodle(a),this._select_doodle(a)):h===v.IMAGE?
(f=a.points,10>Math.abs(f[0].x-f[1].x)&&10>Math.abs(f[0].x-f[1].x)&&a.editPushPoint({x:f[0].x+150,y:f[0].y+150}),a.initialize(),this.insertDoodle(a)):h!==v.CUT&&(a.initialize(),this.insertDoodle(a),h===v.RECT_BLUR&&this._finish_for_blur()),this.temp_doodle=null,this._paintEditLayer(),h===v.TEXT?this.activeTextbox():h===v.CALLOUT?this.activeInnerTextbox():h!==v.CUT&&this.paint())))},_adjust_scroll:function(a,b){var c=this.out_container,d=c.scrollLeft,f=c.scrollTop,n=c.offsetWidth,k=c.offsetHeight,
r=this.bg_info,l=this.zoom_scale,p=Math.floor((b-30-r.y)*l),m=Math.floor((b+30-r.y)*l),q=m-f,t=Math.floor((a-r.x-30)*l)-30,y=t-d,u=Math.floor((a+30-r.x)*l),d=u-d;0>p-f?c.scrollTop=Math.max(0,p):q>k&&(c.scrollTop=Math.min(m-k,Math.floor(r.height*l-k)));0>y?c.scrollLeft=Math.max(0,t):d>n&&(c.scrollLeft=Math.min(Math.floor(r.width*l-n),u-n))},_mouse_move:function(a){var c=this.__hover_doodle__;if(null!==c){var f=this.edit_doodle.editMove(a);c.editMove(f.x,f.y);null!==this.cut_doodle&&this.cut_doodle.editMove(f.x,
f.y);this._adjust_scroll(a.x,a.y)}else if(null===this.temp_doodle){var c=this.style,f=c.brush_type,h=this.__pre_point__;null!==this.cut_doodle&&(this.cut_doodle=null);f!==d.Type.TEXT&&f!==d.Type.LIST&&(f===d.Type.IMAGE?this.temp_doodle=d.create(f,{drawer:this,image:this.style.svg_image,points:[h,a]}):(this.temp_doodle=d.create(f,{drawer:this,pen_width:c.pen_width,line_type:c.dot_type|c.arrow_type,color:b(c.color,c.pen_opacity),points:[h,a]}),f===d.Type.RECT_BLUR&&this._prepare_for_blur()))}else this.temp_doodle.editPushPoint(a),
this._adjust_scroll(a.x,a.y);this._paintEditLayer()}})})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){d._EditDoodle=function(b){this.base(d.Type.EDITHELPER,{drawer:b,points:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],color:"rgba(123,123,123,0.5)"});this.pre_points=c.copyPoints(this.points);this.selected_doodle=null;this.center={x:0,y:0};this.pre_point={x:0,y:0};this.inter_point={x:0,y:0};this.edit_regions.push(new d.TipRegion(this,0,this.points[4]));this.tip_region=this.edit_regions[0];this.tip_region.disabled=!0;this.__tmp_undo_command__=null};d._EditDoodle.prototype={getRegionUndoCommand:function(){return this.__tmp_undo_command__},
onRegionEdit:function(b,a){if(0===b){var c=this.editRotateScale(a);this.selected_doodle.editRotateScale(this.center,c.rotate,c.scale);this._set_rotate_point()}},onRegionEditStart:function(b,a){var c=this.selected_doodle;this.__tmp_undo_command__=c.getRotateUndoCommand();c.editStart(a);this.pre_point.x=a.x;this.pre_point.y=a.y;this.inter_point.x=a.x;this.inter_point.y=a.y},onRegionEditFinish:function(b,a){this.selected_doodle.editFinish();null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),
this.drawer.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null);this._calc();this._set_rotate_point()},attachDoodle:function(b){var a=this.points,c=b.boundary;a[0].x=c.left;a[0].y=c.top;a[1].x=c.right;a[1].y=c.top;a[2].x=c.right;a[2].y=c.bottom;a[3].x=c.left;a[3].y=c.bottom;b.setRegionDisabled(!1);this.selected_doodle=b;this._calc();this._set_rotate_point()},_re_attach_doodle:function(){null!==this.selected_doodle&&this.attachDoodle(this.selected_doodle)},_set_rotate_point:function(){if(null!==
this.selected_doodle){var b=this.selected_doodle.getRotatePoint();null!==b?(this.points[4].x=b.x,this.points[4].y=b.y,this.tip_region.disabled=!1):this.tip_region.disabled=!0}},attachNothing:function(){this.selected_doodle=null;this.tip_region.disabled=!0},_calc:function(){var b=this.points;this.center.x=Math.floor((b[0].x+b[2].x)/2);this.center.y=Math.floor((b[0].y+b[2].y)/2)},editStart:function(b){c.setPoints(this.pre_points,this.points);this._calc();this.pre_point.x=b.x;this.pre_point.y=b.y},editMove:function(b){b=
{x:b.x-this.pre_point.x,y:b.y-this.pre_point.y};for(var a=0;a<this.points.length;a++)this.points[a].x=this.pre_points[a].x+b.x,this.points[a].y=this.pre_points[a].y+b.y;return b},_editFinish:function(){this._calc();this.drawer.onChange()},editFinish:function(b){this._editFinish();return{x:b.x-this.pre_point.x,y:b.y-this.pre_point.y}},editRotateScale:function(b){return this._calcRSValue(b)},_calcRSValue:function(b){var a=b.x-this.center.x;b=b.y-this.center.y;var c=this.pre_point.x-this.center.x,d=
this.pre_point.y-this.center.y,f=Math.sqrt(a*a+b*b),g=Math.sqrt(c*c+d*d),n=(a*c+b*d)/(f*g),k=Math.acos(n);1E-7>=Math.abs(n-1)?k=0:1E-7>=Math.abs(n+1)?k=Math.PI:0<a*d-c*b&&(k=2*Math.PI-k);return{scale:f/g,rotate:k}}};c.inherit(d._EditDoodle,d._Doodle)})(Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c){f.EventRegion=function(b,a,c){this.doodle=b;this.idx=a;this.is_changed=this.is_mouse_in=!1;this.cursor=c?"cursor_"+c:"cursor_pointer";this.disabled=!0};f.EventRegion.prototype={isPointIn:function(b){return!1},isPointIn_xy:function(b,a){return!1},onMouseIn:function(){this.is_mouse_in=!0},onMouseOut:function(){this.is_mouse_in=!1},onMouseDown:function(b){this.is_changed=!1;this.doodle.onRegionEditStart(this.idx,b)},onMouseMove:function(b){this.doodle.onRegionEdit(this.idx,b);this.is_changed=
!0},onMouseUp:function(b){this.doodle.onRegionEditFinish(this.idx,b)},draw:function(b,a){},editDraw:function(b,a,c){this.doodle.draw_region(b,a,c)}};f.CircleRegion=function(b,a,c,d,f){this.base(b,a,f);this.center=c;this.radius="undefined"===typeof d?7:d};f.CircleRegion.prototype={isPointIn:function(b){return this.disabled?!1:c.getPTPRange(this.center,b)<=this.radius},draw:function(b,a){b.save();b.strokeStyle="rgba(0,0,0,0.1)";b.lineWidth=1;b.save();b.shadowColor="rgba(0,0,0,0.25)";b.shadowBlur=4;
b.shadowOffsetX=0;b.shadowOffsetY=2;b.beginPath();b.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1);b.stroke();b.closePath();b.fillStyle="#fff";b.fill();b.restore();var c=this.center.x-this.radius+2,d=this.center.y-this.radius+2,c=b.createLinearGradient(c,d,c,d+2*(this.radius-2));c.addColorStop(0,"#09f");c.addColorStop(1,"#07f");b.fillStyle=c;b.beginPath();b.arc(this.center.x,this.center.y,this.radius-2,0,2*Math.PI,!1);b.closePath();b.fill();b.restore()}};c.inherit(f.CircleRegion,f.EventRegion);
f.TipRegion=function(b,a,c){this.base(b,a,c,5,"rotation")};f.TipRegion.prototype={isPointIn:function(b){return this.disabled?!1:c.getPTPRange(this.center,b)<=this.radius},isPointIn_xy:function(b,a){return this.disabled?!1:c.getPTPRange_xy(this.center.x,this.center.y,b,a)<=this.radius},draw:function(b,a){this.disabled||(b.save(),b.strokeStyle="rgba(0,0,0,0.2)",b.lineWidth=2,b.save(),b.shadowColor="rgba(0,0,0,0.15)",b.shadowBlur=3,b.shadowOffsetX=0,b.shadowOffsetY=1,b.beginPath(),b.arc(this.center.x,
this.center.y,this.radius,0,2*Math.PI,!1),b.stroke(),b.closePath(),b.fillStyle="#fff",b.fill(),b.restore(),b.fillStyle="#080",b.beginPath(),b.arc(this.center.x,this.center.y,this.radius-1,0,2*Math.PI,!1),b.closePath(),b.fill(),b.restore())}};c.inherit(f.TipRegion,f.CircleRegion)})(Diigo.Text,Diigo.Doodle,Diigo.$);(function(d,f){var c=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,
287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,
275,273,271,269,267,265,263,261,259],b=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,
23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];f.stackBlurCanvasRGBA=function(a,d,f,h,g,n){var k=a.getImageData(d,f,h,g);n="undefined"===typeof n?7:n;var r=k.data,l,p,m,q,t,y,u,w,z,A,K,J,C,E,F,G,H,I,L,M,N,B,O;l=n+n+1;var T=h-1,U=g-1,D=n+1,P=D*(D+
1)/2,S={r:0,g:0,b:0,a:0,next:null},x=S;for(m=1;m<l;m++)if(x=x.next={r:0,g:0,b:0,a:0,next:null},m==D)var V=x;x.next=S;x=m=null;y=t=0;var Q=c[n],R=b[n];for(p=0;p<g;p++){F=G=H=I=u=w=z=A=0;K=D*(L=r[t]);J=D*(M=r[t+1]);C=D*(N=r[t+2]);E=D*(B=r[t+3]);u+=P*L;w+=P*M;z+=P*N;A+=P*B;x=S;for(m=0;m<D;m++)x.r=L,x.g=M,x.b=N,x.a=B,x=x.next;for(m=1;m<D;m++)q=t+((T<m?T:m)<<2),u+=(x.r=L=r[q])*(O=D-m),w+=(x.g=M=r[q+1])*O,z+=(x.b=N=r[q+2])*O,A+=(x.a=B=r[q+3])*O,F+=L,G+=M,H+=N,I+=B,x=x.next;m=S;x=V;for(l=0;l<h;l++)r[t+3]=
B=A*Q>>R,0!=B?(B=255/B,r[t]=(u*Q>>R)*B,r[t+1]=(w*Q>>R)*B,r[t+2]=(z*Q>>R)*B):r[t]=r[t+1]=r[t+2]=0,u-=K,w-=J,z-=C,A-=E,K-=m.r,J-=m.g,C-=m.b,E-=m.a,q=y+((q=l+n+1)<T?q:T)<<2,F+=m.r=r[q],G+=m.g=r[q+1],H+=m.b=r[q+2],I+=m.a=r[q+3],u+=F,w+=G,z+=H,A+=I,m=m.next,K+=L=x.r,J+=M=x.g,C+=N=x.b,E+=B=x.a,F-=L,G-=M,H-=N,I-=B,x=x.next,t+=4;y+=h}for(l=0;l<h;l++){G=H=I=F=w=z=A=u=0;t=l<<2;K=D*(L=r[t]);J=D*(M=r[t+1]);C=D*(N=r[t+2]);E=D*(B=r[t+3]);u+=P*L;w+=P*M;z+=P*N;A+=P*B;x=S;for(m=0;m<D;m++)x.r=L,x.g=M,x.b=N,x.a=B,x=
x.next;q=h;for(m=1;m<=n;m++)t=q+l<<2,u+=(x.r=L=r[t])*(O=D-m),w+=(x.g=M=r[t+1])*O,z+=(x.b=N=r[t+2])*O,A+=(x.a=B=r[t+3])*O,F+=L,G+=M,H+=N,I+=B,x=x.next,m<U&&(q+=h);t=l;m=S;x=V;for(p=0;p<g;p++)q=t<<2,r[q+3]=B=A*Q>>R,0<B?(B=255/B,r[q]=(u*Q>>R)*B,r[q+1]=(w*Q>>R)*B,r[q+2]=(z*Q>>R)*B):r[q]=r[q+1]=r[q+2]=0,u-=K,w-=J,z-=C,A-=E,K-=m.r,J-=m.g,C-=m.b,E-=m.a,q=l+((q=p+D)<U?q:U)*h<<2,u+=F+=m.r=r[q],w+=G+=m.g=r[q+1],z+=H+=m.b=r[q+2],A+=I+=m.a=r[q+3],m=m.next,K+=L=x.r,J+=M=x.g,C+=N=x.b,E+=B=x.a,F-=L,G-=M,H-=N,I-=
B,x=x.next,t+=h}a.putImageData(k,d,f)}})(Diigo.Doodle,Diigo.$);(function(d,f,c,b){d._Editor=function(a){this.parent=a;this.history=a.history;this.auto_width=!1;this.textarea=a.textarea;this.textarea_out=a.textarea_out;this.floated_textbox=null;this.RTL=a.RTL;this.cur_page=null;this.pages=[];this.render=new d._Render(this);this.initEvent();this.focused=!1;this.saved_info={cur_page:null,width:0,height:0,scale:1}};d._Editor.prototype={onChange:function(){},paint:function(){this.render.paint()},_paint:function(){this.render._paint()},getPageByIdx:function(a){return this.pages[a]},
setBoxAutoWidth:function(a){this.auto_width=a},setBoxSize_scale:function(a,b,c){var d=Math.floor(b*c);this.textarea.style.width=Math.floor(a*c)+"px";this.textarea.style.height=d+"px";this.render.width=a;this.render.height=b;this.render.scale=c},save_state:function(){var a=this.saved_info;a.scale=this.render.scale;a.width=this.render.width;a.height=this.render.height;a.cur_page=this.cur_page},set_drawtext_size:function(a,b,c){this.render.width=a;this.render.height=b;this.render.scale=c},restore_state:function(){var a=
this.saved_info;this.render.scale=a.scale;this.render.width=a.width;this.render.height=a.height;this.cur_page=a.cur_page;this.render.page=a.cur_page;var b=Math.floor(a.height*a.scale);this.textarea.style.width=Math.floor(a.width*a.scale)+"px";this.textarea.style.height=b+"px"},getPageHeight:function(a){return this.pages[a].page_height},setBoxMatrix:function(a){this.textarea.style.webkitTransform="matrix("+a[0]+","+a[3]+","+a[1]+","+a[4]+","+a[2]+","+a[5]+")"},setBoxPosition:function(a,b,c){this.textarea_out.style.left=
a+"px";this.textarea_out.style.top=b+"px";this.textarea.style.webkitTransform="rotate("+Math.round(180*c/Math.PI)+"deg)"},createPage:function(a){a=new d._Page(this,a);this.pages.push(a);return this.pages.length-1},setCurPage:function(a,c){this.cur_page=this.pages[a];this.render.page=this.cur_page;this.render.m_auto_width=c?!0:!1;var d=this.cur_page.style.getScaleFont(this.parent.zoom_scale);this.textarea.style.font=d;this.textarea.style.lineHeight=b.getFontInfo(d).height+"px";this.textarea.style.color=
this.cur_page.style.color;this.textarea.value=this.cur_page.text},_setCurPage:function(a){this.cur_page=this.pages[a];this.render.page=this.cur_page},_setCurPage_saved:function(a){var b=this.pages.indexOf(this.cur_page);this._setCurPage(a);return b},focus:function(){!1===this.focused&&(this.focused=!0,this.textarea.focus())},blur:function(){this.focused&&(this.focused=!1,this.textarea.blur())},clear:function(){this.cur_page.reset();this.select_doodle=null;this._setCaret({index:-1,para:0,para_at:-1,
left:0,top:0});this.history.clear()},show:function(){this.textarea.style.display="block"},hide:function(){this.textarea.style.display="none"}}})(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$);(function(d,f,c,b,a){a.extend(d._Editor.prototype,{_text_handler:function(){this.floated_textbox.onTextInput(this.textarea.value)},_keypress_handler:function(){this.floated_textbox.onTextPress()},initEvent:function(){a.addEvent(this.textarea,"input",a.createDelegate(this,this._text_handler));a.addEvent(this.textarea,"keypress",a.createDelegate(this,this._keypress_handler))}})})(Diigo.Text,Diigo.Doodle,Diigo.Data,Diigo.UndoRedo,Diigo.$);(function(d,f){d._Paragraph=function(c,b,a,f,v,h,g){this.index=c;this.length=b;this.line_start=a;this.line_cross=f;this.lines=g?g:[new d._Line];this.rtl=v?!0:!1;this.align=h?h:d._Paragraph.Align.LEFT};d._Paragraph.Align={LEFT:0,RIGHT:1,MIDDLE:2};d._Line=function(c,b,a){this.end_index=c?c:-1;this.unti_dir=b?b:[];this.width=a?a:0};d._Element=function(c){this.value=c;this.width=0;this.visible=!0};d._Page=function(c,b){this.editor=c;this.style=b;this.text="";this.ele_array=[];this.para_number=0;this.para_info=
[];this.page_height=this.line_number=0;var a=f.getFontInfo(b.font);this.line_height=a.height;this.baseline_offset=a.baseline_offset;this._init()};d._Page.prototype={resetFont:function(){var c=f.getFontInfo(this.style.font);this.line_height=c.height;this.baseline_offset=c.baseline_offset},_init:function(){this.para_number=1;this.para_info=[new d._Paragraph(-1,0,0,1,!1,d._Paragraph.Align.LEFT)];this.line_number=1;this.page_height=this.line_number*this.line_height;this.text="";this.ele_array.length=
0},reset:function(){this._init()},initParagraph:function(){var c=-1,b=0,a=new d._Paragraph(c,0,b,1);this.ele_array.length=this.text.length;var f;for(f=0;f<this.text.length;f++)this.ele_array[f]=new d._Element(this.text[f]);this.para_number=1;this.para_info=[];this.line_number=0;this.para_info.push(a);for(f=0;f<this.ele_array.length;f++)"\n"===this.ele_array[f].value&&(a.length=f-c-1,a.line_cross=this._measureParagraph(a),b+=a.line_cross,this.line_number+=a.line_cross,c=f,a=new d._Paragraph(c,0,b,
1),this.para_info.push(a),this.para_number++);a.length=this.ele_array.length-1-c;a.line_cross=this._measureParagraph(a);this.line_number+=a.line_cross;this.page_height=this.line_number*this.line_height},_measureParagraph:function(c){c.rtl=this._getParaRTL(c);return this.editor.render._measure(c,this.style)},_getParaRTL:function(c){var b=!1,a=0;if(0<c.length)for(var f=c.index+1;f<c.index+1+c.length;f++)if(a=this.text.charCodeAt(f),0<=a&&!d.Char.isBiaoDian(a)&&!d.Char.isDigit(a)){b=!0;break}return b?
d.Char.isRTL(a):!1}}})(Diigo.Text,Diigo.$);(function(d){d._Style=function(d){d=d?d:{};this.color=d.color?d.color:"#000000";this.background=d.background?d.background:!1;this.underline=d.underline?d.underline:!1;this.through=d.through?d.through:!1;this.bold=d.bold?d.bold:!1;this.italic=d.italic?d.italic:!1;this.font_name=d.font_name?d.font_name:"Arial";this.font_size=d.font_size?d.font_size:16;this.font=this._getFont()};d._Style.prototype={setFontName:function(d){this.font_name=d;this.font=this._getFont()},setFontSize:function(d){this.font_size=
d;this.font=this._getFont()},setItalic:function(d){this.italic=d;this.font=this._getFont()},setThrough:function(d){this.through=d},setScale:function(d){this.scale=d;this.font=this._getFont()},setBold:function(d){this.bold=d;this.font=this._getFont()},setStyle:function(d){null!=d.bold?this.bold=d.bold:!1;null!=d.color?this.color=d.color:!1;null!=d.background?this.background=d.background:!1;null!=d.bg_invert?this.bg_invert=d.bg_invert:!1;null!=d.underline?this.underline=d.underline:!1;null!=d.through?
this.through=d.through:!1;null!=d.italic?this.italic=d.italic:!1;null!=d.font_name?this.font_name=d.font_name:!1;null!=d.font_size?this.font_size=d.font_size:!1;this.font=this._getFont()},clone:function(){return new d._Style(this)},_getFont:function(){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+this.font_size+"px "+this.font_name},getScaleFont:function(d){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+Math.floor(this.font_size*d)+"px "+this.font_name}}})(Diigo.Text);(function(d,f){d._Render=function(c){this.editor=c;this.page=null;this.height=this.width=0;this.scale=1;this.baseline_offset=0;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d")};d._Render.prototype={_paintLine:function(c,b,a,d,f,h,g){c=this.editor.cur_page.text.substr(a+c,b-c+1);this.ctx.fillText(c,g,h)},_paintContent:function(){var c=this.editor,b=this.scale,a=c.cur_page.line_height,f=c.cur_page.line_height*b,v=this.page.para_info,h=0,g=0/b,n=0,k=0,r=0,b=this.height*
b+f;0>=g?(n=0,k=-g+a,r=-0+f):(n=Math.floor(g/a),k=(n+1)*a-g,r=(n+1)*f-0);for(g=0;g<v.length&&(h+=v[g].lines.length)<=n;)g++;if(!(g>=v.length)){var l=n-(h-v[g].lines.length);a:for(;g<v.length;g++){var h=v[g],n=h.lines,p=0,m=d._Paragraph.Align;for(0<l&&(p=n[l-1].end_index+1);l<n.length;l++){var q=0;switch(h.align){case m.LEFT:q=0;break;case m.MIDDLE:q=Math.round((this.width-n[l].width)/2);break;case m.RIGHT:q=this.width-n[l].width}this._paintLine(p,n[l].end_index,h.index+1,n[l].unti_dir,h.rtl,k-c.cur_page.baseline_offset,
q);p=n[l].end_index+1;k+=a;r+=f;if(r>=b)break a}l=0}}},paintToContext:function(c,b){var a=this.ctx,d=this.scale;this.ctx=c;this.ctx.save();this.ctx.scale(d,d);this.ctx.font=b.font;this.ctx.fillStyle=b.color;""!==this.page.text.trim()&&this._paintContent();this.ctx.restore();this.ctx=a}}})(Diigo.Text,Diigo.$);(function(d,f){d.Char={isRTL:function(c){return 1536<=c&&1791>=c},isBiaoDian:function(c){return 32<=c&&47>=c||58<=c&&64>=c||91<=c&&96>=c||123<=c&&126>=c},isDigit:function(c){return 48<=c&&57>=c},isIdeographic:function(c,b){if(11904<=c&&12287>=c||12288===c)return!0;if(12352<=c&&12447>=c){if(!b)switch(c){case 12353:case 12355:case 12357:case 12359:case 12361:case 12387:case 12419:case 12421:case 12423:case 12430:case 12437:case 12438:case 12443:case 12444:case 12445:case 12446:return!1}return!0}if(12448<=
c&&12543>=c){if(!b)switch(c){case 12448:case 12449:case 12451:case 12453:case 12455:case 12457:case 12483:case 12515:case 12517:case 12519:case 12526:case 12533:case 12534:case 12539:case 12540:case 12541:case 12542:return!1}return!0}return 13312<=c&&19893>=c||19968<=c&&40891>=c||63744<=c&&64217>=c||40960<=c&&42127>=c||42128<=c&&42191>=c||65122<=c&&65126>=c||65296<=c&&65305>=c?!0:!1}};f.extend(d._Render.prototype,{_getDirLength:function(c,b,a,f){var v=!1,h=1;b+=1;for(var g=0;b<a;){var n=c[b].value.charCodeAt(b);
if(f?d.Char.isRTL(n):0<n&&!d.Char.isRTL(n)&&!d.Char.isBiaoDian(n))v&&(h+=g,v=!1,g=0),h++;else if(0>n||d.Char.isBiaoDian(n))g++,v=!0;else break;b++}return h},_getCode:function(c){return c.value.charCodeAt(0)},_measureStrElement:function(c){return this.ctx.measureText(c).width},_measureElement:function(c){return this.ctx.measureText(c.value).width},_measure:function(c,b){this.ctx.font=b.font;c.lines=[new d._Line(-1,[],0)];return this._doMeasure(c)},_m_LTR:function(c,b,a,f,v,h,g,n){for(var k=f-1,r=c?
!0:!1,l=0,p=f,m=c?f+this._getDirLength(a,f,n,!1):n,q=c?b:this.width-b,t=c?f:-1;p<m;){var y=a[p],u=this._getCode(y),w=p===f?null:a[p-1];null===w||this._getCode(w);var w=p+1<n?a[p+1]:null,z=null===w?-1:this._getCode(w);if(!c&&d.Char.isRTL(u)){m=p;break}0<=u&&0===y.width&&(y.width=this._measureElement(y));l+=y.width;if(l<q){if(0>u||32===u||9===u||!(44!==u&&46!==u&&58!==u&&59!==u||p!==g&&d.Char.isDigit(this._getCode(a[p-1]))||null!==w&&d.Char.isDigit(z))||!(45!==u&&47!==u||null!==w&&d.Char.isDigit(z))||
11904<=u&&d.Char.isIdeographic(u,!0)&&null!==w&&d.Char.isIdeographic(z,!1))r=!1,k=p}else if(32===u)y.visible=!1,k=p;else{if(k>=f||r)p=k+1;b=v-h.line_start;if(!r&&c){for(r={index:t-g,length:p-t,width:0};t<p;t++)r.width+=a[t].width;h.lines[b].unti_dir.push(r)}h.lines[b].end_index=p-1-g;h.lines.push(new d._Line);t=p;b=c?this.width:0;q=this.width;l=0;k=f-1;v++;r=!1;continue}p++}c&&h.lines[v-h.line_start].unti_dir.push({index:t-g,length:m-t,width:l});return{left:c?b-l:b+l,line_at:v,end_index:m}},_calc_line_width:function(c,
b,a){for(var d=0;b<=a;b++)c[b].visible&&(d+=c[b].width);return d},_m_RTL:function(c,b,a,f,v,h,g,n){for(var k=f-1,r=c?!0:!1,l=0,p=f,m=c?this.width-b:b,q=c?f+this._getDirLength(a,f,n,!0):n,t=c?f:-1,y=p,u=0,w="";p<q;){var u=a[p],z=p+1<n?a[p+1]:null,A=this._getCode(u);if(!c&&0<=A&&!d.Char.isRTL(A)&&!d.Char.isBiaoDian(A)){q=p;break}0<A?(w+=u.value,u=this._measureStrElement(u,w)):u=u.width;if(l+u<m){1536>A&&(r=!1,k=p);if(1536>A||null===z||!d.Char.isRTL(this._getCode(z))){if(0<A)for(w=y;w<=p;w++)a[w].width=
u/(p-y+1);l+=u;w="";y=p+1}p++}else{if(k>f||r)p=k+1;b=v-h.line_start;if(!r&&c){for(r={index:t-g,length:p-t,width:0};t<p;t++)r.width+=a[t].width;h.lines[b].unti_dir.push(r)}h.lines[b].end_index=p-1-g;h.lines.push(new d._Line);t=p;for(w=y;w<=p;w++)a[w].width=u/(p-y+1);w="";y=p;b=c?0:this.width;m=this.width;l=0;k=f-1;v++;r=!1}}c&&h.lines[v-h.line_start].unti_dir.push({index:t-g,length:q-t,width:l});return{left:c?b+l:b-l,line_at:v,end_index:q}},_doMeasure:function(c){for(var b=c.rtl,a=c.index+1,d=a+c.length,
f=c.line_start,h=this.page.ele_array,g=b?this.width:0,n=a,k=null;n<d;)k=b?this._m_RTL(!1===c.rtl,g,h,n,f,c,a,d):this._m_LTR(!0===c.rtl,g,h,n,f,c,a,d),f=k.line_at,g=k.left,n=k.end_index,b=!b;c.lines[f-c.line_start].end_index=c.length-1;for(n=0;n<c.lines.length;n++)b=this._calc_line_width(h,c.index+1+(0===n?0:c.lines[n-1].end_index),c.index+1+c.lines[n].end_index),c.lines[n].width=b;return f-c.line_start+1}})})(Diigo.Text,Diigo.$);(function(d,f){f.extend(d._Editor.prototype,{initShortKey:function(){this.SHORTKEY_TABLE={"ctrl-a":this._ctrl_a_handler,"ctrl-up":this._ctrl_up_handler,"ctrl-down":this._ctrl_down_handler,"ctrl-left":this._ctrl_left_handler,"ctrl-right":this._ctrl_right_handler,"ctrl-z":this._undo_handler,"ctrl-y":this._redo_handler,"ctrl-s":this._save_handler,left:this._left_handler,right:this._right_handler,up:this._up_handler,down:this._down_handler,"shift-left":this._shift_left_handler,"shift-right":this._shift_right_handler,
"shift-up":this._shift_up_handler,"shift-down":this._shift_down_handler,"ctrl-shift-left":this._ctrl_shift_left_handler,"ctrl-shift-right":this._ctrl_shift_right_handler,"ctrl-home":this._ctrl_home_handler,"ctrl-end":this._ctrl_end_handler,"shift-home":this._shift_home_handler,"shift-end":this._shift_end_handler,"ctrl-shift-home":this._ctrl_shift_home_handler,"ctrl-shift-end":this._ctrl_shift_end_handler,home:this._home_handler,end:this._end_handler,"ctrl-b":this._ctrl_b_handler,"ctrl-i":this._ctrl_i_handler,
pageup:this._pageup_handler,pagedown:this._pagedown_handler,"ctrl-=":this._zoom_up_handler,"ctrl--":this._zoom_down_handler,"ctrl-0":this._zoom_back_handler};this.KEY_TABLE={33:"pageup",34:"pagedown",36:"home",35:"end",37:"left",39:"right",38:"up",40:"down"};this.IGNORE_LIST="ctrl-r ctrl-w ctrl-q ctrl-c ctrl-v ctrl-x".split(" ");f.firefox?(this.KEY_TABLE[173]="-",this.KEY_TABLE[61]="="):(this.KEY_TABLE[189]="-",this.KEY_TABLE[187]="=")},_zoom_up_handler:function(){Control.zoom("up")},_zoom_down_handler:function(){Control.zoom("down")},
_zoom_back_handler:function(){Control.zoom("back")},_save_handler:function(){Control.save()},_pageup_handler:function(){this.container.scrollTop-=15*this.line_height*this.render.scale},_pagedown_handler:function(){this.container.scrollTop+=15*this.line_height*this.render.scale},_ctrl_b_handler:function(){Control.bold()},_ctrl_i_handler:function(){Control.italic()},_shift_home_handler:function(){if(!(0>this.cur_page.caret_pos.para_at)){var c=this.cur_page.para_info[this.cur_page.caret_pos.para],b=
this.cur_page.caret_pos.line-c.line_start;this._shift_select(c.index+(0===b?-1:c.lines[b-1].end_index)+1,!0)}},_shift_end_handler:function(){var c=this.cur_page.para_info[this.cur_page.caret_pos.para];this.cur_page.caret_pos.para_at!==c.length-1&&this._shift_select(c.index+c.lines[this.cur_page.caret_pos.line-c.line_start].end_index+1)},_ctrl_shift_home_handler:function(){0>this.cur_page.caret_pos.index||this._shift_select(-1)},_ctrl_shift_end_handler:function(){this.cur_page.caret_pos.index!==this.cur_page.ele_array.length-
1&&this._shift_select(this.cur_page.ele_array.length-1)},_home_handler:function(){this._setCaret(this.cur_page.getCaretLineStart(this.cur_page.caret_pos));this.cur_page.select(null);this.render.paint()},_end_handler:function(){this._setCaret(this.cur_page.getCaretLineEnd(this.cur_page.caret_pos));this.cur_page.select(null);this.render.paint()},_ctrl_home_handler:function(){this._setCaret(this.cur_page.getCaretByIndex(-1));this.cur_page.select(null);this.render.paint()},_ctrl_end_handler:function(){this._setCaret(this.cur_page.getCaretByIndex(this.cur_page.ele_array.length-
1));this.cur_page.select(null);this.render.paint()},_undo_handler:function(){"readonly"!==this.cur_mode&&this.history.undo()},_redo_handler:function(){"readonly"!==this.cur_mode&&this.history.redo()},_ctrl_a_handler:function(){this._setCaret(this.cur_page.selectAll());this.render.paint()},_shift_left_handler:function(){0>this.cur_page.caret_pos.index||this._shift_select(this.cur_page.caret_pos.index-1)},_shift_select:function(c,b){var a=this.cur_page.caret_pos,d=a.index,f=this.cur_page;f.select_mode&&
(a=f.select_range,a=a.from.index===d?a.to:a.from,d=a.index);var h=null,h=b?f.getBeforeCaretByIndex(c+1):f.getCaretByIndex(c);c===d?f.select(null):c<d?f.select(h,a):f.select(a,h);this._setCaret(h);this._resetStyle();this.render.paint();this._check_copy()},_shift_up_handler:function(){0<this.cur_page.caret_pos.top-this.line_height&&this._shift_select(this.cur_page._getCaret_xy(this.cur_page.caret_pos.left,this.cur_page.caret_pos.top-this.line_height).index)},_shift_down_handler:function(){var c=this.cur_page.para_info,
c=c[c.length-1];this.cur_page.caret_pos.top+this.line_height<(c.line_start+c.line_cross)*this.line_height&&this._shift_select(this.cur_page._getCaret_xy(this.cur_page.caret_pos.left,this.cur_page.caret_pos.top+this.line_height).index)},_shift_right_handler:function(){this.cur_page.caret_pos.index>=this.cur_page.ele_array.length-1||this._shift_select(this.cur_page.caret_pos.index+1)},_ctrl_shift_left_handler:function(){0>this.cur_page.caret_pos.index||this._shift_select(this.wordSeg.getLeft(this.cur_page.ele_array,
this.cur_page.caret_pos.index))},_ctrl_shift_right_handler:function(){this.cur_page.caret_pos.index>=this.cur_page.ele_array.length-1||this._shift_select(this.wordSeg.getRight(this.cur_page.ele_array,this.cur_page.caret_pos.index+1))},_ctrl_left_handler:function(){var c=this.cur_page.caret_pos.index;0<=c&&this._setCaret(this.cur_page.getCaretByIndex(this.wordSeg.getLeft(this.cur_page.ele_array,c)));this.cur_page.select(null);this.render.paint()},_ctrl_right_handler:function(){var c=this.cur_page.caret_pos.index+
1,b=this.cur_page.ele_array;c<b.length&&this._setCaret(this.cur_page.getCaretByIndex(this.wordSeg.getRight(b,c)));this.cur_page.select(null);this.render.paint()},_ctrl_up_handler:function(){this.container.scrollTop-=this.line_height*this.render.scale},_ctrl_down_handler:function(){this.container.scrollTop+=this.line_height*this.render.scale},_left_handler:function(){this.moveCaret("left")},_right_handler:function(){this.moveCaret("right")},_up_handler:function(){this.moveCaret("up")},_down_handler:function(){this.moveCaret("down")},
_deal_shorkkey:function(c){var b=c.keyCode;37!==b&&39!==b||!this.cur_page.para_info[this.cur_page.caret_pos.para].rtl||(b=37===b?39:37);c=((f.macOS?c.metaKey:c.ctrlKey)?"ctrl-":"")+(c.shiftKey?"shift-":"")+(null==this.KEY_TABLE[b]?String.fromCharCode(b).toLowerCase():this.KEY_TABLE[b]);c=this.SHORTKEY_TABLE[c];return"function"===typeof c?(c.call(this),!0):!1}})})(Diigo.Text,Diigo.$);
