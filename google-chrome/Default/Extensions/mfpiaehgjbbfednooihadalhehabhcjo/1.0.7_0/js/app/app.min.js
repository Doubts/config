angular.module("Capture",[]).service("CaptureService",[function(){function e(){null!==d&&(k.getVideoTracks()[0].stop(),k=d=null)}function a(a){null!==d&&e();chrome.desktopCapture.chooseDesktopMedia(["screen","window"],function(f){f?(d=f,navigator.webkitGetUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:f,maxWidth:2560,maxHeight:1440}}},function(f){k=f;a(0)},function(){d=null;a(2)})):(d=null,a(999))})}function f(a){var f=document.createElement("video");f.addEventListener("canplay",
function(){var d=document.createElement("canvas"),h=d.getContext("2d");d.width=f.videoWidth;d.height=f.videoHeight;h.drawImage(f,0,0,d.width,d.height);f.pause();f.src="";e();a(0,Diigo.$.getCanvasBlob(d))},!1);f.src=window.URL.createObjectURL(k)}var d=null,k=null;this.getStream=function(f){a(f)};this.pickImage=function(d){null===k?a(function(a){0===a?f(d):d(a)}):f(d)}}]);angular.module("Storage",[]).service("StorageService",["$q","$rootScope",function(e,a){function f(c,g,a){c=t.transaction([b],"readwrite").objectStore(b).put(c);c.onsuccess=g;c.onerror=a}function d(c,g,a){c=t.transaction([b],"readwrite").objectStore(b).add(c);c.onsuccess=g;c.onerror=a}function k(c,g,a){c=t.transaction([b],"readwrite").objectStore(b)["delete"](c);c.onsuccess=g;c.onerror=a}function n(b,c,g,a){l(b,c,function(){d(c,g,a)},a)}function q(b,c,g,a){h(b,c,function(){d(c,g,a)},a)}function l(b,
c,g,a){b.copyTo(r.root,c.fileName,g,a)}function h(b,c,g,a){r.root.getFile(c.fileName,{create:!0},function(c){c.createWriter(function(c){c.onwriteend=g;c.onerror=a;c.write(b)},a)},a)}function g(b){switch(b){case "db":x=!0;break;case "fs":s=!0}x&&s&&(c=!0,a.CTRL.onStorageReady())}var b="screenshots",c=!1,u=!1,r=null,t=null,s=!1,x=!1,v=function(b){noty({layout:"topCenter",text:b,type:"error"});throw b;};window.query_usage=function(){navigator.webkitPersistentStorage.queryUsageAndQuota(function(b,c){$.log("ueage:"+
b+","+c)})};this.update_db_info=f;(function(){try{var b=webkitRequestFileSystem||b;b(window.PERSISTENT,10240,function(b){$.log("filesystem opened");r=b;g("fs")},function(){_error("failed to access filesystem. please reload this app.")})}catch(c){u=!0}})();(function(){var c=function(){v("failed to open local database. please reload this app.")},a=indexedDB.open("awesome",1);a.onupgradeneeded=function(a){var g=a.target.result;a.target.transaction.onerror=c;g.objectStoreNames.contains(b)&&g.deleteObjectStore(b);
g.createObjectStore(b,{keyPath:"fileName"});$.log("indexedDB new objectStore")};a.onsuccess=function(b){$.log("indexedDB opened");t=b.target.result;g("db")};a.onerror=c})();this.isReady=function(){return c};this.hasError=function(){return u};this.deleteImageFile=function(c,a,g){var f=t.transaction([b],"readwrite").objectStore(b)["delete"](c);f.onsuccess=function(){r.root.getFile(c,{},function(b){b.remove(a,g)},g)};f.onerror=g};this.saveImageEntry=function(b,c,g,a){n(b,c,g,a)};this.saveImageFile=function(b,
c,g,a){q(b,c,g,a)};this.getAllImageInfo=function(c,g,a){var f=t.transaction([b],"readonly").objectStore(b).openCursor(),p=0,d=!1;f.onsuccess=function(b){if(b=b.target.result){var f=function(b){this.img_info=b;r.root.getFile(b.fileName,{},Diigo.$.createDelegate(this,this.on_file),Diigo.$.createDelegate(this,this.on_error))};f.prototype={on_error:function(){a(this.img_info.fileName);this._de()},on_file:function(b){this.img_info.url=b.toURL();c(this.img_info);this._de()},_de:function(){p--;0===p&&d&&
(g(),p=-1)}};p++;if(!b.value)debugger;new f(b.value);b["continue"]()}else d=!0,0===p&&g()};f.onerror=function(b){}};this.delImageArray=function(b){for(var c=0;c<b.length;c++)k(b[c],function(){},function(){})};this.updateImageFile=function(b,c,g){var a=function(){v("failed to write image to file. please reload this app.")};r.root.getFile(b.fileName,{create:!0},function(p){p.createWriter(function(p){p.onwriteend=function(c){var p=b.time;b.setTime((new Date).getTime());f(b,g,function(){b.setTime(p);
a()})};p.onerror=a;p.write(c)},a)},a)};this.getImageUrl=function(b,c){r.root.getFile(b,{},function(b){c(b.toURL())},function(){c()})};this.getImageFileBlob=function(b,c){function a(){c()}r.root.getFile(b,{},function(b){b.file(function(b){c(b)},a)},a)};this.saveImageToDisk=function(b,c,g){var f="PNG"===a.EXPORT_FORMAT?"png":"jpg",p=function(){g()};chrome.fileSystem.chooseEntry({accepts:[{description:f,extensions:["jpg","jpeg","png","bmp","gif"]}],acceptsAllTypes:!1,type:"saveFile",suggestedName:b.title+
"."+f},function(a){a?r.root.getFile(b.fileName,{},function(b){b.file(function(b){a.createWriter(function(g){g.onwriteend=function(){c(a.fullPath)};g.onerror=p;g.write(b)},p)},p)},p):c()})};this.getPref=function(b){var c=e.defer();chrome.storage.local.get(b,function(b){b?c.resolve(b):c.resolve(null)});return c.promise};this.setPref=function(b,c){var a=e.defer(),g={};g[b]=c;chrome.storage.local.set(g,function(){a.resolve()});return a.promise};this.getLastLocalValue=function(b,c){chrome.storage.local.get(b,
c)}}]);angular.module("Server",[]).service("ServerService",["$rootScope","GDriveService",function(e,a){function f(b,c){var a=c?c:"&",g=[],f;for(f in b)g.push(f+"="+encodeURIComponent(b[f]));return g.join(a)}function d(c,a){chrome.identity.getAuthToken({interactive:c},function(c){chrome.runtime.lastError?(console.log(chrome.runtime.lastError),b.token=null,a(1)):(b.token=c,a(0))})}function k(){b.token&&(chrome.identity.removeCachedAuthToken({token:b.token},function(){}),b.token=null)}function n(){chrome.storage&&
chrome.storage.local.get("user_info",function(b){b&&b.user_info&&(g=b.user_info,b=JSON.stringify({user_id:g.info.user_id}),b="cv="+c.cv+"&ct="+c.ct+"&v="+c.v+"&cmd=loadUserInfo&json="+encodeURIComponent(b)+"&s="+hex_md5(""+c.ct+c.cv+b+c.v+"loadUserInfo"),s("diigo",f({pv:c.pv,ct:c.ct},"/"),b,function(b){l(b)},function(){g=null},function(){g=null}))})}function q(b){chrome.storage&&chrome.storage.local.set({user_token:b})}function l(b){g=b;chrome.storage&&chrome.storage.local.set({user_info:b})}function h(c,
a,g,f,d,h){if(null===b.token)h();else{var p=new XMLHttpRequest;p.open(g?"POST":"GET",r[c]+a);p.setRequestHeader("Authorization","Bearer "+b.token);p.onreadystatechange=function(){if(4==this.readyState){switch(p.status){case 200:var b=JSON.parse(p.response);f(b);break;case 401:d();break;default:e.CTRL.noty_error("network error, please check your network and try again.",3E3),h()}p=null}};g?p.send(g):p.send()}}var g=null,b={token:null,email:""},c={cv:chrome.runtime.getManifest?chrome.runtime.getManifest().version:
1,v:1,pv:1,ct:"chrome_awesome_screenshot",ct2:"chrome_desktop_awesome_screenshot"},u={as:"http://awesomescreenshot.com/client?",signin:"https://secure.diigo.com/kree/",diigo:"https://www.diigo.com/kree/",signout:"https://www.diigo.com/sign-out"},r={profile:"https://content.googleapis.com/plus/v1/people/me",drive:""};this.load_user=n;var t=function(b,c){jQuery.get(u[b],c)},s=function(b,c,a,g,f,d){var p=new XMLHttpRequest;p.open("POST",u[b]+c,!0);p.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
p.setRequestHeader("X-Same-Domain","true");p.onreadystatechange=function(){if(4==this.readyState){switch(p.status){case 200:var b=JSON.parse(p.response);1===b.code?g(b.result):f();break;case 401:f();break;default:e.CTRL.noty_error("network error, please check your network and try again.",3E3),d()}p=null}};p.send(a)};this.uploadImageToAS=function(b,a,g){b=b.replace(/^data:image\/(png|jpeg);base64,/,"");a=JSON.stringify({src_url:"awesome screenshot app",src_title:a,image_md5:hex_md5(b),image_type:"png",
image_content:b});s("as",f({cmd:"imageUpload",ct:"chrome",pv:c.pv,cv:c.cv,v:c.v}),a,function(b){g(b)},function(){g()},function(){g()})};this.loginIntoDiigoByUP=function(b,a,d){b=JSON.stringify({user:b,password:a});b="cv="+c.cv+"&ct="+c.ct+"&v="+c.v+"&cmd=signin&json="+encodeURIComponent(b)+"&s="+hex_md5(""+c.ct+c.cv+b+c.v+"signin");s("signin",f({pv:c.pv,ct:c.ct},"/"),b,function(b){l(b);d(0,b)},function(){g=null;d(1)},function(){g=null;d(2)})};this.connectGoogleToDiigo=function(b,a){if("undefined"!==
typeof b){var d=JSON.stringify({username:b.uname}),d="cv="+c.cv+"&ct="+c.ct2+"&v="+c.v+"&cmd=loadUserInfo&json="+encodeURIComponent(d)+"&s="+hex_md5(""+c.ct2+c.cv+d+c.v+"loadUserInfo"+b.uname)+"&uname="+b.uname+"&skey="+b.skey;s("diigo",f({pv:c.pv,ct:c.ct2},"/"),d,function(b){l(b);a(0,b)},function(){g=null;a(1)},function(){g=null;a(2)})}};this.getUser=function(){return g};this.clearUser=function(){t("signout",function(){});g=null;chrome.storage&&chrome.storage.local.remove("user_info")};this.uploadImageToDiigo=
function(b,a){var g=b.image_url.replace(/^data:image\/(png|jpeg);base64,/,""),d={items:[{local_id:"image",server_id:-1,cmd:1,type:2,local_file_md5:hex_md5(g),tags:b.tags,mode:b.mode?2:0,title:b.title,src_url:"",src_title:b.src_title}]},d=JSON.stringify(d);b="cv="+c.cv+"&ct="+c.ct+"&v="+c.v+"&cmd=uploadItems&json="+encodeURIComponent(d)+"&s="+hex_md5(""+c.ct+c.cv+d+c.v+"uploadItems")+"&image="+encodeURIComponent(g);s("diigo",f({pv:c.pv,ct:c.ct},"/"),b,function(b){a(0,b.items[0])},function(){a(1)},
function(){a(2)})};this.uploadImageToGDrive=function(c,g,f,d){b.token?a.upload(b.token,c,g,function(c,g){0===c&&f?a.shareFile(b.token,g.id,function(b){0===b?d(0,g):d(999,g)}):d(c,g)}):d(1)};this.getGoogleAccount=function(){return b};this.applyGoogleAccessToken=function(c){d(!0,function(a){0===a&&q(b.token);c(a,b.token)})};this.loginIntoGoogleByToken=function(c){d(!0,function(a){function g(){k();c(1)}0===a?(q(b.token),h("profile","",null,function(a){b.email=a.emails[0].value;c(0)},g,g)):c(a)})};n();
(function(){chrome.storage&&d(!1,function(){chrome.storage.local.get("user_token",function(c){c&&c.user_token?(b.token!==c.user_token&&(k(),b.token=c.user_token),c=function(){k();chrome.storage.local.remove("user_token")},h("profile","",null,function(c){b.email=c.emails[0].value;$.log(b.email)},c,c)):k()})})})()}]);angular.module("GDrive",[]).service("GDriveService",[function(){var e=function(){this.interval=1E3;this.maxInterval=6E4};e.prototype.retry=function(a){setTimeout(a,this.interval);this.interval=this.nextInterval_()};e.prototype.reset=function(){this.interval=1E3};e.prototype.nextInterval_=function(){var a=2*this.interval+this.getRandomInt_(0,1E3);return Math.min(a,this.maxInterval)};e.prototype.getRandomInt_=function(a,d){return Math.floor(Math.random()*(d-a+1)+a)};var a=function(a){var d=function(){};
this.file=a.file;this.contentType=a.contentType||this.file.type||"application/octet-stream";this.metadata=a.metadata||{title:a.title||this.file.name,mimeType:this.contentType};this.token=a.token;this.onComplete=a.onComplete||d;this.onError=a.onError||d;this.offset=a.offset||0;this.chunkSize=a.chunkSize||0;this.retryHandler=new e;this.url=a.url;this.url||(d=a.params||{},d.uploadType="resumable",this.url=this.buildUrl_(a.fileId,d));this.httpMethod=this.fileId?"PUT":"POST"};a.prototype.upload=function(){var a=
this,d=new XMLHttpRequest;d.open(this.httpMethod,this.url,!0);d.setRequestHeader("Authorization","Bearer "+this.token);d.setRequestHeader("Content-Type","application/json");d.setRequestHeader("X-Upload-Content-Length",this.file.size);d.setRequestHeader("X-Upload-Content-Type",this.contentType);d.onload=function(d){d=d.target.getResponseHeader("Location");console.log(d);a.url=d;a.sendFile_()};d.onerror=Diigo.$.createDelegate(this,this.onUploadError_);d.send(JSON.stringify(this.metadata))};a.prototype.sendFile_=
function(){var a=this.file,d=this.file.size;if(this.offset||this.chunkSize)this.chunkSize&&(d=Math.min(this.offset+this.chunkSize,this.file.size)),a=a.slice(this.offset,d);var e=new XMLHttpRequest;e.open("PUT",this.url,!0);e.setRequestHeader("Content-Type",this.contentType);e.setRequestHeader("Content-Range","bytes "+this.offset+"-"+(d-1)+"/"+this.file.size);e.setRequestHeader("X-Upload-Content-Type",this.file.type);e.onload=Diigo.$.createDelegate(this,this.onContentUploadSuccess_);e.onerror=Diigo.$.createDelegate(this,
this.onContentUploadError_);e.send(a)};a.prototype.resume_=function(){var a=new XMLHttpRequest;a.open("PUT",this.url,!0);a.setRequestHeader("Content-Range","bytes */"+this.file.size);a.setRequestHeader("X-Upload-Content-Type",this.file.type);a.onload=Diigo.$.createDelegate(this,this.onContentUploadSuccess_.bind);a.onerror=Diigo.$.createDelegate(this,this.onContentUploadError_.bind);a.send()};a.prototype.extractRange_=function(a){if(a=a.getResponseHeader("Range"))this.offset=parseInt(a.match(/\d+/g).pop(),
10)+1};a.prototype.onContentUploadSuccess_=function(a){if(200==a.target.status||201==a.target.status)this.onComplete(a.target.response);else 308==a.target.status&&(this.extractRange_(a.target),this.retryHandler.reset(),this.sendFile_())};a.prototype.onContentUploadError_=function(a){if(a.target.status&&500>a.target.status)this.onError(a.target.response);else this.retryHandler.retry(Diigo.$.createDelegate(this,this.resume_))};a.prototype.onUploadError_=function(a){this.onError(a.target.response)};
a.prototype.buildQuery_=function(a){a=a||{};return Object.keys(a).map(function(d){return encodeURIComponent(d)+"="+encodeURIComponent(a[d])}).join("&")};a.prototype.buildUrl_=function(a,d){var e="https://www.googleapis.com/upload/drive/v2/files/";a&&(e+=a);var n=this.buildQuery_(d);n&&(e+="?"+n);return e};this.upload=function(e,d,k,n){(new a({token:e,file:d,title:k.title+".png",onComplete:function(a){a=JSON.parse(a);n(0,a)},onError:function(a){n(1)}})).upload()};this.shareFile=function(a,d,e){var n=
new XMLHttpRequest;n.open("POST","https://www.googleapis.com/drive/v2/files/"+d+"/permissions");n.setRequestHeader("Authorization","Bearer "+a);n.setRequestHeader("Content-Type","application/json");a=JSON.stringify({role:"reader",type:"anyone"});n.onreadystatechange=function(){4==this.readyState&&e(200===n.status?0:1)};n.send(a)}}]);angular.module("I18N",[]).filter("i18n",function(){return function(e){var a=chrome.i18n.getMessage(e);return a?a:e}});angular.module("Diigo",[]).factory("DiigoImage",[function(){function e(a){this.fileName=a.fileName;this.origin_url=this.url=a.url;this.title=a.title;this.time=a.time;this.need_edit=a.need_edit?!0:!1;this.first_load=a.first_load?!0:!1;this.image=null}e.prototype={clone:function(){return new e(this)},setTime:function(a){this.first_load=!1;this.time=a;this.url=this.origin_url+"?rnd="+a;this.image=null}};return e}]);var app=angular.module("AwesomeScreenshotApp","Diigo Capture Storage Server GDrive Editor I18N".split(" "));app.config(["$compileProvider",function(e){var a=e.imgSrcSanitizationWhitelist(),a=a.toString().slice(0,-1)+"|chrome-extension:|.+|localhost(:\\d+)?|((http|https)://)?(d+).(d+).(d+).(d+)"+a.toString().slice(-1);e.imgSrcSanitizationWhitelist(a)}]);
app.controller("ToolbarCtrl",["$scope","$rootScope","DiigoEditor","StorageService",function(e,a,f,d){function k(){var a=$("#menuPanel"),b=a.find(".font .font-list");b.html("");for(var c=0;c<n.length;c++){var d=$("<div></div>").css("font-family",n[c]).data("font",n[c]).click(function(){var a=$(this).data("font");b.data("font",null);h.setFontName(a);h.hideMenu()}).text(n[c]);b.append(d)}var e=a.find(".font input"),a=b.data("init-font-size");e.attr({min:10,max:50,value:a?a:20}).data("pre-value",a).keypress(function(b){(47>
b.keyCode||58<b.keyCode)&&b.preventDefault()}).on("keydown",function(b){b.originalEvent.diigo_no_keydown=!0}).on("input",function(b){b=Number(e.val());var a=Number(e.attr("min")),c=Number(e.attr("max"));b<a||b>c||(e.data("pre-value",b),h.setFontSize(b))}).on("change",function(b){b=Number(e.val());var a=Number(e.attr("min")),c=Number(e.attr("max"));b<a||b>c?e.val(e.data("pre-value")):h.setFontSize(b)});b.data("init","yes")}a.APP_MODE=window.t_dataUrl?"loading":"upload";a.IMAGE_ARRAY=[];a.CUR_IMAGE=
null;a.CTRL={noty_error:function(a,b){noty({text:a,type:"error",layout:"topCenter",timeout:b})},noty_warning:function(a,b){noty({text:a,type:"warning",layout:"topCenter",timeout:b?b:600})},noty_success:function(a,b){noty({text:a,type:"success",layout:"topCenter",timeout:b?b:600})}};e.upload=function(){a.APP_MODE="upload"};e.search=function(){a.CTRL.search()};e.showSetting=function(){a.CTRL.showSetting()};var n="Times New Roman;Arial;Craft Girls;Limelight;Lobster;Anton;Chewy;Frijole;Spirax;Dancing Script;Changa One;Griffy".split(";");
WebFontConfig={custom:{families:n,urls:["css/font.css"]},active:function(){k()},inactive:function(){$.log("error font")}};(function(){var a=document.createElement("script");a.src="js/lib/webfont.js";a.type="text/javascript";a.async="true";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})();var q={color:function(){for(var a=$("#menuPanel .colorPanel"),b=a.data("ARR"),c=0;c<b.length;c++){var d=$("<b><i></i></b>").data("color",b[c]).css("background",b[c]).click(function(){var b=
$(this).data("color");h.setColor(b);h.hideMenu()});a.append(d)}$("#opacitySlider").on("input",function(){h.setOpacity(this.value)})},shape:function(){for(var a=$("#menuPanel").find(".shape"),b=a.data("ARR"),c=0;c<b.length;c++){var d=$("<div></div>").data("shape",b[c]).attr("title",chrome.i18n.getMessage("tip_shape_"+b[c])).mousedown(function(){var b=$(this),a=b.data("shape");$("#annotation_bar .btn-shape").attr({shape:a,title:b.attr("title")}).parent(".btn-group").attr("shape",a).find("img:first").attr("src",
b.find("img").attr("src"));h.setShape(b.data("shape"));h.hideMenu()}).html("<img src='images/"+b[c]+".png'>");a.append(d)}},arrow:function(){for(var a=$("#menuPanel").find(".arrow"),b=a.data("ARR"),c=0;c<b.length;c++){var d=$("<div></div>").data("shape",b[c]).attr("title",chrome.i18n.getMessage("tip_shape_"+b[c])).mousedown(function(){var b=$(this),a=b.data("shape");$("#annotation_bar .btn-arrow").attr({shape:a,title:b.attr("title")}).parent(".btn-group").attr("shape",a).find("img:first").attr("src",
b.find("img").attr("src"));h.setShape(b.data("shape"));h.hideMenu()}).html("<img src='images/"+b[c]+".png'>");a.append(d)}},annotation:function(){function a(){k++;var c=this.img_info;c.width=this.naturalWidth;c.height=this.naturalHeight;k<n||b()}function b(){for(var b=0;b<d.length;b++){var a=new Image;a.src=l[b].image.src;a=$("<div></div>").data("svg_image",l[b]).click(function(){f.insertSvgImage($(this).data("svg_image"));h.hideMenu()}).append(a);c.append(a)}}for(var c=$("#menuPanel .annotation"),
d=c.data("ARR"),e=c.data("TYPE"),n=d.length,k=0,l=[],q=0;q<n;q++){var w=new Image;w.onload=a;l.push({image:w,width:0,height:0,choose_type:e[q]});w.img_info=l[q];w.src="images/svg/"+d[q]+".svg"}},scale:function(){for(var a=$("#menuPanel .scale"),b=a.data("ARR"),c=0;c<b.length;c++){var d=$("<div></div>").data("scale",b[c]).text(b[c]).click(function(){h.setScale($(this).data("scale"));h.hideMenu()});a.append(d)}},size:function(){function a(c){h.RESIZE_UNIT!==c&&(h.RESIZE_UNIT=c,h.resetResizeUnit(),b.find(".btn-unit span").text(c))}
var b=$("#menuPanel"),c=b.find(".btn-resize"),d=b.find(".btn-cancel"),e=b.find(".width"),n=b.find(".height"),k=b.find(".proportional-check");k.change(function(){h.resetResizeUnit()});b.find(".num").on("keypress",function(b){(48>b.keyCode||57<b.keyCode)&&b.preventDefault()}).on("keydown",function(b){b.originalEvent.diigo_no_keydown=!0}).on("input",function(b){var a=$(this),c=Number(a.attr("min")),g=Number(a.attr("max"));b=Number(a.val());b<c||b>g?a.val(a.data("pre-value")):(a.data("pre-value",b),c=
"px"===h.RESIZE_UNIT,k.is(":checked")&&(a=f.bg_info.width/f.bg_info.height,this===e[0]?n.val(c?Math.round(b/a):b):e.val(c?Math.round(b*a):b)))});c.click(function(){var b=Number(e.val()),a=Number(n.val());"%"===h.RESIZE_UNIT&&(b=Math.round(f.bg_info.width*b/100),a=Math.round(f.bg_info.height*a/100));h.setSize(b,a);h.hideMenu()});d.click(function(){h.hideMenu()});var l=b.find(".unit-dialog");b.find(".btn-unit").mousedown(function(b){var a=$(this),c=a.position(),g=Math.round(c.left+(a.innerWidth()-2.5)/
2-l.innerWidth()/2),a=Math.round(c.top+a.innerHeight()+2);l.css({left:g,top:a}).fadeIn(200);b.stopPropagation();b.preventDefault()});b.find(".size").on("mousedown",function(b){l.fadeOut(200)});l.find("a:first").click(function(){a("px")});l.find("a:last").click(function(){a("%")})},penWidth:function(){for(var a=$("#menuPanel .penWidth"),b=a.data("ARR"),c=0;c<b.length;c++){var d=$("<div></div>").data("penWidth",b[c]).click(function(){var b=$(this).data("penWidth");h.setPenWidth(b);h.hideMenu()}).html("<b style='height: "+
b[c]+"px;'></b><span>"+b[c]+"px</span>");a.append(d)}},font:function(){},"crop-bar":function(){function a(b){(47>b.keyCode||58<b.keyCode)&&b.preventDefault()}var b=$("#annotation_bar .crop-bar"),c=b.find(".crop-width"),d=b.find(".crop-height");c.on("keypress",a).on("input",function(){var b=Number(c.val());0>=b?b=1:b>Number(c.attr("max"))&&(b=Number(c.attr("max")));var a=Number(d.val());f.setCropSize(b,a)});d.on("keypress",a).on("input",function(){var b=Number(d.val());0>=b?b=1:b>Number(d.attr("max"))&&
(b=Number(d.attr("max")));var a=Number(c.val());f.setCropSize(a,b)})}},l={font:function(){$("#menuPanel .font-list").data("font",f.style.font_name)},size:function(){var a=$("#menuPanel"),b=a.find(".width"),a=a.find(".height"),c,d,e,n,k,l;l=f.bg_info;"px"===h.RESIZE_UNIT?(e=c=1,d=2*l.width,n=2*l.height,k=l.width,l=l.height):(d=n=200,c=e=1,k=l=100);b.attr({min:c,max:d}).val(k).data("pre-value",l);a.attr({min:e,max:n}).val(l).data("pre-value",l)}},h=a.CTRL;$.extend(h,{GALLERY_TITLE_FILTER:"",RESIZE_UNIT:"px",
resetResizeUnit:function(){l.size()},readLastSetting:function(){d.getLastLocalValue(["last_color","last_opactiy","last_fontname","last_fontsize","last_penwidth"],function(a){var b=a.last_opacity?a.last_opacity:1,c=a.last_fontname?a.last_fontname:n[0],d=a.last_fontsize?a.last_fontsize:20,e=a.last_penwidth?a.last_penwidth:6;h._set_color(a.last_color?a.last_color:"#f00");h._set_opacity(b);h._set_fontname(c);h._set_fontsize(d);h._set_penwidth(e);a=$("#menuPanel .font .font-list");a.data("init-font-size",
d);"yes"===a.data("init")&&$("#menuPanel .font input").val(d)})},resetToolbar:function(){h.setShape("curve");h.reset_list()},editor_style_callback:function(a,b){var c=$("#tool-panel");switch(a){case "scale":c.find(".btn-zoom span").text("number"===typeof b?Math.floor(100*b)+"%":b);break;case "undo":c.find(".btn-undo")[b?"removeClass":"addClass"]("disable");break;case "redo":c.find(".btn-redo")[b?"removeClass":"addClass"]("disable");break;case "del":c.find(".btn-del")[b?"removeClass":"addClass"]("disable");
break;case "crop":"done"!==b&&(c.find(".crop-width").attr({min:1,max:b.max_width}).val(b.width),c.find(".crop-height").attr({min:1,max:b.max_height}).val(b.height));break;case "btn":var d=c.find(".btn-pen-width"),e=c.find(".btn-font"),c=c.find(".btn-list-reset");"text"===b||"callout"===b?(e.show(),d.hide(),c.hide()):"list"===b?(e.hide(),d.hide(),c.show()):(d.show(),e.hide(),c.hide());break;case "clear":c.find(".btn-clear")[b?"addClass":"removeClass"]("disable");break;case "mousedown":h.hideMenu();
break;default:console.log("todo..")}},del:function(){f.deleteSelected()},zoom:function(a){var b=$("#tool-panel .btn-zoom");"yes"!==b.data("init")&&(q.scale(),b.data("init","yes"));h.setScale(a.attr("val"))},_set_penwidth:function(a){var b=$("#annotation_bar");b.find(".btn-pen-width b").css("height",a);b.find(".btn-pen-width span").text(a+"px");f.setPenWidth(a)},setPenWidth:function(a){this._set_penwidth(a);d.setPref("last_penwidth",a)},shape:function(a){h.setShape(a.attr("shape"))},_set_shape:function(a){f.setPenType(a)},
reset_list:function(){f.reset_list()},resetList:function(){f.resetList()},setShape:function(a){h._set_shape(a);$("#annotation_bar").find("a[shape]").each(function(){var b=$(this),c=b.parent(".btn-group");0<c.length&&(b=c);b.attr("shape")===a?b.addClass("selected"):b.removeClass("selected")});h.editor_style_callback("btn",a)},setSize:function(a,b){f.setImageSize(a,b)},setScale:function(a){var b=f.getScale(),c=Math.floor(100*b)+"%",b=$("#menuPanel .scale").data("ARR"),c=b.indexOf(c);if("small"===a){if(c--,
0>=c)return}else"big"===a?c++:c=b.indexOf(a);0>c||c>=b.length||($("#tool-panel .btn-zoom span").text(0===c?"fit":b[c]),0===c?f.setFitScale():(b=parseInt(b[c])/100,f.setScale(b)))},menu:function(a,b){var c=$("#menuPanel"),d;d=0<a.parent(".btn-group").length?a.parent(".btn-group"):a;var e=a.attr("type"),f=c.find("."+e).attr("pos").split(","),n=Number(f[0]),f=Number(f[1]),k=d.offset();d.addClass("selected");var v=Math.round(k.left+d.outerWidth()/2-(n+2)/2),k=Math.round(k.top+d.innerHeight()+2);c.find(".part").hide();
"function"===typeof q[e]&&"yes"!==d.data("init")&&(q[e](),d.data("init","yes"));if("function"===typeof l[e])l[e]();"yes"===c.attr("is_show")?(h._rs(c.data("tiger-element")),c.animate({left:v,top:k,width:n,height:f},80),c.find("."+e).fadeIn(300)):(c.find("."+e).show(),c.css({left:v,top:k,width:n,height:f}).show().fadeIn(200),c.attr("is_show","yes"));c.data("tiger-element",a);b.originalEvent.diigo_no_hide=!0},_rs:function(a){if(a){var b=a;0<a.parent(".btn-group").length&&(b=a.parent(".btn-group"));
b.attr("shape")&&Diigo.Doodle.Type[b.attr("shape").toUpperCase()]===f.style.brush_type||b.removeClass("selected")}},hideMenu:function(){var a=$("#menuPanel");a.attr("is_show","no").fadeOut(200);h._rs(a.data("tiger-element"));a.data("tiger-element",null);f.instance.hideListDialog()},_set_color:function(a){$("#annotation_bar").find("a.btn-color i").css("background",a);f.setPenColor(a)},setColor:function(a){this._set_color(a);d.setPref("last_color",a)},_set_opacity:function(a){$("#opacityValue").text(Math.round(100*
a)+"%");$("#opacitySlider").css("background","-webkit-gradient(linear, 0% 0%, 100% 0%, color-stop("+a+", #39abed), color-stop("+a+", #d3d3d3))");f.setPenOpacity(a)},setOpacity:function(a){this._set_opacity(a);d.setPref("last_opacity",a)},crop:function(d){d=d.attr("val");var b=$("#annotation_bar .crop-bar");"yes"!==b.data("init")&&(q["crop-bar"](),b.data("init","yes"));"done"===d?f.finishCutImage(!0):"begin"===d?f.cutImage():f.finishCutImage(!1);a.APP_MODE="begin"===d?"clip":"editor"},_set_fontname:function(a){$("#annotation_bar .btn-font .font-name").text(a);
f.setFontName(a)},setFontName:function(a){this._set_fontname(a);d.setPref("last_fontname",a)},_set_fontsize:function(a){$("#annotation_bar .btn-font .font-size").text(a+"px");f.setFontSize(a)},setFontSize:function(a){this._set_fontsize(a);d.setPref("last_fontsize",a)},save:function(){a.CTRL.finishEdit()},cancel:function(){a.CTRL.cancelEdit()},undo:function(){f.undo()},redo:function(){f.redo()},clear:function(){f.clear()},do_title_filter:function(){var d=a.CTRL.GALLERY_TITLE_FILTER;$(".image-gallery .image-container").each(function(){var a=
$(this),c=a.data("diigo-image"),e=a.data("hidden")?!0:!1;0<=c.title.indexOf(d)?e&&(a.data("hidden",!1).css({display:"block"}),a.addClass("pop-in")):e||(a.data("hidden",!0),a.addClass("pop-out"))})},search:function(){function d(){a.CTRL.do_title_filter();c=null}var b=$("#search-txt"),c=null;b.data("init")||(b.on("input",function(){var e=b.val().trim();a.CTRL.GALLERY_TITLE_FILTER=e;null!==c&&(clearTimeout(c),c=null);c=setTimeout(d,150)}).on("blur",function(){""===b.val().trim()&&b.val("").animate({width:0},
200,function(){b.css("display","none");b.data("shown",!1)}).parent().removeClass("active")}),b.data("init",!0));b.data("shown")||(b.css({width:0,display:"inline"}).animate({width:parseInt(b.css("maxWidth"))},200,function(){b.focus()}).parent().addClass("active"),b.data("shown",!0))}})}]);app.controller("MainCtrl",["$scope","$rootScope","CaptureService","DiigoImage","StorageService","$timeout",function(e,a,f,d,k,n){function q(){var b=(new Date).getTime(),c=0,d=[],e=[];k.getAllImageInfo(function(a){d.push(a);c=(new Date).getTime();200<=c-b&&(l(d),b=(new Date).getTime(),d.length=0)},function(){0<d.length&&(l(d),d.length=0);0<e.length&&k.delImageArray(e);a.CTRL.readLastSetting();$.log("load saved image finish")},function(a){e.push(a)})}function l(b){for(var c=0;c<b.length;c++)a.IMAGE_ARRAY.push(new d(b[c]));
a.$apply()}function h(a){e.main_window=chrome.app.window.current();0>=a?(e.main_window.hide(),n(function(){e.afterDelay()},50)):chrome.app.window.create("tick.html",{id:"AwesomeScreeshotTick",frame:"none",alwaysOnTop:!0,resizable:!1,bounds:{left:50,top:50,width:100,height:100},hidden:!0,minHeight:0,minWidth:0,transparentBackground:!0},function(c){c.contentWindow.onload=function(){c.contentWindow.callFromMainWindow_startTick(e.main_window,c,a)}})}function g(a){"number"!==typeof a||(0>a||99<a)||f.getStream(function(c){0===
c&&h(a)})}jQuery.extend(a.CTRL,{getImageByFileName:function(b){for(var c=0;c<a.IMAGE_ARRAY.length;c++)if(a.IMAGE_ARRAY[c].fileName===b)return a.IMAGE_ARRAY[c];return null},pickImage:function(a){g(Number(a))},editImage:function(b){a.CUR_IMAGE=a.CTRL.getImageByFileName(b);a.CTRL.initEditor()},delete_image:function(b,c){k.deleteImageFile(b,function(){for(var d=a.IMAGE_ARRAY,e=0;e<d.length;e++)if(d[e].fileName===b){d.splice(e,1);break}c&&c()},function(){a.CTRL.noty_error("delete image failed. please reload this app.")})},
deleteImage:function(b){a.CTRL.delete_image(b,function(){a.CTRL.noty_success("delete success",400);a.$apply()})},onStorageReady:function(){chrome.app.window||n(function(){for(var b=(new Date).getTime()+100,c=0;3>c;c++)a.IMAGE_ARRAY.push(new d({fileName:b+"-"+c+".png",url:"screenshots/"+(c%9+1)+".png",title:"test-"+c,time:b--}));a.CUR_IMAGE=a.IMAGE_ARRAY[0];n(function(){a.CTRL.shareImage(a.CUR_IMAGE.fileName)},1E3)},10);k.hasError()?a.CTRL.noty_error("current version does not support file system"):
q()}});e.afterDelay=function(){f.pickImage(function(b,c){if(0===b){for(var d=(new Date).getTime(),g=d+"-",f="",h=0;10>h;h++)f+=String.fromCharCode(Math.floor(26*Math.random()+97));a.CTRL.saveImageFile(c,g+f+".png","capture image",d)}else 999===b?a.CTRL.noty_warning("user cancel capture.",500):a.CTRL.noty_error("failed to capture image. please reload this app.");e.main_window.show()})}}]);
function callFromTickWindow_finishTick(e){e.close();$scope=angular.element($("#main_ctrl")).scope();window.setTimeout(function(){$scope.afterDelay();$scope.$apply()},50)};app.controller("EditCtrl",["$scope","$rootScope","DiigoEditor","StorageService",function(e,a,f,d){function k(d){a.CTRL.goSharePage(d);a.$apply()}jQuery.extend(a.CTRL,{initEditor:function(){var d=a.CUR_IMAGE.image;null===d?a.CTRL.noty_warning("please wait for this image to load...",500):(e.pre_scroll_top=$(".main").scrollTop(),a.CTRL.resetToolbar(),f.setImage(d,a.AUTO_FIT_SCREEN),a.APP_MODE="editor")},editImageAgain:function(){f.instance.d_changed=!0;a.APP_MODE="editor"},finishEdit:function(){a.CTRL.hideMenu();
if(f.isChanged()){if(!chrome.app.window){k(!0);return}f.instance.saveOrigin(function(){d.updateImageFile(a.CUR_IMAGE,f.getImageDataBlob(),function(){k(!0);f.instance.restoreOrigin()})})}else k(!1);a.CUR_IMAGE.first_load=!1},cancelEdit:function(){a.CTRL.hideMenu();a.CUR_IMAGE.first_load?(a.CTRL.delete_image(a.CUR_IMAGE.fileName),a.APP_MODE="upload"):a.APP_MODE="gallery"}})}]);app.controller("UploadCtrl",["$scope","$rootScope","StorageService","DiigoImage",function(e,a,f,d){function k(e,k){f.getImageUrl(e,function(e){e?(k.url=e,k.need_edit=!0,k.first_load=!0,e=new d(k),a.IMAGE_ARRAY.push(e),a.$apply()):a.CTRL.noty_error("failed to get image info. please reload this app.")})}e.show=function(){a.APP_MODE="gallery"};e.capture=function(){a.CTRL.pickImage(0)};jQuery.extend(a.CTRL,{saveImageEntry:function(d,e,l,h){var g={fileName:e,title:l,time:h,url:""};f.saveImageEntry(d,g,
function(){k(e,g)},function(){a.CTRL.noty_error("failed to save image file to database. try again.",1E3)})},saveImageFile:function(d,e,l,h){var g={fileName:e,title:l,time:h};f.saveImageFile(d,g,function(){k(e,g)},function(){a.CTRL.noty_error("failed to save image file to database. try again.",1E3)})},launchByExtension:function(a,d){for(var e=(new Date).getTime(),f=e+"-",g="",b=0;10>b;b++)g+=String.fromCharCode(Math.floor(26*Math.random()+97));f=f+g+".png";g=Diigo.$.dataUrl2Blob(a);this.saveImageFile(g,
f,d,e)}});chrome.runtime.onMessage.addListener(function(d,e,f){d.dataUrl&&a.CTRL.launchByExtension(d.dataUrl,d.title)});window.onload=function(){window.t_dataUrl&&a.CTRL.launchByExtension(window.t_dataUrl,window.t_title)}}]);app.controller("ShareCtrl",["$scope","$rootScope","DiigoEditor","StorageService","ServerService",function(e,a,f,d,k){function n(){a.APP_MODE="share";m.diigo_uploaded=!1;m.google_uploaded=!1;m.connecting=!1;m.is_private="false";m.uploading=!1;$("#copy-area img").data("init","no");var b=a.CUR_IMAGE.url,c=$("#share-image").hide();c[0].src="";c[0].onload=q;c[0].src=b;setTimeout(l,1);setTimeout(function(){e.state.inSteps&&e.back(!0);e.state.temp_uploaded=!1;e.state.diigo_uploaded=!1},1)}function q(){var a=
$("#share-left-panel"),b=a.find(".image-container"),c=$("#share-image"),d=b.width(),a=parseInt(a.css("minHeight")),e=c[0].naturalHeight,f=c[0].naturalWidth,g=e;f>d&&(g=Math.floor(e*d/f));a>g+10?b.css("top",Math.floor((a-10-g)/2)):b.css("top",0);c.show()}function l(){var a=$(document.body).width(),b=$("#tool-panel").width();$("#share-right-panel").css("right",Math.floor(Math.max(0,a-b)/2)+20)}function h(){e.state.image_data_url&&$("#share-image").attr("src")===a.CUR_IMAGE.image||(e.state.image_data_url=
Diigo.$.image2url(a.CUR_IMAGE.image));return e.state.image_data_url}function g(){function b(){var c=$("#copy-area")[0],d=window.getSelection(),e=document.createRange();e.selectNodeContents(c);d.removeAllRanges();d.addRange(e);c.focus();document.execCommand("copy");a.CTRL.noty_success("copy success.",400)}var c=$("#copy-area img");"yes"!==c.data("init")?(c[0].onload=function(){c.data("init","yes");b()},c[0].src=h()):b()}function b(a,b,c,d){var f=$("#share-panel-out"),g=f.width(),h=f.find(a),k=f.find(b);
a=k.css("left","right"===c?g:-g).removeClass("ng-hide").outerHeight(!0);d?(f.css({height:a}),(k.hasClass("diigo-panel")||h.hasClass("diigo-panel"))&&u("right"===c),h.css({left:"right"===c?-g:g}),h.addClass("ng-hide"),k.css({left:0})):(f.animate({height:a},150,function(){(k.hasClass("diigo-panel")||h.hasClass("diigo-panel"))&&u("right"===c)}),h.animate({left:"right"===c?-g:g},200,function(){h.addClass("ng-hide")}),k.animate({left:0},200));e.state.inSteps="right"===c}function c(a,b){var c=$("#share-panel-out"),
d=c.find("."+m.process+"-panel"),e=d.find(a),f=d.find(b);e.addClass("ng-hide");f.css("opacity",0).removeClass("ng-hide");d=d.outerHeight(!0);c.animate({height:d},100);f.animate({opacity:1},300)}function u(a){var b=$("#share-content"),c=b.find(".local-part"),b=b.find(".about-part");a?(c.addClass("ng-hide"),b.css("opacity",0).removeClass("ng-hide").animate({opacity:1},250)):(b.addClass("ng-hide"),c.css("opacity",0).removeClass("ng-hide").animate({opacity:1},250))}function r(b,c){"false"===m.is_private&&
b.find(".social, .email").find("a").each(function(){var b=$(this);b.hasClass("weibo")?b[0].href+="&url="+encodeURIComponent(c)+"&appkey=4237332164&title=&pic=&ralateUid=":b.hasClass("twitter")?b[0].href="http://twitter.com/share?url="+encodeURIComponent(c)+"&via=awe_screenshot&text="+a.CUR_IMAGE.title:b[0].href+=c});b.find("input").val(c)}function t(a){m.uploading=!1;m.temp_uploaded=!0;e.$apply();a&&(r($(".temp-panel"),a.url),c(".save",".share"))}function s(){var b=k.getUser();if(b){var c=b.info.username,
b=b.permission,d=$(".diigo-panel .save");d.find(".username").attr("href","https://www.diigo.com/user/"+c+"?type=image").text(c);m.exceeded=!(b.is_premium||b.image);d.find(".title input").val(a.CUR_IMAGE.title)}}function x(){var b=k.getUser();if(b&&(b.permission.is_premium||b.permission.image)){b=$(".diigo-panel .save");m.uploading=!0;var d=a.CUR_IMAGE.title;k.uploadImageToDiigo({image_url:h(),tags:b.find(".tags input").val().trim(),mode:"false"!=m.is_private,title:b.find(".title input").val().trim()||
d,src_title:d},function(b,d){m.uploading=!1;0===b?(r($(".diigo-panel .share"),d.url),m.diigo_uploaded=!0,c(".save",".share")):1===b&&(a.CTRL.noty_error("net work error, please login again.",3E3),k.clear(),m.diigo_login=!1,c(".save",".login"));e.$apply()})}}function v(){var b=$(".diigo-panel"),d=b.find(".uname input"),f=b.find(".pwd input"),g=d.val().trim(),h=f.val(),n=$(".signin .err").addClass("ng-hide");$("#share-panel-out").height(b.outerHeight(!0));""===g?(a.CTRL.noty_warning("username must not be empty.",
800),d.focus()):""===h?(a.CTRL.noty_warning("password must not be empty.",800),f.focus()):(m.uploading=!0,k.loginIntoDiigoByUP(g,h,function(a){0===a?(m.diigo_login=!0,s(),c(".login",".save")):1===a&&(m.diigo_login=!1,n.removeClass("ng-hide"),$("#share-panel-out").height(b.outerHeight(!0)));m.uploading=!1;e.$apply()}))}function w(){m.connecting=!0;k.loginIntoGoogleByToken(function(a,b){m.connecting=!1;0===a&&(m.google_login=!0,y(),c(".login",".save"));e.$apply()})}function z(){chrome.app.window.create("connect.html",
{id:"as_connect_to_google",bounds:{width:800,height:600}});chrome.runtime.onMessage.addListener(function(a,b,d){"finish"===a.name&&k.connectGoogleToDiigo(a.data,function(a){0===a?(m.diigo_login=!0,s(),c(".login",".save")):1===a&&(m.diigo_login=!1,$er.removeClass("ng-hide"),$("#share-panel-out").height($dp.outerHeight(!0)));m.uploading=!1;e.$apply()})})}function y(){var b=$(".google-panel");b.find(".title input").val(a.CUR_IMAGE.title);b.find(".info .email").text(k.getGoogleAccount().email)}d.getPref("promotion").then(function(a){e.ifPromote=
"undefined"===typeof a.promotion?!0:a.promotion});e.removePromotion=function(){d.setPref("promotion",!1).then(function(){e.ifPromote=!1})};jQuery.extend(a.CTRL,{goSharePage:function(a){e.re_edit=a?!0:!1;n()},shareImage:function(b){a.CUR_IMAGE=a.CTRL.getImageByFileName(b);e.re_edit=!1;n()},copyShareImage:function(){g()}});jQuery(window).on("resize",function(){"share"===a.APP_MODE&&l()});e.gallery=function(){m.uploading?a.CTRL.noty_warning("please wait for uploading...",1E3):a.APP_MODE="gallery"};e.save=
function(){d.saveImageToDisk(a.CUR_IMAGE,function(b){b&&a.CTRL.noty_success("save image to "+b+" success.")},function(){a.CTRL.noty_error("save image failed. please reload this app.")})};e.print=function(){var b=$("#print")[0],c=b.contentDocument,d=b.contentWindow,b=c.getElementById("image");c.title=a.CUR_IMAGE.title;b.onload=function(){this.style.width=718<this.width?"100%":"auto";d.focus();d.print()};b.setAttribute("src",a.CUR_IMAGE.url)};e.copy=function(){g()};e.edit=function(){m.uploading?a.CTRL.noty_warning("please wait for uploading...",
1E3):e.re_edit?a.CTRL.editImageAgain():a.CTRL.editImage(a.CUR_IMAGE.fileName)};e.state={image_data_url:null,process:"",uploading:!1,exceeded:!1,is_private:"false",connecting:!1,temp_uploaded:!1,diigo_uploaded:!1,google_uploaded:!1,diigo_login:!1,google_login:!1,inSteps:!1};var m=e.state;jQuery.extend(e,{back:function(c){m.uploading?a.CTRL.noty_warning("please wait for uploading...",1E3):(b("."+m.process+"-panel",".op","left",c),m.process="",c&&e.$digest())},temp:function(){m.process="temp";m.is_private=
"false";var a=$("#share-panel-out"),c=a.find(".temp-panel .save"),a=a.find(".temp-panel .share");m.temp_uploaded?(c.addClass("ng-hide"),a.removeClass("ng-hide")):(a.addClass("ng-hide"),c.removeClass("ng-hide"));b(".op",".temp-panel","right")},temp_save:function(){m.uploading||(m.uploading=!0,k.uploadImageToAS(h(),a.CUR_IMAGE.title,t))},diigo:function(){m.process="diigo";m.is_private="false";m.diigo_uploaded||(m.diigo_login=null!==k.getUser());var a=$("#share-panel-out"),c=a.find(".diigo-panel .login"),
d=a.find(".diigo-panel .save"),a=a.find(".diigo-panel .share");m.diigo_uploaded?(d.addClass("ng-hide"),c.addClass("ng-hide"),a.removeClass("ng-hide")):m.diigo_login?(s(),c.addClass("ng-hide"),a.addClass("ng-hide"),d.removeClass("ng-hide")):(c.removeClass("ng-hide"),a.addClass("ng-hide"),d.addClass("ng-hide"));b(".op",".diigo-panel","right")},InputKeyDownHandler:function(a){13===a.keyCode&&this.diigo_signin()},diigo_signin:function(){m.uploading||v()},diigo_signout:function(){k.clearUser();m.diigo_login=
!1;c(".save",".login")},diigo_connect:function(){m.connecting||z()},diigo_save:function(){m.uploading||m.exceeded||x()},google:function(){m.process="google";m.is_private="false";m.google_uploaded||(m.google_login=null!==k.getGoogleAccount().token);var a=$("#share-panel-out"),c=a.find(".google-panel .login"),d=a.find(".google-panel .save"),a=a.find(".google-panel .share");m.google_uploaded?(d.addClass("ng-hide"),c.addClass("ng-hide"),a.removeClass("ng-hide")):m.google_login?(y(),c.addClass("ng-hide"),
a.addClass("ng-hide"),d.removeClass("ng-hide")):(c.removeClass("ng-hide"),a.addClass("ng-hide"),d.addClass("ng-hide"));b(".op",".google-panel","right")},google_login:function(){m.connecting||w()},google_save:function(){function b(){a.CTRL.noty_error("network error, failed to upload image to google drive. try again.",2E3);e.$apply()}m.uploading||(m.uploading=!0,d.getImageFileBlob(a.CUR_IMAGE.fileName,function(d){k.uploadImageToGDrive(d,a.CUR_IMAGE,"false"==m.is_private,function(d,f){m.uploading=!1;
0===d||999===d?(999===d&&(m.is_private="true",a.CTRL.noty_warning("image upload success, but failed to make it public.",2E3)),r($(".google-panel .share"),f.alternateLink),c(".save",".share"),e.$apply()):b()})},function(){m.uploading=!1;b()}))}})}]);app.controller("SettingCtrl",["$scope","$rootScope","StorageService",function(e,a,f){e.auto_fit_screen=!0;a.AUTO_FIT_SCREEN=!0;jQuery.extend(a.CTRL,{showSetting:function(){a.toggleSetting=!0;e.show=!0}});e.autoFitChange=function(){a.AUTO_FIT_SCREEN="true"===e.auto_fit_screen;f.setPref("auto_fit_screen",e.auto_fit_screen)};e.formatOnChange=function(){a.EXPORT_FORMAT=e.format;f.setPref("export_format",e.format)};e.close=function(){a.toggleSetting=!1;e.show=!1};f.getPref("export_format").then(function(d){e.format=
"undefined"===typeof d.export_format?a.EXPORT_FORMAT="PNG":a.EXPORT_FORMAT=d.export_format});f.getPref("auto_fit_screen").then(function(d){e.auto_fit_screen="undefined"===typeof d.auto_fit_screen?"true":d.auto_fit_screen;a.AUTO_FIT_SCREEN="true"===e.auto_fit_screen})}]);app.directive("diigoAnnotationBar",["$rootScope",function(e){return{replace:!0,templateUrl:"js/toolbar/annotation_bar.html",link:function(a,f){f.on("mousedown","a[ctrl]",function(a){var f=$(this);if(f&&0!==f.length){var n=f.attr("ctrl");n&&("function"===typeof e.CTRL[n]&&!f.hasClass("disable"))&&(e.CTRL[n](f,a),a.originalEvent.diigo_no_hide||e.CTRL.hideMenu(),e.$apply(),a.stopPropagation(),a.preventDefault())}})}}}]);app.directive("diigoMenuPanel",["$rootScope","$document",function(e,a){return{replace:!0,templateUrl:"js/toolbar/menu_panel.html",link:function(f,d){d.on("mousedown",function(a){a.originalEvent.diigo_no_hide=!0});a.on("mousedown",function(a){"editor"!==e.APP_MODE||a.originalEvent.diigo_no_hide||e.CTRL.hideMenu()});d.find(".scale").data("ARR","fit screen;25%;50%;75%;100%;150%;200%".split(";"));d.find(".colorPanel").data("ARR","#60f #09f #06c #ff0 #f60 #c0f #966 #999 #00f #0ff #9f3 #fc0 #f00 #933 #000 #fff".split(" "));
d.find(".shape").data("ARR",["rect","ellipse"]);d.find(".arrow").data("ARR",["line_arrow","bezier_arrow","line"]);d.find(".annotation").data("ARR","smile cry tick-off cross forbidden warning q-mark like heart star chicken dog rain sun cloud thunder fish fish2 tree1 tree2 building1 building2 package tent umbrella car basketball beer".split(" "));d.find(".annotation").data("TYPE","part part part full full full full part part part part part part part part part part part part part part part part part part part part part".split(" "));
d.find(".penWidth").data("ARR",[2,4,6,8,16])}}}]);app.directive("diigoUpload",["$rootScope",function(e){function a(){noty({text:"please choose an image file.",layout:"topCenter",type:"warning",timeout:500})}function f(){for(var a="",d=0;10>d;d++)a+=String.fromCharCode(Math.floor(26*Math.random()+97));return a}function d(d,k){var l=d.name.toLowerCase().match(/(.*)\.(png|jpg|jpeg|gif|bmp)$/);if(null===l)a();else{var h=l[1],l=l[2],g=(new Date).getTime(),b=g+"-"+f()+"."+l;"gif"===l?(l=new FileReader,l.onload=function(a){a=a.target.result;var d=new Image;
d.src=a;d.onload=function(){var a=Diigo.$,c=a._getHelperImageCanvas(),f=a.__IMAGE_CTX__;c.width=d.naturalWidth;c.height=d.naturalHeight;f.drawImage(d,0,0);a=a.getCanvasBlob(c);e.CTRL.saveImageFile(a,b,h,g)}},l.readAsDataURL(d)):k?e.CTRL.saveImageEntry(k,b,h,g):e.CTRL.saveImageFile(d,b,h,g)}}function k(e){e.stopPropagation();e.preventDefault();var f=e.originalEvent.target.files[0];f&&/image\/.*/.test(f.type)?(d(f),e.originalEvent.target.value=""):a()}return{replace:!0,templateUrl:"js/upload/upload.html",
link:function(n,q){n.ctrlKey=Diigo.$.macOS?"command":"ctrl";var l=q.find(".upload-zone");l.on("dragover",function(a){a.stopPropagation();a.preventDefault();a.originalEvent.dataTransfer.dropEffect="move";l.hasClass("hover")||l.addClass("hover")});l.on("dragleave",function(a){a.stopPropagation();a.preventDefault();l.removeClass("hover")});l.on("drop",function(e){e.stopPropagation();e.preventDefault();e=e.originalEvent.dataTransfer;0<e.files.length&&0<e.items.length&&"file"===e.items[0].kind?d(e.files[0],
e.items[0].webkitGetAsEntry()):a();l.removeClass("hover")});l.find(".upload-file").change(k);$(document.body).on("dragover",function(a){a.stopPropagation();a.preventDefault();a.originalEvent.dataTransfer.dropEffect="none"});$(document).on("paste",function(a){if("upload"===e.APP_MODE){var d=a.originalEvent.clipboardData.items;a=null;for(var b=0;b<d.length;b++)if(/image/.test(d[b].type)){a=d[b];break}null!==a&&(b=a.type.substring(a.type.indexOf("/")+1),d=(new Date).getTime(),b=d+"-"+f()+"."+b,(a=a.getAsFile())&&
e.CTRL.saveImageFile(a,b,"pasted_image",d))}})}}}]);app.directive("diigoEditor",["$rootScope","DiigoEditor",function(e,a){return{restrict:"A",templateUrl:"js/edit/editor.html",replace:!0,link:function(f,d){var k=$(d).find("#diigo-doodle-canvas"),n=$(d).find("#diigo-layer-canvas"),q=$(d),l=$(d).find("#diigo-editor-container"),h=$(d).find("#diigo-textarea"),g=$(d).find("#diigo-textarea-out"),b=$(d).find("#diigo-list-dialog");a.createEditor({doodle_canvas:k,layer_canvas:n,container:l,out_container:q,textarea:h,textarea_out:g,list_dialog:b},function(a,
b){e.CTRL.editor_style_callback(a,b)});$(document.body).on("keydown",function(b){if("editor"===e.APP_MODE){b=b.originalEvent;var d="";if(b.ctrlKey||b.metaKey)d+="ctrl-";d+=b.keyCode;switch(d){case "8":case "46":a.isTextActived()||b.diigo_no_keydown||(a.deleteSelected(),b.preventDefault());break;case "ctrl-90":a.undo();b.preventDefault();break;case "ctrl-89":a.redo();b.preventDefault();break;case "ctrl-187":e.CTRL.setScale("big");b.preventDefault();break;case "ctrl-189":e.CTRL.setScale("small");b.preventDefault();
break;case "ctrl-48":e.CTRL.setScale("100%"),b.preventDefault()}}})}}}]);app.directive("diigoRepeat",["$rootScope","StorageService",function(e,a){return function(f,d){d.data("diigo-image",f.image);d.on("webkitAnimationEnd",function(){var a=$(this),d=a.data("hidden");a.removeClass("pop-in");a.removeClass("pop-out");a.css("display",d?"none":"block")});d.find(".info span").on("click",function(){$(this).parent().find(".txt").show().focus()});d.find(".info .txt").on("blur",function(){var d=$(this).hide().val().trim();if(""!==d){var f=$(this).parents(".image-container").data("diigo-image");
d!==f.title&&(f.title=d,a.update_db_info(f.clone(),null,null),e.$apply())}});d.find(".main-image").on("load",function(){var a=this.naturalWidth,d=this.naturalHeight,f=0,l=0,h=0,g=0;190>=a||145>=d?(f=Math.floor((190-a)/2),l=Math.floor((145-d)/2),h=a,g=d):(f=a/190,h=d/145,f>h?(h=Math.floor(a/h),g=145,l=0,f=Math.floor((190-h)/2)):(h=190,g=Math.floor(d/f),f=0,l=Math.floor((145-g)/2)));$(this).css({left:f,top:l,width:h,height:g}).show();a=$(this).parents(".image-container").data("diigo-image");a.image=
this;a.need_edit&&(e.CTRL.editImage(a.fileName),e.$apply(),a.need_edit=!1)})}}]);app.directive("diigoGallery",["$rootScope",function(e){return{restrict:"A",templateUrl:"js/gallery/gallery.html",replace:!0}}]);app.directive("diigoSharePanel",function(){return{restrict:"A",templateUrl:"js/share/share_panel.html",replace:!0}});app.directive("diigoShare",["$rootScope",function(e){return{restrict:"A",templateUrl:"js/share/share.html",replace:!0,link:function(a,f){f.on("focus","input",function(){var a=this;setTimeout(function(){a.select()},10)});$(document.body).on("keydown",function(a){"share"===e.APP_MODE&&((a.ctrlKey||a.metaKey)&&67===a.keyCode&&"text"!==a.target.type)&&(e.CTRL.copyShareImage(),a.preventDefault(),a.stopPropagation())})}}}]);app.directive("diigoSetting",function(){return{restrict:"A",templateUrl:"js/setting/setting.html",replace:!0}});app.directive("adjustTip",function(){return{restrict:"A",link:function(e,a,f){var d=a.find("span");a.on("mouseenter",function(){"true"!==d.attr("data-adjuested")&&d.css("left",(a.outerWidth()-d.outerWidth())/2+"px").attr("data-adjusted","true")})}}});
