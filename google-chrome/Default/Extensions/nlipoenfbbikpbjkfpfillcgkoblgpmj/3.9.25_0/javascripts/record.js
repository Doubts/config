function resetData(){dataArray=new ArrayBuffer(0),audioArray=new ArrayBuffer(0)}function getPremium(){return new Promise(function(a){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(b){a(b&&"1"==b.value?!0:!1)})})}function refreshCookie(){$.get(baseUrl+"/promotion_ex")}function goToUpgrade(){var a="https://www.awesomescreenshot.com";chrome.cookies.get({url:a,name:"screenshot_personal_type"},function(b){if(b){if("0"==b.value)var c="/premium/upgrade"}else var c="/user/login?type=record_screen";chrome.tabs.create({url:a+c})})}function getMic(a){window.navigator.webkitGetUserMedia({audio:{optional:[{echoCancellation:!1}]}},function(b){a(b)},function(){})}function getStream(a){return new Promise(function(b,c){if("tab"==a)chrome.tabCapture.capture({video:!0,videoConstraints:{mandatory:{maxWidth:2560,maxHeight:1440}}},function(a){b(a)});else if("desktop"==a){var d=["screen","window"];"Mac OS"==getOS()&&d.push("audio"),chrome.desktopCapture.chooseDesktopMedia(d,function(a){if(a){var d={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(d,b,c)}})}})}function setBadge(a,b){"text"===a?chrome.browserAction.setBadgeText({text:b}):"color"===a&&chrome.browserAction.setBadgeBackgroundColor({color:b})}function beginRecord(a){a.isRecordMic&&getMic(function(a){audioStream=a}),getStream(a.recordType).then(function(b){if(setBadge("color","red"),a.countdown>0)var c=parseInt(a.countdown),d=setInterval(function(){setBadge("text",c+""),0==c&&(clearInterval(d),setBadge("text","REC"),gotStream(b)),c--},1e3);else gotStream(b)}).catch(function(a){console.log("[ERROE]: ",a)})}function captureTabUsingTabCapture(){getMic(function(a){audioStream=a});({audio:!0,video:!0,videoConstraints:{mandatory:{chromeMediaSource:"tab",maxWidth:screen.width,maxHeight:screen.height,minFrameRate:30,maxFrameRate:64,minAspectRatio:1.77,googLeakyBucket:!0,googTemporalLayeredScreencast:!0}}});chrome.desktopCapture.chooseDesktopMedia(["screen","window","audio"],function(a){function b(a){gotStream(a)}if(a){var c={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(c,b,function(){})}})}function canvasRecord(a){function b(){console.log("sdfsd"),e.drawImage(c,0,0,c.clientWidth,c.clientHeight),window.recorder&&recorder.stopped||requestAnimationFrame(b)}var c=document.getElementById("desktop-video");c.src=URL.createObjectURL(a),c.play();var d=document.getElementById("tempCanvas"),e=d.getContext("2d");recorder=RecordRTC(d,{type:"canvas"}),console.log(recorder),a.onended=function(){recorder&&(a.onended=function(){}),document.getElementById("awesome").postMessage({command:"stop"}),audioStream&&audioStream.stop(),recorder.stopped=!0,recorder.stopRecording(function(){var a=recorder.getBlob();console.log(a)})},a.getVideoTracks()[0].onended=function(){recorder&&a.onended()},console.log("sdf"),b(),recorder.startRecording()}function handleMessage(a){console.log("[NACL]: ",a.data.name,a.data.message),"videodata"==a.data.name?appendVideoData(a.data.data):"videoend"==a.data.name&&fileSaver.save(new Blob([dataArray],{type:"video/webm"}),"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm").then(function(a){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?srcUrl="+a+"&name=record.webm"})})}).catch(function(a){console.log(a)})}function appendVideoData(a){var b=new Uint8Array(dataArray.byteLength+a.byteLength);b.set(new Uint8Array(dataArray),0),b.set(new Uint8Array(a),dataArray.byteLength),dataArray=b.buffer,console.log("video: "+a.byteLength)}function gotStream2(a){resetData(),track=a.getVideoTracks()[0];var b=$("video")[0];if(b.src=URL.createObjectURL(a),b.muted=!0,b.play(),console.log(b),audioStream){d=audioStream.getAudioTracks()[0];var c=d.getConstraints()}else{var d=null;c={}}var e=$("profileList"),f=e.length<1?"vp8":e.options[e.selectedIndex].value,g={};console.log({command:"start",track:track,profile:f,filename:file_name,channelCount:c.channelCount?c.channelCount:2,audioSampleRate:c.sampleRate?c.sampleRate:48e3,sampleSize:c.sampleSize?c.sampleSize:16,frameRate:g.frameRate?g.frameRate:25,width:g.width?g.width:2560,height:g.height?g.height:1440}),document.getElementById("awesome").postMessage({command:"start",track:track,profile:f,filename:file_name,width:g.width?g.width:screen.width,height:g.height?g.height:screen.height}),startDate=new Date,intervalID=setInterval(function(){var a=new Date-startDate;$("length").innerHTML="Time interval: "+a},100),a.getVideoTracks()[0].onended=function(){document.getElementById("awesome").postMessage({command:"stop"})}}function gotStream(a){var b={type:"video",disableLogs:!1,recorderType:MediaStreamRecorder},c="vp8";if(c&&"Default"!==c&&(b.mimeType="video/webm; codecs="+c.toLowerCase()),audioStream&&audioStream.getAudioTracks&&audioStream.getAudioTracks().length){audioPlayer=document.createElement("audio"),audioPlayer.src=URL.createObjectURL(audioStream),audioPlayer.muted=!0,audioPlayer.play(),context=new AudioContext;var d=context.createGain();d.connect(context.destination),d.gain.value=0,mediaStremSource=context.createMediaStreamSource(audioStream),mediaStremSource.connect(d),mediaStremDestination=context.createMediaStreamDestination(),mediaStremSource.connect(mediaStremDestination),a.addTrack(mediaStremDestination.stream.getAudioTracks()[0])}recorder=RecordRTC(a,b);try{recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}recorder.stream=a,isRecording=!0,recorder.stream.onended=function(){recorder&&recorder.stream&&(recorder.stream.onended=function(){}),audioStream&&audioStream.stop(),cameraStream&&cameraStream.stop(),stopScreenRecording()},recorder.stream.getVideoTracks()[0].onended=function(){recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()},recordingStartTime=(new Date).getTime(),recordingTimer=setInterval(updateRecordingTime,100)}function checkTimeLength(a){a>=31e3&&getPremium().then(function(a){a||stopStream()})}function updateRecordingTime(){if(!isRecordingPaused){var a=(new Date).getTime(),b=a-recordingStartTime;pausedTime&&(b-=pausedTime),checkTimeLength(b),recordingTime=secondsToTime(b),setBadge("text",recordingTime)}}function secondsToTime(a){a=Math.floor(a/1e3);var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=a%60;return 10>d&&(d="0"+d),(b>0?b+":":"")+c+":"+d}function setDefaults(){recorder&&recorder.stream&&(recorder.stream.stop(),recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()),recorder=null,isRecording=!1,recordingStartTime=null,recordingTime=null,imgIndex=0}function pauseScreenRecording(){recorder.pauseRecording(),isRecordingPaused=!0,lastPausingTime=(new Date).getTime()}function resumeScreenRecording(){recorder.resumeRecording(),isRecordingPaused=!1,pausedTime=pausedTime+(new Date).getTime()-lastPausingTime}function stopStream(){isRecordingPaused&&resumeScreenRecording(),recorder&&recorder.stream&&recorder.stream.onended()}function restoreRecording(){isRecording=!1,clearInterval(recordingTimer),recordingTimer=null,lastPausingTime=null,pausedTime=null,setBadge("text","")}function stopScreenRecording(){restoreRecording(),recorder.stopRecording(function(){saveVideo(),googleEvent("record video","record video");try{peer.close(),peer=null}catch(a){}try{audioPlayer.src=null,mediaStremDestination.disconnect(),mediaStremSource.disconnect(),context.disconnect(),context=null}catch(a){}}),timer&&clearTimeout(timer)}function getFileSize(a){var b=(a/1024).toFixed(2);return 1024>b?b=b.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" KB":(b=(b/1024).toFixed(2),b=b.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" MB"),b}function saveVideo(){var a="AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-"),b=(new File([recorder.getBlob()],a+".webm",{type:"video/webm"}),recorder.getBlob()),c=bytesToSize(b.size);fileSaver.save(b,a+".webm").then(function(b){DB.save({fileUrl:b,title:a,size:c,duration:recordingTime}).then(function(a){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?id="+a})}),setDefaults()})})}function googleEvent(a,b){ga&&ga("send","event","chrome extension",a,b)}function getOS(){var a=(window.navigator.userAgent,window.navigator.platform),b=["Macintosh","MacIntel","MacPPC","Mac68K"],c=["Win32","Win64","Windows","WinCE"],d=null;return-1!==b.indexOf(a)?d="Mac OS":-1!==c.indexOf(a)?d="Windows":!d&&/Linux/.test(a)&&(d="Linux"),d}var getMicFrame=null,audioStream=null,cameraStream=null,tempVideo=null;const MIME_TYPE="video/webm",file_name="/awesome/record.webm";var isRecording=!1,isRecordingPaused=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,isPremium=!1,recordingStartTime=null,baseUrl="https://www.awesomescreenshot.com";chrome.cookies.get({url:baseUrl,name:"screenshot_personal_type"},function(a){"undefined"==typeof a&&refreshCookie()}),$(document).ready(function(){}),DB.init(),window.addEventListener("message",function(a){"audioStream"==a.data.type&&(audioStream=a.data.steam)},!1),chrome.commands.onCommand.addListener(function(a){console.log("Command:",a),"stop-recording"===a?stopStream():"pause-or-resume-recording"===a&&(isRecordingPaused?resumeScreenRecording():pauseScreenRecording())});