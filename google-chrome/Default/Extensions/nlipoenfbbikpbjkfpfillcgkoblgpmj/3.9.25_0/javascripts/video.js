function updateProgress(a,b){console.log(b),$("#"+a+"-upload").find(".progress-bar-inner").show().css("width",b+"%")}function updateYoutubeProgress(a){return updateProgress("youtube",a)}function updateGDriveProgress(a){return updateProgress("gDrive",a)}function buildYoutubeUrl(a){return"https://youtu.be/"+a}function beginUpload(a){var b=$("#"+a+"-upload");b.addClass("uploading").find(".progress-bar").show()}function afterUpload(a,b,c){var d=$("#"+a+"-upload");d.removeClass("uploading").addClass("uploaded"),d.find(".progress-bar").hide().find(".progress-bar-inner").css("width",0),d.find(".url-area").show().find("input").val(b),c||(currentRecord.detail[a+"Url"]=b,DB.update(id,currentRecord))}function init(){$("#uploadToYoutube").on("click",function(){var a=$("#video").attr("src");chrome.permissions.request({permissions:["identity"]},function(b){b&&getFile(a).then(function(a){return beginUpload("youtube"),file||(file=new File([a],"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm",{type:"video/webm"})),uploadVideo.uploadToYoutube(file,updateYoutubeProgress)}).then(function(a){console.log(a),afterUpload("youtube",buildYoutubeUrl(a.id))}).catch(function(a){console.log(a)})})}),$("#uploadToGdrive").on("click",function(){var a=$("#video").attr("src");chrome.permissions.request({permissions:["identity"]},function(b){b&&getFile(a).then(function(a){return beginUpload("gDrive"),file||(file=new File([a],"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm",{type:"video/webm"})),uploadVideo.uploadToGoogleDrive(file,updateGDriveProgress)}).then(function(a){console.log(a),afterUpload("gDrive",a.alternateLink)}).catch(function(a){console.log(a)})})}),$("#delete-record").on("click",function(){var a=confirm("Are you sure to delete this recording?");a&&DB.delete(id).then(function(){window.close()})}),document.getElementById("video").addEventListener("canplay",function(){makeThumbnail()}),$("#manage-record").on("click",function(){window.location.href="/video-list.html"}),$("#download-record, .download-btn").on("click",function(){chrome.permissions.request({permissions:["downloads"]},function(a){if(a){var b=currentRecord.fileUrl,c={url:b,filename:currentRecord.detail.title+".webm",saveAs:!0};chrome.downloads.download(c)}})}),$("#display-text").on("click",function(){var a=$("#video-title");a.addClass("editing"),a.find("input").css("width",a.width()-200).focus()}),$("#video-title").find("input").on("blur",function(){var a=$("#display-text").find(".text").text().trim(),b=$(this).val().trim();return""==b.replace(" ","")?void alert("Title can not be empty!"):($("#video-title").removeClass("editing"),void(a!==b&&($("#display-text").find(".text").text(b),currentRecord.detail.title=b,DB.update(id,currentRecord))))}),$(".upload-item-detail").find("input").on("focus",function(){$(this).select(),document.execCommand("copy"),$(this).parents(".upload-item").find(".copy-tip").fadeIn("fast").delay(1e3).fadeOut("fast")}),DB.init().then(function(){DB.get(id).then(function(a){currentRecord=a,buildRecord(a)})}),Bg.getPremium().then(function(a){a&&$(".tip").hide()}),$("#upgrade-btn").on("click",function(){Bg.googleEvent("upgrade from video page","upgrade"),Bg.goToUpgrade()})}function buildRecord(a){var b=a.detail;$("#video").attr("src",a.fileUrl),document.title=b.title,$(".video-title").find("input").val(b.title),$("#display-text").find(".text").text(b.title),$("#info-time").text(formatDate(new Date(b.timeStamp))),$("#info-duration").text(b.duration),$("#info-size").text(b.size),b.youtubeUrl&&afterUpload("youtube",b.youtubeUrl,!0),b.gDriveUrl&&afterUpload("gDrive",b.gDriveUrl,!0)}function makeThumbnail(){var a=document.createElement("canvas");a.width=320,a.height=180;var b=a.getContext("2d"),c=document.getElementById("video");b.drawImage(c,0,0,a.width,a.height);var d=a.toDataURL(),e=d.split(",")[1],f=d.split(",")[0].split(":")[1].split(";")[0],g=b64toBlob(e,f);fileSaver.save(g,currentRecord.id+"_thumbnail.png").then(function(a){currentRecord.detail.thumbnailUrl=a,DB.update(id,currentRecord)})}function formatDate(a){var b=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"],c=a.getDate(),d=a.getMonth(),e=a.getFullYear();return b[d]+" "+c+", "+e}function b64toBlob(a,b,c){function d(a){return a.charCodeAt(0)}b=b||"",c=c||1024;for(var e=atob(a),f=[],g=0;g<e.length;g+=c){var h=e.slice(g,g+c),i=Array.prototype.map.call(h,d),j=new Uint8Array(i);f.push(j)}var k=new Blob(f,{type:b});return k}function getFile(a){return new Promise(function(b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="blob",c.onload=function(){if(200==this.status){var a=this.response;b(a)}},c.send()})}function isShareLinkReady(){setTimeout(function(){var a=$.get(urlBase+name,function(b){b.code?(a.abort(),isShareLinkReady()):($("#share").removeClass("disabled"),$("#share-input").find("input").val(urlBase+name))})},1e3)}var url=window.location.href,id=parseInt(url.match(/\?id=(.*)/)[1]),Bg=chrome.extension.getBackgroundPage(),youtube_prefix="ba9b_",google_prefix="c822_",urlBase="https://preview.diigo.com/api/v3/awe/video/",currentRecord=null,file=null;localStorage.temp_camera_url&&(document.getElementById("video2").style.display="block",document.getElementById("video2").setAttribute("src",localStorage.temp_camera_url)),$("#share").on("click",function(){$(this).hasClass("disabled")||$("#share-input").show()}),init();